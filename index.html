<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>盲玩樂-線上抽獎中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main-red: #ff3e3e; --neon-gold: #f1c40f; --bg-dark: #0a0a0a; }
        body { font-family: sans-serif; background: var(--bg-dark); color: #fff; text-align: center; margin: 0; padding-top: 60px; overflow-x: hidden; }
        
        .user-bar { position: fixed; top: 0; width: 100%; background: #111; padding: 12px 0; border-bottom: 2px solid var(--main-red); z-index: 1000; font-weight: bold; }
        
        .pool-tabs { display: flex; justify-content: center; gap: 6px; padding: 10px; }
        .tab-btn { flex: 1; padding: 12px 5px; background: #333; border: 1px solid #555; color: #aaa; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 14px; outline: none; }
        .tab-btn.active { background: var(--main-red); border-color: var(--neon-gold); color: white; box-shadow: 0 0 10px rgba(255,62,62,0.5); }
        
        .display-window { width: 90%; max-width: 360px; margin: 15px auto; border: 2px solid #333; height: 230px; background: #111; position: relative; overflow: hidden; border-radius: 12px; display: flex; align-items: center; justify-content: center; }
        .prize-img { width: 100%; height: 100%; object-fit: contain; position: absolute; top: 0; left: 0; display: none; }
        .prize-img.active { display: block !important; }

        .info-bar { color: var(--neon-gold); font-size: 16px; margin: 10px 0; font-weight: bold; min-height: 24px; }
        .draw-btn { width: 260px; height: 65px; background: linear-gradient(180deg, #ff5e5e, var(--main-red)); color: #fff; margin: 15px auto; display: flex; align-items: center; justify-content: center; border-radius: 40px; font-weight: bold; font-size: 24px; cursor: pointer; box-shadow: 0 4px 15px rgba(255,62,62,0.4); border: none; }
        .draw-btn:active { transform: scale(0.95); }

        .win-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; }
        .win-img { width: 300px; height: 300px; border: 4px solid var(--neon-gold); border-radius: 20px; background: #222; object-fit: contain; }
    </style>
</head>
<body>
    <div class="user-bar">點數餘額：<span id="display-pts">載入中</span> P</div>
    
    <div class="pool-tabs">
        <button id="btn0" class="tab-btn active" onclick="physicalSwitch(0)">單挑套</button>
        <button id="btn1" class="tab-btn" onclick="physicalSwitch(1)">Ａ區任選</button>
        <button id="btn2" class="tab-btn" onclick="physicalSwitch(2)">Ｂ區任選</button>
    </div>

    <div class="display-window">
        <img id="img0" class="prize-img active" src="https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480">
        <img id="img1" class="prize-img" src="https://i.meee.com.tw/d2cFJiy.jpg">
        <img id="img2" class="prize-img" src="https://i.meee.com.tw/B8xVcyj.jpg">
    </div>

    <div id="stock-display" class="info-bar">正在取得獎池資訊...</div>
    <div class="draw-btn" onclick="goDraw()">點擊開獎</div>

    <div id="winPanel" class="win-overlay">
        <p style="color:white; font-size: 18px; margin-bottom: 5px;">恭喜獲得</p>
        <h1 id="win-grade" style="font-size: 100px; color: var(--neon-gold); margin: 0; font-weight: 900;"></h1>
        <img id="win-img" class="win-img" src="">
        <p id="win-name" style="margin: 20px; font-size: 18px; font-weight: bold;"></p>
        <button onclick="location.reload()" style="padding: 15px 80px; font-size: 18px; background: #fff; color: #000; border: none; border-radius: 50px; font-weight: bold;">確認領取</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const POOLS = ["單挑套", "Ａ區任選", "Ｂ區任選"];
        const B_IMG_URL = "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg";
        
        let currentIdx = 0;
        let myUid = "";
        let stockData = {};

        function physicalSwitch(idx) {
            currentIdx = idx;
            // 切換按鈕與圖片顯示
            for(let i=0; i<3; i++) {
                const btn = document.getElementById('btn'+i);
                const img = document.getElementById('img'+i);
                if(btn) btn.className = (i === idx) ? 'tab-btn active' : 'tab-btn';
                if(img) img.style.display = (i === idx) ? 'block' : 'none';
            }
            // 更新同步庫存文字
            if (stockData[POOLS[idx]]) {
                const s = stockData[POOLS[idx]];
                document.getElementById('stock-display').innerText = `A賞：${s.a} | B賞：${s.b} | 剩餘：${s.total}`;
            }
        }

        window.switchTo = physicalSwitch;

        async function initLIFF() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                myUid = profile.userId;
                
                // 向後台請求數據
                const s1 = document.createElement('script');
                s1.src = `${API_URL}?action=getPoolStatus&callback=cb_st`;
                const s2 = document.createElement('script');
                s2.src = `${API_URL}?action=checkUser&uid=${myUid}&name=${encodeURIComponent(profile.displayName)}&callback=cb_pt`;
                document.body.appendChild(s1); document.body.appendChild(s2);
            } catch (e) {
                document.getElementById('stock-display').innerText = "系統連線中，請稍候...";
            }
        }

        window.cb_st = (res) => { stockData = res; physicalSwitch(currentIdx); };
        window.cb_pt = (res) => { document.getElementById('display-pts').innerText = res.points; };

        function goDraw() {
            if(!myUid) { alert("請先登入 LINE"); return; }
            const s = document.createElement('script');
            s.src = `${API_URL}?action=draw&uid=${myUid}&poolId=${encodeURIComponent(POOLS[currentIdx])}&callback=cb_res`;
            document.body.appendChild(s);
        }

        window.cb_res = (res) => {
            if (res.status === "success") {
                document.getElementById('win-grade').innerText = res.grade;
                document.getElementById('win-name').innerText = res.name;
                // 中 A 就抓預覽窗顯示的 A 賞大圖
                document.getElementById('win-img').src = (res.grade === "A" ? document.getElementById('img'+currentIdx).src : B_IMG_URL);
                document.getElementById('winPanel').style.display = 'flex';
            } else { 
                alert("點數不足或該獎池已抽完！"); 
                location.reload(); 
            }
        }
        window.onload = initLIFF;
    </script>
</body>
</html>
