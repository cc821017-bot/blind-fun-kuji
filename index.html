<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚æŠ½çå¹«æ‰‹ - æ——è‰¦ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root {
            --bg-dark: #121212;
            --card-bg: #1e1e2e;
            --primary: #ff4757;
            --secondary: #ffa502;
            --text-main: #ffffff;
            --text-dim: #a4b0be;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 15px;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* ç”¨æˆ¶è³‡è¨Šå€ */
        .header-card {
            background: linear-gradient(135deg, #2f3542, #1e1e2e);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-name { font-size: 1.1rem; font-weight: bold; color: var(--secondary); }
        .user-points { font-size: 1.2rem; font-weight: 800; color: #2ed573; }

        /* æ¨¡å¼åˆ‡æ› */
        .tab-container {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            background: #2f3542;
            color: var(--text-dim);
            font-weight: bold;
            transition: 0.3s;
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: 0 0 10px rgba(255, 71, 87, 0.5);
        }

        /* æŠ½çæ ¼å­å€ */
        .prize-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 20px;
        }

        .prize-item {
            background: var(--card-bg);
            border: 2px solid #3f3f5a;
            border-radius: 10px;
            height: 75px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            transition: all 0.1s;
        }

        .prize-item.active {
            border-color: var(--secondary);
            background: #3f3f5a;
            box-shadow: 0 0 15px var(--secondary);
            transform: scale(1.05);
            z-index: 10;
        }

        .prize-item.sold-out {
            opacity: 0.3;
            filter: grayscale(1);
        }

        .prize-item.sold-out::after {
            content: "å®Œå”®";
            position: absolute;
            background: rgba(255,0,0,0.7);
            color: white;
            font-size: 10px;
            padding: 2px 5px;
            border-radius: 4px;
        }

        .prize-label { font-size: 11px; font-weight: bold; text-align: center; margin-top: 5px; }
        .prize-qty { font-size: 9px; color: var(--text-dim); }

        /* æŒ‰éˆ•å€ */
        .action-area {
            position: sticky;
            bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .main-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
        }

        .btn-single { background: linear-gradient(45deg, #57606f, #2f3542); }
        .btn-multi { background: linear-gradient(45deg, #ff4757, #ff6b81); }

        .main-btn:disabled {
            background: #747d8c !important;
            opacity: 0.6;
            transform: scale(0.98);
        }

        .cost-info {
            text-align: center;
            font-size: 0.9rem;
            color: var(--secondary);
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="header-card animate__animated animate__fadeIn">
    <div>
        <div style="font-size: 0.8rem; color: var(--text-dim);">PLAYER</div>
        <div class="user-name" id="disp-name">è®€å–ä¸­...</div>
    </div>
    <div style="text-align: right;">
        <div style="font-size: 0.8rem; color: var(--text-dim);">POINTS</div>
        <div class="user-points" id="disp-points">0</div>
    </div>
</div>

<div class="tab-container">
    <button class="tab-btn active" onclick="changeMode('å–®æŒ‘å¥—')">å–®æŒ‘å¥—</button>
    <button class="tab-btn" onclick="changeMode('Aå€')">Aå€</button>
    <button class="tab-btn" onclick="changeMode('Bå€')">Bå€</button>
</div>

<div class="prize-grid" id="grid-box">
    </div>

<div class="action-area">
    <div class="cost-info">æœ¬æ¬¡æ¶ˆè€—ï¼š<span id="cost-val">0</span> P</div>
    <button id="btn-1" class="main-btn btn-single" onclick="handleDraw(1)">å–®æŠ½ä¸€æ¬¡</button>
    <button id="btn-5" class="main-btn btn-multi" onclick="handleDraw(5)">äº”é€£æŠ½ (çˆ½å¿«æ„Ÿæå‡)</button>
</div>

<script>
    // --- é…ç½®å€ ---
    const CONFIG = {
        GAS_URL: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec",
        LIFF_ID: "YOUR_LIFF_ID" // è«‹æ›¿æ›
    };

    let state = {
        uid: "",
        name: "",
        points: 0,
        mode: "å–®æŒ‘å¥—",
        prizes: [],
        cost: 0,
        isRunning: false
    };

    // --- åˆå§‹åŒ– ---
    async function init() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            state.uid = profile.userId;
            state.name = profile.displayName;
            document.getElementById('disp-name').innerText = state.name;
            await syncData();
        } catch (err) {
            console.error(err);
            // æ¸¬è©¦ç’°å¢ƒé é˜²å ±éŒ¯
            state.uid = "TEST_USER";
            state.name = "æ¸¬è©¦ç©å®¶";
            await syncData();
        }
    }

    // --- è³‡æ–™åŒæ­¥ ---
    async function syncData() {
        try {
            const res = await fetch(`${CONFIG.GAS_URL}?uid=${state.uid}&mode=${state.mode}`);
            const data = await res.json();
            if(data.status === "success") {
                state.points = data.userPoints;
                state.prizes = data.prizes;
                state.cost = data.cost;
                updateUI();
            }
        } catch (e) { console.error("åŒæ­¥å¤±æ•—", e); }
    }

    function updateUI() {
        document.getElementById('disp-points').innerText = state.points.toLocaleString();
        document.getElementById('cost-val').innerText = state.cost;
        const grid = document.getElementById('grid-box');
        grid.innerHTML = state.prizes.map((p, i) => `
            <div class="prize-item ${p.stock <= 0 ? 'sold-out' : ''}" id="prize-${i}">
                <div class="prize-label">${p.name}</div>
                <div class="prize-qty">å‰©:${p.stock}</div>
            </div>
        `).join('');
    }

    function changeMode(m) {
        if(state.isRunning) return;
        state.mode = m;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText === m));
        syncData();
    }

    // --- æŠ½çé‚è¼¯ ---
    async function handleDraw(count) {
        if(state.isRunning) return;
        const totalCost = state.cost * count;
        
        if(state.points < totalCost) {
            Swal.fire("é»æ•¸ä¸è¶³", "è¶•å¿«å»è¯ç¹«å°ç·¨å„²å€¼å§ï¼", "warning");
            return;
        }

        state.isRunning = true;
        setBtns(false);

        try {
            const res = await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    uid: state.uid,
                    mode: state.mode,
                    count: count
                })
            });
            const result = await res.json();

            if(result.status === "success") {
                // åŸ·è¡Œè·‘é¦¬ç‡ˆï¼Œå¸¶å…¥ç¬¬ä¸€å€‹çé …ä½œç‚ºåœé»
                playAnimation(result.results, result.remainingPoints);
            } else {
                throw new Error(result.message);
            }
        } catch (e) {
            Swal.fire("æŠ½çå¤±æ•—", e.message, "error");
            state.isRunning = false;
            setBtns(true);
        }
    }

    function playAnimation(results, newPoints) {
        let current = 0;
        let laps = 0;
        const speed = 60;
        const total = state.prizes.length;
        
        const timer = setInterval(() => {
            document.querySelectorAll('.prize-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`prize-${current}`).classList.add('active');
            
            current = (current + 1) % total;
            if(current === 0) laps++;

            // è·‘æ»¿ä¸‰åœˆå¾Œï¼Œå°‹æ‰¾ç¬¬ä¸€å€‹çµæœçš„ä¸­çä½ç½®åœæ­¢
            if(laps >= 3) {
                const targetIdx = state.prizes.findIndex(p => p.name === results[0]);
                if(current === targetIdx) {
                    clearInterval(timer);
                    setTimeout(() => showResult(results, newPoints), 500);
                }
            }
        }, speed);
    }

    function showResult(results, newPoints) {
        Swal.fire({
            title: 'ğŸŠ æ­å–œç²çï¼',
            html: `<div style="color: #ff4757; font-weight: bold; font-size: 1.2rem;">${results.join('<br>')}</div>`,
            icon: 'success',
            background: '#1e1e2e',
            color: '#fff',
            confirmButtonColor: '#ff4757'
        });
        
        state.points = newPoints;
        state.isRunning = false;
        setBtns(true);
        syncData(); // åˆ·æ–°åº«å­˜
    }

    function setBtns(enabled) {
        document.getElementById('btn-1').disabled = !enabled;
        document.getElementById('btn-5').disabled = !enabled;
    }

    window.onload = init;
</script>
</body>
</html>
