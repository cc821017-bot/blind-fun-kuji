<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚æŠ½çå°å¹«æ‰‹</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --primary-color: #ff4757; --gold-color: #ffa502; }
        body { font-family: 'PingFang TC', sans-serif; background: #1e1e2e; color: white; margin: 0; padding: 20px; overflow-x: hidden; }
        .header { text-align: center; margin-bottom: 20px; }
        .user-info { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; }
        
        /* å°ç‘ªè‰æ ¼å­ç›¤ */
        .grid-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .prize-box { background: #2f3542; border: 2px solid #57606f; border-radius: 8px; height: 80px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; transition: 0.2s; }
        .prize-box.active { border-color: var(--gold-color); box-shadow: 0 0 15px var(--gold-color); transform: scale(1.05); background: #57606f; }
        .prize-box.sold-out { opacity: 0.4; filter: grayscale(1); }
        .prize-box.sold-out::after { content: "SOLD OUT"; position: absolute; font-size: 10px; color: red; font-weight: bold; background: rgba(0,0,0,0.7); width: 100%; text-align: center; }
        .prize-name { font-size: 12px; text-align: center; padding: 2px; }
        .prize-stock { font-size: 10px; color: #a4b0be; }

        /* æ§åˆ¶å€ */
        .controls { display: flex; flex-direction: column; gap: 10px; }
        .mode-selector { display: flex; justify-content: space-between; gap: 5px; }
        .mode-btn { flex: 1; padding: 10px; border: none; border-radius: 5px; background: #57606f; color: white; cursor: pointer; }
        .mode-btn.active { background: var(--primary-color); }
        .draw-btn { padding: 15px; font-size: 18px; font-weight: bold; border-radius: 30px; border: none; background: linear-gradient(45deg, #ff4757, #ff6b81); color: white; box-shadow: 0 5px 15px rgba(255,71,87,0.4); cursor: pointer; }
        .draw-btn:disabled { background: #747d8c; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="header">
    <h2 class="animate__animated animate__fadeInDown">ç›²ç©æ¨‚æŠ½çå¹³å°</h2>
</div>

<div class="user-info">
    <span>ç©å®¶ï¼š<b id="userName">è®€å–ä¸­...</b></span>
    <span>é¤˜é¡ï¼š<b id="userPoints">0</b> P</span>
</div>

<div id="prizeGrid" class="grid-container">
    </div>

<div class="controls">
    <div class="mode-selector">
        <button class="mode-btn active" onclick="switchMode('å–®æŒ‘å¥—')">å–®æŒ‘å¥—</button>
        <button class="mode-btn" onclick="switchMode('Aå€')">Aå€</button>
        <button class="mode-btn" onclick="switchMode('Bå€')">Bå€</button>
    </div>
    <div style="text-align: center; color: var(--gold-color); font-weight: bold;">
        å–®æŠ½é‡‘é¡ï¼š<span id="currentCost">---</span> P
    </div>
    <button id="drawBtn1" class="draw-btn" onclick="startDraw(1)">å–®æŠ½ä¸€æ¬¡</button>
    <button id="drawBtn5" class="draw-btn" style="background: linear-gradient(45deg, #ffa502, #ff7f50);" onclick="startDraw(5)">äº”é€£æŠ½ (æ›´å„ªæƒ !)</button>
</div>

<script>
    const GAS_URL = "æ‚¨çš„_GAS_ç¶²é æ‡‰ç”¨ç¨‹å¼_URL";
    let currentUser = { uid: "", name: "", points: 0 };
    let currentMode = "å–®æŒ‘å¥—";
    let isDrawing = false;
    let prizes = [];

    // åˆå§‹åŒ– LIFF
    async function initLIFF() {
        try {
            await liff.init({ liffId: "æ‚¨çš„_LIFF_ID" });
            if (!liff.isLoggedIn()) {
                liff.login();
            } else {
                const profile = await liff.getProfile();
                currentUser.uid = profile.userId;
                currentUser.name = profile.displayName;
                document.getElementById('userName').innerText = currentUser.name;
                fetchData(); // åˆå§‹æŠ“å–è³‡æ–™
            }
        } catch (err) { console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err); }
    }

    // å¾ GAS æŠ“å–æœ€æ–°çæ± èˆ‡ç”¨æˆ¶è³‡æ–™
    async function fetchData() {
        try {
            const resp = await fetch(`${GAS_URL}?uid=${currentUser.uid}&mode=${currentMode}`);
            const data = await resp.json();
            currentUser.points = data.userPoints;
            prizes = data.prizes; // åŒ…å«çé …åã€å‰©é¤˜æ•¸é‡ã€ç­‰ç´š
            document.getElementById('userPoints').innerText = currentUser.points;
            document.getElementById('currentCost').innerText = data.cost;
            renderGrid();
        } catch (err) { console.error("æŠ“å–è³‡æ–™å¤±æ•—", err); }
    }

    function renderGrid() {
        const grid = document.getElementById('prizeGrid');
        grid.innerHTML = prizes.map((p, i) => `
            <div class="prize-box ${p.stock <= 0 ? 'sold-out' : ''}" id="box-${i}">
                <span class="prize-name">${p.name}</span>
                <span class="prize-stock">å‰©é¤˜:${p.stock}</span>
            </div>
        `).join('');
    }

    function switchMode(mode) {
        if (isDrawing) return;
        currentMode = mode;
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.innerText === mode);
        });
        fetchData();
    }

    async function startDraw(count) {
        if (isDrawing) return;
        
        // 1. åŸºæœ¬æª¢æŸ¥
        const cost = parseInt(document.getElementById('currentCost').innerText) * count;
        if (currentUser.points < cost) {
            Swal.fire("é»æ•¸ä¸è¶³", "è«‹è¯ç¹«å°ç·¨å„²å€¼å¾Œå†è©¦ï¼", "error");
            return;
        }

        isDrawing = true;
        toggleButtons(false);

        try {
            // 2. å‘å¾Œç«¯è«‹æ±‚æŠ½ççµæœ
            const response = await fetch(GAS_URL, {
                method: 'POST',
                body: JSON.stringify({
                    uid: currentUser.uid,
                    userName: currentUser.name,
                    mode: currentMode,
                    count: count
                })
            });
            const result = await response.json();

            if (result.status === "error") {
                Swal.fire("éŒ¯èª¤", result.message, "error");
                isDrawing = false;
                toggleButtons(true);
                return;
            }

            // 3. åŸ·è¡Œè·‘é¦¬ç‡ˆå‹•ç•« (å‚³å…¥çµæœé™£åˆ—èˆ‡æœ€çµ‚é¤˜é¡)
            runMarquee(result.results, result.remainingPoints);

        } catch (err) {
            Swal.fire("ç³»çµ±æ•…éšœ", "é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ï¼", "error");
            isDrawing = false;
            toggleButtons(true);
        }
    }

    function runMarquee(results, finalPoints) {
        let currentPos = 0;
        let speed = 50;
        let laps = 0;
        const totalPrizes = prizes.length;
        
        const interval = setInterval(() => {
            document.querySelectorAll('.prize-box').forEach(b => b.classList.remove('active'));
            document.getElementById(`box-${currentPos}`).classList.add('active');

            currentPos = (currentPos + 1) % totalPrizes;
            if (currentPos === 0) laps++;

            // å‹•æ…‹æ§åˆ¶å‹•ç•«çµæŸ (å‡è¨­å‹•ç•«è‡³å°‘è·‘ 3 åœˆ)
            if (laps > 3) {
                // æ‰¾åˆ°çµæœåœ¨æ•¸çµ„ä¸­çš„ index (ä»¥ç¬¬ä¸€å€‹çµæœç‚ºä¾‹å±•ç¤ºå‹•ç•«)
                const targetIdx = prizes.findIndex(p => p.name === results[0]);
                if (currentPos === targetIdx) {
                    clearInterval(interval);
                    finishDraw(results, finalPoints);
                }
            }
        }, speed);
    }

    function finishDraw(results, finalPoints) {
        Swal.fire({
            title: 'ğŸ‰ æ­å–œä¸­çï¼',
            html: `<div style="font-size: 20px; color: var(--primary-color);">${results.join('<br>')}</div>`,
            icon: 'success',
            confirmButtonText: 'æ”¶ä¸‹çé …'
        });

        currentUser.points = finalPoints;
        document.getElementById('userPoints').innerText = currentUser.points;
        isDrawing = false;
        toggleButtons(true);
        fetchData(); // é‡æ–°æ•´ç†åº«å­˜
    }

    function toggleButtons(enabled) {
        document.getElementById('drawBtn1').disabled = !enabled;
        document.getElementById('drawBtn5').disabled = !enabled;
    }

    window.onload = initLIFF;
</script>
</body>
</html>
