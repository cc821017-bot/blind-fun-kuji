<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚ 4.1.0 ç«¶å“å°æ¨™ç‰ˆ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&family=Oswald:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --red: #ff3e3e; --gold: #ffcc00; --cyan: #00f2ff; 
            --bg: #121212; --card: #1e1e1e; --dark-gray: #2c2c2c;
            --bar-bg: #333;
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: var(--bg); color: #fff; margin: 0; padding-bottom: 220px; 
            overflow-x: hidden; -webkit-tap-highlight-color: transparent;
        }
        
        /* è·‘é¦¬ç‡ˆ */
        .win-history { background: linear-gradient(90deg, #220000, #440000); border-bottom: 1px solid var(--red); padding: 8px 0; overflow: hidden; white-space: nowrap; }
        .win-track { display: inline-block; white-space: nowrap; padding-left: 100%; animation: scroll 35s linear infinite; }
        .win-item { display: inline-block; margin-right: 40px; color: var(--gold); font-size: 0.85rem; font-weight: bold; }
        @keyframes scroll { from { transform: translateX(0); } to { transform: translateX(-220%); } }
        
        /* é ­éƒ¨è³‡è¨Š */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: rgba(18, 18, 18, 0.95); position: sticky; top: 0; z-index: 900; border-bottom: 1px solid #333; backdrop-filter: blur(10px); }
        .user-info { display: flex; flex-direction: column; }
        .u-name { font-weight: bold; font-size: 0.9rem; color: #eee; }
        .u-status { font-size: 0.7rem; color: #4cd137; display: flex; align-items: center; gap: 5px; }
        .u-pts { font-family: 'Oswald'; color: var(--gold); font-size: 1.4rem; text-shadow: 0 0 10px rgba(255,204,0,0.3); }

        /* æ•¸æ“šå„€éŒ¶æ¿ */
        .stats-bar { display: flex; justify-content: space-between; background: var(--card); padding: 15px; margin: 15px; border-radius: 12px; border: 1px solid #333; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .stat-box { text-align: center; flex: 1; position: relative; }
        .stat-box:not(:last-child)::after { content: ''; position: absolute; right: 0; top: 10%; height: 80%; width: 1px; background: #444; }
        .stat-val { font-family: 'Oswald'; font-size: 1.4rem; color: #fff; display: block; }
        .stat-label { font-size: 0.7rem; color: #aaa; }
        
        /* åœ°ç„ç«æ¨¡å¼ */
        .critical-mode .stats-bar { border: 1px solid var(--red); box-shadow: 0 0 15px rgba(255, 62, 62, 0.4); animation: pulse-border 1.5s infinite; }
        .critical-mode #stat-rem { color: var(--red); font-size: 1.8rem; text-shadow: 0 0 10px var(--red); }
        @keyframes pulse-border { 0% { box-shadow: 0 0 5px var(--red); } 50% { box-shadow: 0 0 20px var(--red); } 100% { box-shadow: 0 0 5px var(--red); } }

        /* çé …é€²åº¦æ¢å¡ç‰‡ (ç«¶å“å°æ¨™å„ªåŒ–) */
        .prize-gallery { display: flex; overflow-x: auto; padding: 0 15px 15px 15px; gap: 10px; scrollbar-width: none; }
        .p-card { flex: 0 0 90px; background: var(--card); border-radius: 8px; padding: 8px; text-align: center; border: 1px solid #333; position: relative; transition: 0.2s; }
        .p-card:active { transform: scale(0.95); }
        .p-card img { width: 100%; aspect-ratio: 1/1; object-fit: contain; background: #fff; border-radius: 4px; margin-bottom: 5px; }
        .p-name { font-size: 0.7rem; font-weight: bold; color: #ccc; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .p-bar-bg { width: 100%; height: 4px; background: #444; border-radius: 2px; overflow: hidden; margin-top: 4px; }
        .p-bar-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.5s; }
        .p-stock { font-size: 0.65rem; color: #888; margin-top: 2px; }
        .p-card.sold-out { opacity: 0.5; filter: grayscale(1); }
        .p-card.sold-out::after { content: 'SOLD'; position: absolute; top: 30%; left: 50%; transform: translate(-50%, -50%) rotate(-15deg); color: var(--red); font-weight: 900; border: 2px solid var(--red); padding: 2px 5px; font-size: 0.9rem; }

        /* ç±¤ç›¤å€åŸŸ */
        .tabs { display: flex; padding: 0 15px 10px; gap: 10px; }
        .tab { flex: 1; text-align: center; padding: 10px; background: var(--dark-gray); border-radius: 8px; color: #888; font-weight: bold; font-size: 0.9rem; cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .tab.active { background: #333; color: #fff; border-color: var(--cyan); box-shadow: 0 0 10px rgba(0, 242, 255, 0.2); }

        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; padding: 0 15px 20px; }
        .ticket { aspect-ratio: 1/1; background: var(--card); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 900; color: #555; border: 1px solid #333; transition: 0.1s; position: relative; }
        .ticket.selected { background: var(--gold); color: #000; border-color: #fff; transform: translateY(-3px); box-shadow: 0 5px 15px rgba(255, 204, 0, 0.4); z-index: 2; }
        .ticket.taken { background: #0a0a0a; opacity: 0.3; pointer-events: none; }
        .ticket.taken::after { content: ''; position: absolute; width: 80%; height: 2px; background: #555; transform: rotate(45deg); }
        .ticket.taken::before { content: ''; position: absolute; width: 80%; height: 2px; background: #555; transform: rotate(-45deg); }
        
        /* å¤§çè¢«æŠ½èµ°çš„ç‰¹æ®Šæ¨£å¼ */
        .ticket.big-taken { background: #2a1a00; border: 1px solid var(--gold); opacity: 0.6; }
        .ticket.big-taken::after, .ticket.big-taken::before { background: var(--gold); }

        /* åº•éƒ¨æ“ä½œå€ (ä»¿ç«¶å“ä½ˆå±€) */
        .action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #1a1a1a; padding: 15px 20px 30px; border-top: 1px solid #333; display: flex; flex-direction: column; gap: 12px; z-index: 1000; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .quick-actions { display: flex; gap: 10px; justify-content: center; }
        .btn-quick { flex: 1; background: #333; border: 1px solid #555; color: #ccc; padding: 8px; border-radius: 6px; font-size: 0.85rem; font-weight: bold; cursor: pointer; }
        .btn-quick:active { background: #444; }
        
        .main-actions { display: flex; gap: 15px; align-items: center; }
        .cart-info { flex: 1; }
        .cart-count { font-size: 0.8rem; color: #aaa; }
        .cart-total { font-size: 1.4rem; color: var(--gold); font-family: 'Oswald'; }
        
        .btn-pay { flex: 1.5; background: linear-gradient(45deg, #ff3e3e, #c0392b); color: #fff; border: none; padding: 12px; border-radius: 8px; font-weight: 900; font-size: 1.1rem; box-shadow: 0 4px 15px rgba(255, 62, 62, 0.4); transition: 0.2s; }
        .btn-pay:disabled { background: #444; color: #888; box-shadow: none; }
        .btn-pay:active { transform: scale(0.97); }

        /* ç‡ˆç®±èˆ‡å½ˆçª— */
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
        #lightbox img { max-width: 90%; max-height: 70%; border-radius: 10px; box-shadow: 0 0 30px rgba(255,255,255,0.1); }
        #lightbox .lb-close { margin-top: 20px; color: #fff; border: 1px solid #fff; padding: 8px 20px; border-radius: 20px; cursor: pointer; }

        .result-container { max-height: 55vh; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 5px; }
        .res-card { background: #252525; padding: 10px; border-radius: 10px; display: flex; align-items: center; gap: 10px; border: 1px solid #444; }
        .res-card img { width: 60px; height: 60px; object-fit: contain; background: #fff; border-radius: 5px; }
        .res-card.big { border: 1px solid var(--gold); background: linear-gradient(45deg, #2c2000, #1a1a1a); }
        .res-card.lo { border: 1px solid #ff00cc; background: linear-gradient(45deg, #2c0022, #1a1a1a); }
        
        #loader { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--gold); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>

<body>
    <audio id="snd-select" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a"></audio>
    <audio id="snd-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.m4a"></audio>

    <div id="loader">
        <div class="spinner"></div>
        <p style="margin-top:15px; color:#888; font-size:0.8rem;">SYNCING DATA...</p>
    </div>

    <div id="lightbox" onclick="this.style.display='none'">
        <img id="lb-img" src="">
        <div class="lb-close">é—œé–‰é è¦½</div>
    </div>

    <div class="header">
        <div class="user-info">
            <div class="u-name" id="u-name">Guest</div>
            <div class="u-status">
                <span style="width:8px; height:8px; background:#4cd137; border-radius:50%; display:inline-block;"></span>
                <span id="online-count">12</span> äººæ­£åœ¨é€›
            </div>
        </div>
        <div class="u-pts" id="u-pts">0</div>
    </div>

    <div class="win-history"><div class="win-track" id="win-track">ç³»çµ±é€£ç·šä¸­...</div></div>

    <div class="stats-bar">
        <div class="last-one-alert" id="lo-alert">LAST ONE è­¦æˆ’</div>
        <div class="stat-box">
            <span class="stat-val" id="stat-rem">0</span>
            <span class="stat-label">å‰©é¤˜æšæ•¸</span>
        </div>
        <div class="stat-box">
            <span class="stat-val" id="stat-big" style="color:var(--gold)">0</span>
            <span class="stat-label">å¤§çå­˜é‡</span>
        </div>
        <div class="stat-box">
            <span class="stat-val" id="stat-rate">0%</span>
            <span class="stat-label">ä¸­çæ©Ÿç‡</span>
        </div>
    </div>

    <div class="tabs">
        <div class="tab active" onclick="changeMode('å–®æŒ‘å¥—')" data-mode="å–®æŒ‘å¥—">å–®æŒ‘å¥—</div>
        <div class="tab" onclick="changeMode('Aå€')" data-mode="Aå€">Aå€</div>
        <div class="tab" onclick="changeMode('Bå€')" data-mode="Bå€">Bå€</div>
    </div>

    <div id="prize-gallery" class="prize-gallery"></div>

    <div id="main-grid" class="grid"></div>

    <div class="action-bar">
        <div class="quick-actions">
            <button class="btn-quick" onclick="randomPick(1)">ğŸ² éš¨æ©Ÿ 1 æŠ½</button>
            <button class="btn-quick" onclick="randomPick(5)">ğŸ² éš¨æ©Ÿ 5 æŠ½</button>
            <button class="btn-quick" onclick="randomPick(10)">ğŸ² éš¨æ©Ÿ 10 æŠ½</button>
        </div>
        
        <div class="main-actions">
            <div class="cart-info">
                <div class="cart-count">å·²é¸ <span id="sel-count">0</span> å¼µ</div>
                <div class="cart-total" id="total-cost">0</div>
            </div>
            <button class="btn-pay" id="drawBtn" onclick="handleCheckout()">ç¢ºèªæ”¯ä»˜</button>
        </div>
    </div>

<script>
    // âš ï¸ è«‹å‹™å¿…æ›æˆæ‚¨æœ€æ–°çš„ GAS ç¶²å€ âš ï¸
    const CONFIG = { 
        GAS_URL: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec", 
        LIFF_ID: "2009072982-6smlV2gu" 
    };
    
    let state = { uid: "guest", name: "Guest", mode: "å–®æŒ‘å¥—", tickets: [], cost: 100, points: 0, selected: [] };

    // æ¨¡æ“¬ç·šä¸Šäººæ•¸ (ç‡Ÿé€ ç†±åº¦)
    setInterval(() => {
        const base = 12;
        const variation = Math.floor(Math.random() * 5) - 2;
        document.getElementById('online-count').innerText = base + variation;
    }, 5000);

    async function init() {
        try { 
            await liff.init({ liffId: CONFIG.LIFF_ID }); 
            if (liff.isLoggedIn()) {
                const p = await liff.getProfile(); 
                state.uid = p.userId; state.name = p.displayName;
                document.getElementById('u-name').innerText = p.displayName; 
            }
            await sync();
        } catch (e) { await sync(); }
    }

    async function sync() {
        state.selected = []; updateUI(); document.getElementById('loader').style.display = 'flex';
        try {
            const res = await fetch(`${CONFIG.GAS_URL}?uid=${state.uid}&name=${encodeURIComponent(state.name)}&mode=${encodeURIComponent(state.mode)}&t=${Date.now()}`);
            const data = await res.json();
            
            if(data.status === "success") {
                state.tickets = data.tickets; state.cost = data.cost || 100; state.points = data.userPoints;
                
                // æ›´æ–°æ•¸æ“š
                const rem = state.tickets.filter(t => !t.isTaken).length;
                const big = state.tickets.filter(t => !t.isTaken && /Aè³|SP|1è³|å¤§ç/i.test(t.prizeName)).length;
                
                document.getElementById('u-pts').innerText = state.points.toLocaleString();
                document.getElementById('stat-rem').innerText = rem;
                document.getElementById('stat-big').innerText = big;
                document.getElementById('stat-rate').innerText = rem > 0 ? (big/rem*100).toFixed(1) + "%" : "0%";
                
                // åœ°ç„ç«
                const isCritical = (rem <= 10 && rem > 0);
                document.body.classList.toggle('critical-mode', isCritical);
                document.getElementById('lo-alert').style.display = isCritical ? 'block' : 'none';
                
                // è·‘é¦¬ç‡ˆ
                document.getElementById('win-track').innerHTML = data.history.length > 0 ? 
                    data.history.map(h => `<span class="win-item">ğŸ‰ ${h.user} æŠ½å‡ºã€${h.prize}ã€‘</span>`).join('') : "å¤§çåœ¨åº«ï¼Œç­‰ä½ ä¾†æŠ½ï¼";

                // æŒ‰éˆ•ç‹€æ…‹
                const db = document.getElementById('drawBtn');
                db.disabled = (!data.bigPrizeExists || rem === 0);
                db.innerText = db.disabled ? "è£œè²¨ä¸­" : "ç¢ºèªæ”¯ä»˜";
                
                renderGrid();
                renderPrizeGallery(data.prizeSummary);
            }
        } catch(e) { console.error(e); } 
        finally { document.getElementById('loader').style.display = 'none'; }
    }

    // å„ªåŒ–ç‰ˆçé …å¡ç‰‡ (å«é€²åº¦æ¢)
    function renderPrizeGallery(summary) {
        document.getElementById('prize-gallery').innerHTML = summary.map(p => {
            const percent = (p.stock / p.total) * 100;
            const isSoldOut = p.stock === 0;
            return `
                <div class="p-card ${isSoldOut ? 'sold-out' : ''}" onclick="showLightbox('${p.img}')">
                    <img src="${p.img}">
                    <div class="p-name">${p.name}</div>
                    <div class="p-bar-bg"><div class="p-bar-fill" style="width:${percent}%"></div></div>
                    <div class="p-stock">å‰© ${p.stock}/${p.total}</div>
                </div>`;
        }).join('');
    }

    function showLightbox(imgUrl) {
        document.getElementById('lb-img').src = imgUrl;
        document.getElementById('lightbox').style.display = 'flex';
    }

    function renderGrid() {
        document.getElementById('main-grid').innerHTML = state.tickets.map(t => {
            const isBig = /Aè³|SP|1è³|å¤§ç/i.test(t.prizeName);
            let cls = "ticket"; 
            if(t.isTaken) cls += isBig ? " taken big-taken" : " taken";
            else if(state.selected.includes(String(t.id))) cls += " selected";
            
            // ç«¶å“å°æ¨™ï¼šåªé¡¯ç¤ºè™Ÿç¢¼ï¼Œä¸é¡¯ç¤ºç‹€æ…‹æ–‡å­—ï¼Œä¿æŒç°¡æ½”
            return `<div id="t-${t.id}" class="${cls}" onclick="${t.isTaken ? '' : `toggleSelect('${t.id}')`}">
                ${t.isTaken ? '' : t.id}
            </div>`;
        }).join('');
    }

    function toggleSelect(tid) {
        const idStr = String(tid);
        const idx = state.selected.indexOf(idStr);
        // éŸ³æ•ˆ
        const snd = document.getElementById('snd-select');
        if(snd) { snd.currentTime = 0; snd.play().catch(e=>{}); }

        if(idx > -1) { 
            state.selected.splice(idx, 1); 
            document.getElementById(`t-${tid}`).classList.remove('selected'); 
        } else { 
            state.selected.push(idStr); 
            document.getElementById(`t-${tid}`).classList.add('selected'); 
            if(window.navigator.vibrate) window.navigator.vibrate(10);
        }
        updateUI();
    }

    // æ–°å¢ï¼šéš¨æ©Ÿé¸è™Ÿé‚è¼¯
    function randomPick(count) {
        // å…ˆæ¸…ç©ºç›®å‰é¸æ“‡
        state.selected.forEach(tid => document.getElementById(`t-${tid}`).classList.remove('selected'));
        state.selected = [];
        
        // æ‰¾å‡ºæ‰€æœ‰å¯é¸çš„ç±¤
        const available = state.tickets.filter(t => !t.isTaken).map(t => String(t.id));
        
        // éš¨æ©Ÿé¸å–
        for(let i=0; i<count; i++) {
            if(available.length === 0) break;
            const rIdx = Math.floor(Math.random() * available.length);
            const picked = available.splice(rIdx, 1)[0];
            state.selected.push(picked);
            document.getElementById(`t-${picked}`).classList.add('selected');
        }
        updateUI();
    }

    function updateUI() {
        const total = state.selected.length * state.cost;
        document.getElementById('sel-count').innerText = state.selected.length;
        document.getElementById('total-cost').innerText = total.toLocaleString();
        
        const btn = document.getElementById('drawBtn');
        if(state.selected.length > 0) {
            btn.style.opacity = "1";
            btn.innerText = `æ”¯ä»˜ ${total}`;
        } else {
            btn.style.opacity = "0.5";
            btn.innerText = "è«‹é¸è™Ÿ";
        }
    }

    async function handleCheckout() {
        if(state.selected.length === 0) return;
        const total = state.selected.length * state.cost;
        if(state.points < total) { Swal.fire("é¤˜é¡ä¸è¶³", "è«‹å„²å€¼", "warning"); return; }
        
        const confirm = await Swal.fire({ 
            title: 'ç¢ºèªè³¼è²·ï¼Ÿ', 
            text: `å…± ${state.selected.length} å¼µï¼Œæ‰£é™¤ ${total} P`, 
            showCancelButton: true, 
            confirmButtonColor: '#ff3e3e',
            background: '#222', color: '#fff'
        });
        
        if(confirm.isConfirmed) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(CONFIG.GAS_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ uid: state.uid, name: state.name, mode: state.mode, ticketIds: state.selected }) 
                });
                const result = await res.json();
                
                if(result.status === "success") {
                    const hasBig = result.results.some(r => /Aè³|SP|1è³|å¤§ç/i.test(r.name));
                    if(hasBig || result.isLastOne) {
                        document.getElementById('snd-win').play().catch(e=>{});
                        confetti({ particleCount: 1000, spread: 180, origin: { y: 0.6 }, zIndex: 11000 });
                    }
                    
                    let html = `<div class="result-container">`;
                    if(result.isLastOne && result.lastOneInfo) {
                        html += `
                        <div class="res-card lo">
                            <img src="${result.lastOneInfo.img}">
                            <div>
                                <div style="color:#ff00cc; font-weight:bold;">ğŸ‘‘ LAST ONE</div>
                                <div style="font-size:0.9rem;">${result.lastOneInfo.name}</div>
                            </div>
                        </div>`;
                    }
                    
                    result.results.forEach(r => {
                        const isBig = /Aè³|SP|1è³|å¤§ç/i.test(r.name);
                        html += `
                        <div class="res-card ${isBig ? 'big' : ''}">
                            <img src="${r.img}">
                            <div>
                                <div style="color:${isBig?'var(--gold)':'#ccc'}; font-weight:bold;">${isBig?'âœ¨ å¤§ç':''} ${r.name}</div>
                                <div style="font-size:0.8rem; color:#888;">ç±¤è™Ÿ: ${r.id}</div>
                            </div>
                        </div>`;
                    });
                    html += `</div>`;
                    
                    document.getElementById('loader').style.display = 'none';
                    await Swal.fire({ title: "é–‹ç±¤çµæœ", html: html, background: '#222', color: '#fff', confirmButtonColor: '#ffcc00' });
                    await sync();
                } else {
                    throw new Error(result.message);
                }
            } catch(e) { 
                document.getElementById('loader').style.display = 'none';
                Swal.fire("éŒ¯èª¤", e.message, "error"); 
                await sync();
            }
        }
    }
    
    function changeMode(m) { 
        if(state.mode === m) return;
        state.mode = m; 
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.mode === m)); 
        sync(); 
    }
    
    window.onload = init;
</script>
</body>
</html>
