<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚-æ——è‰¦ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --red: #ff3e3e; --gold: #f1c40f; --dark: #050505; --sold: #1a1a1a; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; margin: 0; padding-top: 115px; padding-bottom: 160px; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .header { position: fixed; top: 0; width: 100%; z-index: 1000; background: #111; border-bottom: 2px solid var(--red); }
        .user-pts { padding: 8px 15px; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; }
        .tabs { display: flex; justify-content: center; gap: 5px; padding: 10px; }
        .tab { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; font-size: 13px; cursor: pointer; border: none; }
        .tab.active { background: var(--red); color: #fff; border: 1px solid var(--gold); }
        .board { width: 92vw; height: 92vw; max-width: 380px; margin: 0 auto; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 2px; background: #000; border: 4px solid #333; border-radius: 15px; padding: 5px; }
        .lamp { background: #222; border-radius: 2px; font-size: 8px; display: flex; align-items: center; justify-content: center; color: #444; border: 1px solid #333; }
        .active-a { background: var(--gold) !important; color: #000 !important; box-shadow: 0 0 15px var(--gold); z-index: 5; }
        .active-b { background: var(--red) !important; color: #fff !important; box-shadow: 0 0 10px var(--red); z-index: 5; }
        .footer-btns { position: fixed; bottom: 85px; width: 100%; display: flex; flex-direction: column; align-items: center; }
        .price-tag { color: var(--gold); font-size: 16px; font-weight: bold; margin-bottom: 8px; border: 1px solid var(--gold); padding: 2px 12px; border-radius: 12px; }
        .btn-draw { width: 135px; height: 52px; border-radius: 26px; border: none; font-weight: bold; color: #fff; cursor: pointer; font-size: 16px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
        .res-box { width: 85%; background: #222; margin: 6px; padding: 10px; border-radius: 10px; border-left: 5px solid var(--red); text-align: left; }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-pts"><span>æˆ‘çš„é»æ•¸ï¼š<span id="pts">--</span> P</span><span id="u-name" style="font-size:10px; color:#666;">è®€å–ä¸­</span></div>
        <div class="tabs">
            <button class="tab active" onclick="sw(0)">å–®æŒ‘å¥—</button>
            <button class="tab" onclick="sw(1)">ï¼¡å€ä»»é¸</button>
            <button class="tab" onclick="sw(2)">ï¼¢å€ä»»é¸</button>
        </div>
    </div>
    <div class="board" id="board"></div>
    <div id="info" style="font-size:12px; color:#888; text-align: center; margin-top: 15px;">è³‡æ–™åŒæ­¥ä¸­...</div>
    <div class="footer-btns">
        <div class="price-tag" id="price-tag">-- P</div>
        <div style="display:flex;"><button class="btn-draw" style="background:#333; margin-right:10px;" id="b1" onclick="draw(1)">å–®æŠ½ä¸€æ¬¡</button><button class="btn-draw" style="background:var(--red);" id="b5" onclick="draw(5)">äº”é€£æŠ½ï¼</button></div>
    </div>
    <div id="win" class="overlay"><h2 style="color:var(--gold);">ğŸ‰ æ­å–œä¸­ç</h2><div id="list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div><button onclick="location.reload()" style="margin-top:20px; color:#fff; background:none; border:1px solid #fff; padding:10px 20px; border-radius:20px;">ç¢ºèªè¿”å›</button></div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const POOLS = ["å–®æŒ‘å¥—", "ï¼¡å€ä»»é¸", "ï¼¢å€ä»»é¸"];
        let uid="", userName="", allData={}, curIdx=0, isAnim=false, finalRes=null, ptrs=[];
        const coords = []; for(let i=1;i<=11;i++) coords.push({r:1,c:i}); for(let i=2;i<=11;i++) coords.push({r:i,c:11}); for(let i=10;i>=1;i--) coords.push({r:11,c:i}); for(let i=10;i>=2;i--) coords.push({r:i,c:1});

        // æ¥æ”¶é»æ•¸
        window.cb2 = (r) => { 
            if(r && r.points !== undefined) document.getElementById('pts').innerText = r.points; 
        };
        // æ¥æ”¶åº«å­˜
        window.cb1 = (r) => { allData = r; upd(); };
        // æ¥æ”¶æŠ½ççµæœ
        window.cb3 = (r) => {
            if(r.status === 'success') {
                finalRes = r.results;
                document.getElementById('pts').innerText = r.remainingPoints;
                // è¨­å®šç‡ˆè™Ÿç›®æ¨™ï¼šAè³è·‘å‘0ï¼ŒBè³è·‘å‘20
                finalRes.forEach((x, i) => { 
                    ptrs[i].target = (x.grade === 'A' ? 0 : 20); 
                    setTimeout(() => { ptrs[i].t = true; }, i * 300); 
                });
            } else { alert(r.message); location.reload(); }
        };

        function init() {
            const b = document.getElementById('board');
            coords.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'lamp'; d.id = 'l-' + i;
                d.style.gridRow = p.r; d.style.gridColumn = p.c;
                d.innerText = (i === 0 || i === 20) ? 'A' : 'B';
                b.appendChild(d);
            });
            // åˆå§‹æŠ“å–åº«å­˜
            const s = document.createElement('script');
            s.src = `${API}?action=getPoolStatus&callback=cb1&t=${Date.now()}`;
            document.body.appendChild(s);
        }

        async function liffInit() {
            await liff.init({ liffId: "2009072982-6smlV2gu" });
            if(!liff.isLoggedIn()){ liff.login(); return; }
            const p = await liff.getProfile(); uid = p.userId; userName = p.displayName;
            document.getElementById('u-name').innerText = userName;
            // æ‹¿åˆ°UIDå¾Œç«‹å³æŠ“é»æ•¸
            const s = document.createElement('script');
            s.src = `${API}?action=checkUser&uid=${uid}&callback=cb2&t=${Date.now()}`;
            document.body.appendChild(s);
        }

        function sw(i) { if(isAnim) return; curIdx=i; document.querySelectorAll('.tab').forEach((b,j)=>b.className=i===j?'tab active':'tab'); upd(); }
        
        function upd() {
            const d = allData[POOLS[curIdx]]; if(!d) return;
            document.getElementById('info').innerText = `å‰©é¤˜ç±¤æ•¸ï¼š${d.total} (A:${d.a} B:${d.b})`;
            document.getElementById('price-tag').innerText = `${d.price} P`;
        }

        function draw(c) {
            if(isAnim || !uid) return;
            isAnim = true; finalRes = null;
            document.getElementById('b1').disabled = document.getElementById('b5').disabled = true;
            
            const s = document.createElement('script');
            s.src = `${API}?action=draw&uid=${uid}&name=${encodeURIComponent(userName)}&poolId=${encodeURIComponent(POOLS[curIdx])}&count=${c}&callback=cb3&t=${Date.now()}`;
            document.body.appendChild(s);

            ptrs = Array.from({length: c}, (_, i) => ({ p: (i * 3) % 40, s: false, t: null, d: 0, target: null }));

            const anim = () => {
                if(!isAnim) return;
                document.querySelectorAll('.lamp').forEach(l => l.classList.remove('active-a', 'active-b'));
                let stopAll = true;
                
                ptrs.forEach((p, i) => {
                    if(!p.s) {
                        stopAll = false;
                        if(p.t !== null) { // è³‡æ–™å·²å›å‚³
                            p.d++; if(p.d % (i + 1) === 0) p.p = (p.p + 1) % 40;
                            if(p.p === p.target && p.d > 30) p.s = true;
                        } else { p.p = (p.p + 1) % 40; }
                    }
                    const el = document.getElementById('l-' + p.p);
                    if(el) el.classList.add(el.innerText === 'A' ? 'active-a' : 'active-b');
                });

                if(stopAll && finalRes) { 
                    isAnim = false; 
                    setTimeout(() => {
                        document.getElementById('win').style.display = 'flex';
                        document.getElementById('list').innerHTML = finalRes.map(x => `<div class="res-box"><b>${x.grade}è³</b>ï¼š${x.name}</div>`).join('');
                    }, 800);
                } else { setTimeout(anim, 60); }
            };
            anim();
        }

        init(); liffInit();
    </script>
</body>
</html>
