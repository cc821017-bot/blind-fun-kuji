<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚-40å¸­æ——è‰¦æŠ½ç</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --red: #ff3e3e; --gold: #f1c40f; --dark: #050505; --off: #151515; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; text-align: center; margin: 0; padding-top: 60px; overflow: hidden; }
        .user-bar { position: fixed; top: 0; width: 100%; background: #111; padding: 12px 0; border-bottom: 2px solid var(--red); z-index: 1000; font-weight: bold; }
        
        /* 11x11 å¤§è½‰ç›¤ */
        .game-container { 
            width: 95vw; height: 95vw; max-width: 400px; max-height: 400px; 
            margin: 10px auto; position: relative; background: #000; border: 4px solid #333; border-radius: 15px;
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 2px; padding: 5px;
        }
        
        .center-display { 
            grid-area: 3 / 3 / 10 / 10; background: #111; border-radius: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }

        /* ç‡ˆè™Ÿæ¨£å¼ */
        .lamp { 
            background: #222; border-radius: 3px; font-size: 9px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; color: #444; border: 1px solid #333;
        }
        .lamp-a { color: #650; border-color: #540; } /* Aè³æœªä¸­ */
        .lamp.off { background: var(--off) !important; color: #000 !important; border: none !important; box-shadow: none !important; }
        
        /* è·‘é¦¬ç‡ˆé»äº®æ¨£å¼ */
        .lamp.active-b { background: var(--red) !important; color: #fff !important; box-shadow: 0 0 10px var(--red); z-index: 10; }
        .lamp.active-a { background: var(--gold) !important; color: #000 !important; box-shadow: 0 0 15px var(--gold); z-index: 10; }

        .btn-skip { 
            position: absolute; bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid #444; 
            color: #888; padding: 5px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; display: none;
        }

        .draw-btn { width: 120px; height: 50px; border-radius: 25px; border: none; font-weight: bold; color: #fff; cursor: pointer; margin: 10px; }
        .win-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="user-bar">é»æ•¸ï¼š<span id="display-pts">----</span> P</div>
    
    <div class="game-container" id="game-board">
        <div class="center-display">
            <img id="main-preview" style="width:70%;" src="https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480">
            <div id="status-text" style="color:var(--gold); font-weight:bold; margin-top:5px;"></div>
            <button class="btn-skip" id="btn-skip" onclick="skipAnimation()">è·³éå‹•ç•«</button>
        </div>
    </div>

    <div class="btn-group">
        <button class="draw-btn" style="background:#333;" id="btn-s" onclick="goDraw(1)">å–®æŠ½</button>
        <button class="draw-btn" style="background:var(--red);" id="btn-m" onclick="goDraw(5)">äº”é€£æŠ½</button>
    </div>

    <div id="winPanel" class="win-overlay">
        <h2 style="color:var(--gold); margin-bottom: 20px;">ğŸ‰ ä¸­çæ¸…å–® ğŸ‰</h2>
        <div id="res-list" style="width:85%; max-height: 50vh; overflow-y: auto;"></div>
        <button onclick="location.reload()" style="margin-top:30px; padding: 12px 60px; border-radius: 30px; border:none; font-weight:bold; background: #fff; color: #000;">ç¢ºèªæ”¶ä¸‹</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const LAMP_COORDS = [];
        // ç”Ÿæˆ 40 æ ¼åæ¨™ (11x11 å¤–åœˆ)
        for(let i=1; i<=11; i++) LAMP_COORDS.push({r: 1, c: i});
        for(let i=2; i<=11; i++) LAMP_COORDS.push({r: i, c: 11});
        for(let i=10; i>=1; i--) LAMP_COORDS.push({r: 11, c: i});
        for(let i=10; i>=2; i--) LAMP_COORDS.push({r: i, c: 1});

        let myUid = "", stockData = {}, isAnimPlaying = false;
        let pointers = [], finalResults = null, timerRefs = [];

        function initBoard() {
            const board = document.getElementById('game-board');
            LAMP_COORDS.forEach((pos, i) => {
                const div = document.createElement('div');
                div.className = 'lamp';
                div.id = 'lamp-' + i;
                div.style.gridRow = pos.r; div.style.gridColumn = pos.c;
                // è¨­å®š A è³ä½ç½® (1è™Ÿã€21è™Ÿ)
                if(i === 0 || i === 20) {
                    div.innerText = 'A';
                    div.classList.add('lamp-a');
                } else {
                    div.innerText = 'B';
                }
                board.appendChild(div);
            });
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                myUid = profile.userId;
                fetchData(profile.displayName);
            } catch (e) {}
        }

        function fetchData(name) {
            const s1 = document.createElement('script'); s1.src = `${API_URL}?action=getPoolStatus&callback=cb_st`; document.body.appendChild(s1);
            const s2 = document.createElement('script'); s2.src = `${API_URL}?action=checkUser&uid=${myUid}&name=${encodeURIComponent(name)}&callback=cb_pt`; document.body.appendChild(s2);
        }

        window.cb_st = (res) => { 
            stockData = res["å–®æŒ‘å¥—"]; 
            // ç†„ç‡ˆé‚è¼¯ï¼šç”±å³å¾€å·¦ç†„æ»…å·²æŠ½ä¸­çš„å¼µæ•¸
            const sold = 40 - stockData.total;
            for(let i=39; i > 39 - sold; i--) {
                const el = document.getElementById('lamp-' + i);
                if(el) el.classList.add('off');
            }
        };

        window.cb_pt = (res) => { document.getElementById('display-pts').innerText = res.points; };

        function goDraw(count) {
            if(!myUid || isAnimPlaying) return;
            isAnimPlaying = true;
            document.getElementById('btn-skip').style.display = 'block';
            document.getElementById('status-text').innerText = "é‹å‹¢æŠ½å–ä¸­...";
            
            const s = document.createElement('script');
            s.src = `${API_URL}?action=draw&uid=${myUid}&poolId=%E5%96%AE%E6%8C%91%E5%A5%97&count=${count}&callback=cb_res`;
            document.body.appendChild(s);
            
            startAnimation(count);
        }

        function startAnimation(count) {
            pointers = Array.from({length: count}, (_, i) => ({ 
                pos: i * 3, 
                finished: false 
            }));

            const run = () => {
                if(!isAnimPlaying) return;
                document.querySelectorAll('.lamp').forEach(l => l.classList.remove('active-b', 'active-a'));
                
                pointers.forEach(p => {
                    if(!p.finished) p.pos = (p.pos + 1) % 40;
                    const el = document.getElementById('lamp-' + p.pos);
                    if(el && !el.classList.contains('off')) {
                        el.classList.add(el.innerText === 'A' ? 'active-a' : 'active-b');
                    }
                });
                timerRefs.push(setTimeout(run, 60));
            };
            run();
        }

        window.cb_res = (res) => {
            if(res.status === 'success') {
                finalResults = res.results;
                document.getElementById('status-text').innerText = "å³å°‡é–‹ç...";
                setTimeout(() => stopSequentially(0), 1200);
            } else {
                alert(res.message); location.reload();
            }
        };

        function stopSequentially(idx) {
            if(!isAnimPlaying || idx >= pointers.length) {
                setTimeout(showWin, 800);
                return;
            }

            let steps = 0;
            const slowDown = () => {
                if(!isAnimPlaying) return;
                steps++;
                if(steps > 12) {
                    pointers[idx].finished = true;
                    stopSequentially(idx + 1); // åœä¸‹ä¸€å€‹
                } else {
                    setTimeout(slowDown, 60 + (steps * 25));
                }
            };
            slowDown();
        }

        function skipAnimation() {
            isAnimPlaying = false;
            timerRefs.forEach(clearTimeout);
            showWin();
        }

        function showWin() {
            isAnimPlaying = false;
            document.getElementById('btn-skip').style.display = 'none';
            const list = document.getElementById('res-list');
            list.innerHTML = "";
            finalResults.forEach(r => {
                const div = document.createElement('div');
                div.style.cssText = "background:#222; margin:8px 0; padding:12px; border-radius:10px; text-align:left;";
                div.style.borderLeft = (r.grade === 'A') ? "5px solid var(--gold)" : "5px solid var(--red)";
                div.innerHTML = `<b style="color:${r.grade==='A'? 'var(--gold)':'white'}">${r.grade}è³</b> | ${r.name}`;
                list.appendChild(div);
            });
            document.getElementById('winPanel').style.display = 'flex';
        }

        initBoard();
        initLIFF();
    </script>
</body>
</html>
