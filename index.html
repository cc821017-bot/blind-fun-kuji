<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚-æ——è‰¦æŠ½çä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --red: #ff3e3e; --gold: #f1c40f; --dark: #050505; --sold-bg: #1a1a1a; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; text-align: center; margin: 0; padding-top: 85px; overflow: hidden; transition: background 0.2s; }
        
        /* é ‚éƒ¨å°è¦½åˆ—èˆ‡è·‘é¦¬ç‡ˆ */
        .header-fixed { position: fixed; top: 0; width: 100%; z-index: 1000; background: #111; border-bottom: 2px solid var(--red); }
        .user-bar { padding: 10px 0; font-weight: bold; font-size: 16px; }
        .news-bar { background: #000; height: 24px; line-height: 24px; font-size: 12px; color: var(--gold); overflow: hidden; position: relative; border-top: 1px solid #222; }
        .news-track { position: absolute; white-space: nowrap; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }

        .pool-tabs { display: flex; justify-content: center; gap: 8px; padding: 10px; }
        .tab-btn { flex: 1; padding: 10px 5px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; cursor: pointer; font-size: 13px; }
        .tab-btn.active { background: var(--red); color: white; border-color: var(--gold); }

        .game-container { 
            width: 95vw; height: 95vw; max-width: 400px; max-height: 400px; 
            margin: 5px auto; position: relative; background: #000; border: 4px solid #333; border-radius: 15px;
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 2px; padding: 5px;
        }
        .center-display { grid-area: 3 / 3 / 10 / 10; background: #111; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        
        .lamp { background: #222; border-radius: 2px; font-size: 9px; display: flex; align-items: center; justify-content: center; color: #444; border: 1px solid #333; }
        .lamp.sold-out { background: var(--sold-bg) !important; color: #333 !important; border: 1px dashed #222 !important; opacity: 0.4; }
        .lamp.active-b { background: var(--red) !important; color: #fff !important; box-shadow: 0 0 12px var(--red); z-index: 10; }
        .lamp.active-a { background: var(--gold) !important; color: #000 !important; box-shadow: 0 0 20px var(--gold); z-index: 10; }

        /* å‘¼å¸ç‡ˆå‹•ç•« */
        @keyframes breathe { 0%, 100% { opacity: 0.6; box-shadow: 0 0 5px var(--red); } 50% { opacity: 1; box-shadow: 0 0 15px var(--red); } }
        
        /* æ›´æ–°ï¼šè·³éæŒ‰éˆ•ä½ç½®èª¿æ•´è‡³åº•éƒ¨é‚Šç·£ */
        .btn-skip { 
            position: absolute; 
            bottom: -25px; /* ç§»å‡ºä¸­å¿ƒå€å¡Šï¼Œé è¿‘æŒ‰éˆ•ç¾¤ */
            left: 50%;
            transform: translateX(-50%);
            background: rgba(20, 20, 20, 0.9); 
            border: 1px solid var(--red); 
            color: var(--red); 
            padding: 6px 25px; 
            border-radius: 20px; 
            font-size: 13px; 
            font-weight: bold; 
            z-index: 500; 
            display: none;
            animation: breathe 1.5s infinite;
        }

        .draw-btn { width: 125px; height: 50px; border-radius: 25px; border: none; font-weight: bold; color: #fff; cursor: pointer; margin: 10px; transition: 0.3s; }
        .draw-btn:disabled { background: #222 !important; color: #555 !important; cursor: not-allowed; opacity: 0.7; }

        .win-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
        .res-item { display: flex; align-items: center; background: #222; margin-bottom: 10px; padding: 10px; border-radius: 12px; border-left: 6px solid var(--red); text-align: left; width: 85%; }
        .res-item.is-a { border-left-color: var(--gold); background: #2a2410; }
        .res-thumb { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; margin-right: 15px; border: 1px solid #444; }
        .share-btn { background: #06C755; color: white; padding: 12px 30px; border-radius: 25px; border: none; font-weight: bold; margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="header-fixed">
        <div class="user-bar">é»æ•¸ï¼š<span id="display-pts">----</span> P</div>
        <div class="news-bar">
            <div class="news-track" id="news-track">ğŸ”¥ ç›²ç©æ¨‚ï¼šç¥æ‚¨æŠ½ä¸­å¤§çï¼ å®˜æ–¹ä¸€ç•ªè³ã€è‡ªè£½ä¸€ç•ªè³æŒçºŒæ›´æ–°ä¸­ ğŸ”¥</div>
        </div>
    </div>

    <div class="pool-tabs">
        <button id="btn0" class="tab-btn active" onclick="switchTo(0)">å–®æŒ‘å¥—</button>
        <button id="btn1" class="tab-btn" onclick="switchTo(1)">ï¼¡å€ä»»é¸</button>
        <button id="btn2" class="tab-btn" onclick="switchTo(2)">ï¼¢å€ä»»é¸</button>
    </div>

    <div class="game-container" id="game-board">
        <div class="center-display">
            <img id="main-preview" style="width:70%; max-height:70%; object-fit: contain;" src="https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480">
            <div id="status-text" style="color:var(--gold); font-size:12px; margin-top:5px;"></div>
        </div>
        <button class="btn-skip" id="skip-trigger" onclick="skipAnimation()">è·³éå‹•ç•«</button>
    </div>
    
    <div id="stock-info" style="font-size:12px; color:#666; margin-top: 15px;">åŒæ­¥ä¸­...</div>

    <div class="btn-group">
        <button class="draw-btn" style="background:#333;" id="btn-single" onclick="goDraw(1)">å–®æŠ½ä¸€æ¬¡</button>
        <button class="draw-btn" style="background:var(--red);" id="btn-multi" onclick="goDraw(5)">äº”é€£æŠ½ï¼</button>
    </div>

    <div id="winPanel" class="win-overlay">
        <h2 style="color:var(--gold); font-size: 26px;">ğŸ‰ æ­å–œä¸­ç ğŸ‰</h2>
        <div id="res-list" style="width:100%; max-height:55vh; overflow-y:auto; display: flex; flex-direction: column; align-items: center;"></div>
        <button class="share-btn" onclick="shareToLINE()">åˆ†äº«å–œæ‚…çµ¦å¥½å‹ â”</button>
        <button onclick="location.reload()" style="padding:10px 60px; border-radius:30px; background:transparent; border:1px solid #555; color:#888; font-weight:bold;">ç¢ºèªæ”¶ä¸‹</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const POOLS = ["å–®æŒ‘å¥—", "ï¼¡å€ä»»é¸", "ï¼¢å€ä»»é¸"];
        const PREVIEWS = ["https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480", "https://i.meee.com.tw/d2cFJiy.jpg", "https://i.meee.com.tw/B8xVcyj.jpg"];
        const B_THUMB = "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg";

        const LAMP_COORDS = [];
        for(let i=1; i<=11; i++) LAMP_COORDS.push({r: 1, c: i});
        for(let i=2; i<=11; i++) LAMP_COORDS.push({r: i, c: 11});
        for(let i=10; i>=1; i--) LAMP_COORDS.push({r: 11, c: i});
        for(let i=10; i>=2; i--) LAMP_COORDS.push({r: i, c: 1});

        let myUid = "", myName = "", allData = {}, isAnim = false, currentIdx = 0, pointers = [], finalRes = null;

        function initBoard() {
            const board = document.getElementById('game-board');
            document.querySelectorAll('.lamp').forEach(el => el.remove());
            LAMP_COORDS.forEach((pos, i) => {
                const div = document.createElement('div');
                div.className = 'lamp'; div.id = 'lamp-' + i;
                div.style.gridRow = pos.r; div.style.gridColumn = pos.c;
                div.innerText = (i===0 || i===20) ? 'A' : 'B';
                if(i===0 || i===20) div.classList.add('lamp-a');
                board.appendChild(div);
            });
        }

        function switchTo(idx) {
            if(isAnim) return;
            currentIdx = idx;
            document.getElementById('main-preview').src = PREVIEWS[idx];
            document.querySelectorAll('.tab-btn').forEach((b, i) => b.className = i===idx ? 'tab-btn active' : 'tab-btn');
            updateUI();
        }

        function updateUI() {
            const data = allData[POOLS[currentIdx]];
            if(data) {
                const isSoldOut = (data.a <= 0);
                document.getElementById('stock-info').innerText = `å‰©é¤˜ï¼š${data.total} (A:${data.a} B:${data.b})`;
                const sBtn = document.getElementById('btn-single');
                const mBtn = document.getElementById('btn-multi');
                if(isSoldOut) {
                    sBtn.disabled = true; mBtn.disabled = true;
                    sBtn.innerText = "å¤§çå·²æŠ½å®Œ"; mBtn.innerText = "è«‹æ›æ± ";
                } else {
                    sBtn.disabled = false; mBtn.disabled = false;
                    sBtn.innerText = "å–®æŠ½ä¸€æ¬¡"; mBtn.innerText = "äº”é€£æŠ½ï¼";
                }
                document.querySelectorAll('.lamp').forEach(l => l.classList.remove('sold-out'));
                const sold = 40 - data.total;
                for(let i=39; i > 39 - sold; i--) document.getElementById('lamp-'+i)?.classList.add('sold-out');
            }
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                myUid = profile.userId; myName = profile.displayName;
                fetchData(myName);
            } catch(e) {}
        }

        function fetchData(name) {
            const s1 = document.createElement('script'); s1.src = `${API_URL}?action=getPoolStatus&callback=cb_st`; document.body.appendChild(s1);
            const s2 = document.createElement('script'); s2.src = `${API_URL}?action=checkUser&uid=${myUid}&name=${encodeURIComponent(name)}&callback=cb_pt`; document.body.appendChild(s2);
        }

        window.cb_st = (res) => { allData = res; updateUI(); };
        window.cb_pt = (res) => { if(res && res.points !== undefined) document.getElementById('display-pts').innerText = res.points; };

        function goDraw(count) {
            if(!myUid || isAnim) return;
            isAnim = true;
            document.getElementById('skip-trigger').style.display = 'block';
            document.getElementById('status-text').innerText = "é‹å‹¢å‡èšä¸­...";
            const s = document.createElement('script');
            s.src = `${API_URL}?action=draw&uid=${myUid}&poolId=${encodeURIComponent(POOLS[currentIdx])}&count=${count}&callback=cb_res`;
            document.body.appendChild(s);
            
            pointers = Array.from({length: count}, (_, i) => ({ pos: (i * 3) % 40, stop: false, target: null, isClosing: false, delay: 0 }));
            const run = () => {
                if(!isAnim) return;
                document.querySelectorAll('.lamp').forEach(l => l.classList.remove('active-b', 'active-a'));
                let allStopped = true;
                pointers.forEach((p, i) => {
                    if(!p.stop) {
                        allStopped = false;
                        if(p.isClosing) {
                            p.delay++;
                            if(p.delay % (i + 1) === 0) p.pos = (p.pos + 1) % 40;
                            if(p.pos === p.target && p.delay > (i * 10 + 5)) p.stop = true;
                        } else { p.pos = (p.pos + 1) % 40; }
                    }
                    const el = document.getElementById('lamp-' + p.pos);
                    if(el) el.classList.add(el.innerText==='A' ? 'active-a' : 'active-b');
                });
                if(allStopped) {
                    if(finalRes.some(r => r.grade === 'A')) triggerGoldenCelebration();
                    setTimeout(showWin, 1500); 
                } else { setTimeout(run, 60); }
            };
            run();
        }

        function triggerGoldenCelebration() {
            document.body.classList.add('flash-active');
            document.getElementById('game-board').style.transform = 'scale(1.05)';
            setTimeout(() => {
                document.body.classList.remove('flash-active');
                document.getElementById('game-board').style.transform = 'scale(1)';
            }, 1000);
        }

        window.cb_res = (res) => {
            if(res.status === 'success') {
                finalRes = res.results.sort((a, b) => (a.grade === 'A' ? 1 : -1));
                const availA = [], availB = [];
                for(let i=0; i<40; i++) {
                    const el = document.getElementById('lamp-'+i);
                    if(!el.classList.contains('sold-out')) (el.innerText==='A' ? availA : availB).push(i);
                }
                finalRes.forEach((r, i) => {
                    const list = (r.grade==='A' && availA.length > 0) ? availA : availB;
                    const tIdx = Math.floor(Math.random()*list.length);
                    pointers[i].target = list[tIdx];
                    list.splice(tIdx, 1);
                    setTimeout(() => { pointers[i].isClosing = true; }, i * 250);
                });
            } else { alert(res.message); location.reload(); }
        };

        function skipAnimation() {
            isAnim = false;
            showWin();
        }

        function showWin() {
            isAnim = false;
            document.getElementById('skip-trigger').style.display = 'none';
            document.getElementById('winPanel').style.display = 'flex';
            const listDiv = document.getElementById('res-list');
            listDiv.innerHTML = finalRes.map(r => {
                const imgUrl = (r.grade === 'A') ? PREVIEWS[currentIdx] : B_THUMB;
                const isA = (r.grade === 'A');
                return `<div class="res-item ${isA ? 'is-a' : ''}"><img src="${imgUrl}" class="res-thumb"><div class="res-info"><b style="color:${isA ? 'var(--gold)' : '#fff'}">${r.grade}è³</b><span>${r.name}</span></div></div>`;
            }).join('');
        }

        function shareToLINE() {
            const hasA = finalRes.some(r => r.grade === 'A');
            const resultText = finalRes.map(r => `ã€${r.grade}è³ã€‘${r.name}`).join('\n');
            const mainMsg = hasA ? `ğŸ‰ å¤ªçˆ½å•¦ï¼æˆ‘åœ¨ã€Œç›²ç©æ¨‚ã€ä¸­å¤§ç Aè³äº†ï¼ ğŸ‰` : `æˆ‘åœ¨ã€Œç›²ç©æ¨‚ã€æŠ½çå•¦ï¼å¤§å®¶å¿«ä¾†è·Ÿæˆ‘ä¸€èµ·è©¦æ‰‹æ°£ï¼`;
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([{
                    "type": "flex", "altText": "ç›²ç©æ¨‚æŠ½ççµæœåˆ†äº«",
                    "contents": {
                        "type": "bubble",
                        "hero": { "type": "image", "url": PREVIEWS[currentIdx], "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
                        "body": { "type": "box", "layout": "vertical", "contents": [
                            { "type": "text", "text": "ç›²ç©æ¨‚ - å¹¸é‹é–‹ç", "weight": "bold", "size": "xl", "color": "#ff3e3e" },
                            { "type": "text", "text": mainMsg, "wrap": true, "margin": "md" },
                            { "type": "separator", "margin": "lg" },
                            { "type": "text", "text": resultText, "wrap": true, "size": "sm", "margin": "md", "color": "#666666" }
                        ]},
                        "footer": { "type": "box", "layout": "vertical", "contents": [
                            { "type": "button", "action": { "type": "uri", "label": "æˆ‘ä¹Ÿè¦æŠ½ï¼", "uri": "https://liff.line.me/2009072982-6smlV2gu" }, "style": "primary", "color": "#ff3e3e" }
                        ]}
                    }
                }]).then(() => { alert("åˆ†äº«æˆåŠŸï¼"); });
            }
        }

        initBoard();
        initLIFF();
    </script>
</body>
</html>
