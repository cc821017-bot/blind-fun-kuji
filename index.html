<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚ä¸€ç•ªè³ - å¯¦é«”æ¨¡æ“¬ç›¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { --kuji-red: #e63946; --kuji-dark: #0f0f1a; --kuji-gold: #ffb627; --card-bg: #1a1a2e; }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; color: #fff; margin: 0; padding-bottom: 130px; }

        /* é ‚éƒ¨è³‡è¨Š */
        .header-info { display: flex; justify-content: space-between; padding: 15px; background: #161625; border-bottom: 2px solid var(--kuji-red); }
        
        /* çµ±è¨ˆé¢ç‰ˆï¼šé¡¯ç¤ºé‚„æœ‰å“ªäº›å¤§è³ */
        .stat-panel { display: flex; overflow-x: auto; padding: 10px; gap: 10px; background: #111; border-bottom: 1px solid #333; }
        .stat-item { flex-shrink: 0; background: #222; padding: 5px 10px; border-radius: 4px; border: 1px solid #444; font-size: 11px; }
        .stat-count { color: var(--kuji-red); font-weight: bold; }

        /* å¯¦é«”æŠ½çç›¤æ ¸å¿ƒ */
        .plate-container { padding: 15px; }
        .kuji-plate {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* æ‰‹æ©Ÿç«¯ä¸€æ’ 8 å€‹ç±¤ä½ */
            gap: 5px;
            background: #111;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .ticket {
            aspect-ratio: 1/1;
            background: #2d2d44;
            border: 1px solid #444;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            color: #555;
            position: relative;
            transition: all 0.2s;
        }

        /* ä¸åŒçš„è³åˆ¥é¡è‰² */
        .ticket.A { background: #ff4757; color: #fff; border-color: #ff6b81; }
        .ticket.B { background: #ffa502; color: #fff; border-color: #eccc68; }
        .ticket.C { background: #2ed573; color: #fff; border-color: #7bed9f; }
        .ticket.Other { background: #57606f; color: #fff; border-color: #a4b0be; }

        /* å·²æŠ½èµ°çš„ç±¤ */
        .ticket.taken { background: #000 !important; color: transparent !important; border: 1px solid #222; }
        .ticket.taken::after { content: 'æ¸ˆ'; color: #333; font-size: 10px; }

        /* å‹•ç•«ä¸­ */
        .ticket.active { 
            transform: scale(1.2); 
            z-index: 10; 
            box-shadow: 0 0 15px var(--kuji-gold); 
            background: var(--kuji-gold) !important; 
            color: #000 !important;
        }

        /* åº•éƒ¨æŒ‰éˆ• */
        .footer { position: fixed; bottom: 0; width: 100%; background: #111; padding: 15px 0; border-top: 1px solid #333; }
        .btn-group { display: flex; gap: 10px; width: 90%; margin: 0 auto; }
        .draw-btn { flex: 1; padding: 14px; border: none; border-radius: 30px; font-size: 1rem; font-weight: bold; color: #fff; }
        .btn-5 { background: linear-gradient(45deg, var(--kuji-red), #ff6b81); }
    </style>
</head>
<body>

<div class="header-info">
    <div>ç©å®¶ï¼š<b id="disp-name">---</b></div>
    <div>é»æ•¸ï¼š<b id="disp-points" style="color:var(--kuji-gold)">0</b> P</div>
</div>

<div class="stat-panel" id="stat-panel"></div>

<div class="plate-container">
    <div style="margin-bottom:10px; font-size:0.9rem; color:var(--kuji-red)">â— å‰©é¤˜å¯¦é«”ç›¤é¢</div>
    <div class="kuji-plate" id="ticket-plate">
        </div>
</div>

<div class="footer">
    <div style="text-align:center; margin-bottom: 8px; color: var(--kuji-gold); font-weight: bold;">å–®æŠ½ï¼š<span id="cost-val">0</span> P</div>
    <div class="btn-group">
        <button id="btn-1" class="draw-btn" style="background:#444" onclick="handleDraw(1)">å–®æŠ½</button>
        <button id="btn-5" class="draw-btn btn-5" onclick="handleDraw(5)">äº”é€£æŠ½</button>
    </div>
</div>

<script>
    const CONFIG = {
        GAS_URL: "æ‚¨çš„_GAS_ç¶²é æ‡‰ç”¨ç¨‹å¼_URL",
        LIFF_ID: "2009072982-6smlV2gu"
    };

    let state = { uid: "", name: "", points: 0, mode: "å–®æŒ‘å¥—", prizes: [], allTickets: [], isRunning: false };

    async function init() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            state.uid = profile.userId;
            state.name = profile.displayName;
            document.getElementById('disp-name').innerText = state.name;
            await syncData();
        } catch (err) { console.error(err); }
    }

    async function syncData() {
        const res = await fetch(`${CONFIG.GAS_URL}?uid=${state.uid}&mode=${state.mode}&userName=${encodeURIComponent(state.name)}`);
        const data = await res.json();
        if(data.status === "success") {
            state.points = data.userPoints;
            state.prizes = data.prizes;
            state.cost = data.cost;
            document.getElementById('disp-points').innerText = state.points.toLocaleString();
            document.getElementById('cost-val').innerText = state.cost;
            generateVirtualPlate();
            renderStats();
        }
    }

    // æ ¸å¿ƒï¼šè¦–è¦ºæ¨¡æ“¬æ³• - å°‡çµ±è¨ˆæ•¸æ“šå±•é–‹ç‚ºå¯¦é«”æ ¼å­
    function generateVirtualPlate() {
        let tempTickets = [];
        state.prizes.forEach(p => {
            // å·²æŠ½èµ°çš„
            for(let i=0; i<p.out; i++) tempTickets.push({ name: p.name, status: 'taken' });
            // å‰©é¤˜çš„
            for(let i=0; i<p.stock; i++) tempTickets.push({ name: p.name, status: 'available' });
        });

        // é€™è£¡å¯ä»¥é¸æ“‡æ˜¯å¦è¦æ‰“äº‚é †åºï¼Œæ¨¡æ“¬å¯¦é«”ç›¤éš¨æ©Ÿæ„Ÿ
        // tempTickets.sort(() => Math.random() - 0.5); 

        state.allTickets = tempTickets;
        const plate = document.getElementById('ticket-plate');
        plate.innerHTML = state.allTickets.map((t, i) => {
            const level = t.name.split('è³')[0];
            const colorClass = (['A','B','C'].includes(level)) ? level : 'Other';
            return `<div class="ticket ${t.status === 'taken' ? 'taken' : colorClass}" id="t-${i}">${t.status === 'taken' ? '' : level}</div>`;
        }).join('');
    }

    function renderStats() {
        const panel = document.getElementById('stat-panel');
        panel.innerHTML = state.prizes.map(p => `
            <div class="stat-item">${p.name}: <span class="stat-count">${p.stock}</span>/${p.total}</div>
        `).join('');
    }

    async function handleDraw(count) {
        if(state.isRunning) return;
        if(state.points < state.cost * count) { Swal.fire("é»æ•¸ä¸è¶³", "", "warning"); return; }

        state.isRunning = true;
        let animation = startAnimation();

        try {
            const res = await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ uid: state.uid, mode: state.mode, count: count })
            });
            const result = await res.json();
            
            clearInterval(animation);
            if(result.status === "success") {
                // éš¨æ©Ÿé¸ä¸€å€‹è©²è³åˆ¥çš„æ ¼å­åœä½ (è¦–è¦ºæ•ˆæœ)
                const targetLevel = result.results[0].split('è³')[0];
                showWin(result.results, result.remainingPoints);
            }
        } catch (e) { clearInterval(animation); state.isRunning = false; }
    }

    function startAnimation() {
        let current = 0;
        return setInterval(() => {
            document.querySelectorAll('.ticket').forEach(el => el.classList.remove('active'));
            // åªåœ¨é‚„æ²’è¢«æŠ½èµ°çš„æ ¼å­ä¸­è·³å‹•
            const availables = state.allTickets.map((t, i) => t.status === 'available' ? i : -1).filter(i => i !== -1);
            current = availables[Math.floor(Math.random() * availables.length)];
            document.getElementById(`t-${current}`).classList.add('active');
        }, 80);
    }

    function showWin(results, newPoints) {
        Swal.fire({
            title: 'ğŸŠ æ­å–œç²ç',
            html: `<b style="color:var(--kuji-red); font-size:1.5rem">${results.join('<br>')}</b>`,
            background: '#161625', color: '#fff', confirmButtonColor: '#e63946'
        }).then(() => {
            state.points = newPoints;
            state.isRunning = false;
            syncData();
        });
    }

    window.onload = init;
</script>
</body>
</html>
