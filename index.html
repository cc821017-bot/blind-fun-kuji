<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›²ç©æ¨‚-æŠ½çä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main-red: #ff3e3e; --neon-gold: #f1c40f; --bg-dark: #0f0f0f; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg-dark); color: #fff; text-align: center; margin: 0; padding-top: 80px; overflow-x: hidden; }
        
        /* é ‚éƒ¨å°èˆªæ¬„å„ªåŒ– */
        .user-info { position: fixed; top: 0; width: 100%; background: rgba(20,20,20,0.9); padding: 15px 0; z-index: 50; border-bottom: 2px solid var(--main-red); backdrop-filter: blur(10px); }
        
        /* çæ± é¸æ“‡å™¨ */
        .pool-selector { display: flex; justify-content: center; gap: 10px; margin: 20px 0; padding: 0 10px; }
        .pool-btn { flex: 1; padding: 12px 5px; background: #1a1a1a; border: 1px solid #333; color: #888; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        .pool-btn.active { border-color: var(--neon-gold); background: linear-gradient(180deg, #333, #000); color: var(--neon-gold); box-shadow: 0 0 10px rgba(241,196,15,0.3); }
        
        /* è©³ç´°åº«å­˜é¡¯ç¤º */
        .stock-info { background: #151515; width: 90%; margin: 10px auto; padding: 10px; border-radius: 8px; border: 1px dashed #333; display: flex; justify-content: space-around; font-size: 13px; }
        .stock-item b { color: var(--neon-gold); }

        .price-tag { color: var(--main-red); font-size: 1.8rem; margin: 15px 0; font-weight: 900; letter-spacing: 2px; }

        /* æŠ½çç®±å‹•ç•«å„ªåŒ– */
        .kuji-box { width: 280px; height: 180px; background: #222; border: 3px solid var(--main-red); color: white; margin: 20px auto; display: flex; align-items: center; justify-content: center; font-size: 30px; font-weight: 900; border-radius: 20px; cursor: pointer; position: relative; overflow: hidden; box-shadow: 0 0 20px rgba(255,62,62,0.2); }
        .kuji-box::before { content: ""; position: absolute; width: 100%; height: 100%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent); transform: translateX(-100%); transition: 0.5s; }
        .kuji-box:hover::before { transform: translateX(100%); }
        
        .drawing-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        .ticket-anim { width: 150px; animation: jump 0.5s infinite alternate; }
        @keyframes jump { from { transform: translateY(0); } to { transform: translateY(-20px); } }

        /* çµæœç•«é¢ */
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; flex-direction: column; align-items: center; justify-content: center; z-index: 300; }
        .prize-img { width: 320px; height: 320px; object-fit: cover; border: 5px solid var(--neon-gold); border-radius: 20px; box-shadow: 0 0 50px var(--neon-gold); }
    </style>
</head>
<body>

    <div class="user-info">
        <span id="user-name">è¾¨è­˜ä¸­...</span> | é¤˜é¡ï¼š<span id="user-points" style="color:var(--neon-gold)">0</span> P
    </div>

    <div class="pool-selector">
        <button class="pool-btn active" onclick="switchPool('å–®æŒ‘å¥—', this, 360)">å–®æŒ‘å¥—</button>
        <button class="pool-btn" onclick="switchPool('ï¼¡å€ä»»é¸', this, 280)">ï¼¡å€ä»»é¸</button>
        <button class="pool-btn" onclick="switchPool('ï¼¢å€ä»»é¸', this, 220)">ï¼¢å€ä»»é¸</button>
    </div>

    <div class="stock-info">
        <div class="stock-item">Aè³å‰©ï¼š<b id="stock-a">--</b></div>
        <div class="stock-item">Bè³å‰©ï¼š<b id="stock-b">--</b></div>
        <div class="stock-item">ç¸½å‰©é¤˜ï¼š<b id="stock-total">--</b></div>
    </div>

    <h2 id="currentPoolTitle">å–®æŒ‘å¥—</h2>
    <div class="price-tag"><span id="currentPrice">360</span> P / æŠ½</div>
    
    <div class="kuji-box" id="drawBtn" onclick="draw()">é»æ“Šé–‹ç</div>

    <div id="drawingAnim" class="drawing-layer">
        <img src="https://cdn-icons-png.flaticon.com/512/5900/5900355.png" class="ticket-anim">
        <h2 style="color:var(--neon-gold); margin-top:20px;">æ­£åœ¨æ’•é–‹æŠ½çåˆ¸...</h2>
    </div>

    <div id="result" class="overlay">
        <h2 style="color: var(--main-red); font-size: 2.5rem; margin: 0;">ğŸ‰ æ­å–œä¸­ç ğŸ‰</h2>
        <p id="p-grade" style="font-size: 120px; color: var(--neon-gold); margin: -10px 0; font-weight: 900; text-shadow: 0 0 20px var(--neon-gold);"></p>
        <img id="p-img" class="prize-img" src="">
        <p id="p-name" style="font-size: 20px; margin-top: 15px;"></p>
        <button style="margin-top:30px; padding: 15px 80px; background: var(--main-red); color: white; border: none; border-radius: 50px; font-size: 22px; font-weight: bold;" onclick="location.reload()">æ”¶ä¸‹çé …</button>
    </div>

    <script>
        const LIFF_ID = "2009072982-6smlV2gu";
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        
        let currentPoolId = "å–®æŒ‘å¥—";
        let currentUser = { uid: "", name: "" };
        let globalPoolStatus = {};

        const POOL_IMAGES = {
            "å–®æŒ‘å¥—": { "A": "https://i.postimg.cc/c49RLv8B/20260120-163208-488780-5-800x800.jpg", "B": "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg" },
            "ï¼¡å€ä»»é¸": { "A": "https://i.postimg.cc/9F4Y8B8g/S-9740517.jpg", "B": "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg" },
            "ï¼¢å€ä»»é¸": { "A": "https://i.postimg.cc/6pM0fDkC/S-9740516.jpg", "B": "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg" }
        };

        async function initLIFF() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); }
                else {
                    const profile = await liff.getProfile();
                    currentUser.uid = profile.userId;
                    currentUser.name = profile.displayName;
                    document.getElementById('user-name').innerText = currentUser.name;
                    refreshStatus();
                }
            } catch (err) { console.error(err); }
        }

        function refreshStatus() {
            const script = document.createElement('script');
            script.src = `${API_URL}?action=getPoolStatus&callback=updateUI`;
            document.body.appendChild(script);
            // é †ä¾¿è®€é»æ•¸
            const pScript = document.createElement('script');
            pScript.src = `${API_URL}?action=checkUser&uid=${currentUser.uid}&name=${encodeURIComponent(currentUser.name)}&callback=updatePoints`;
            document.body.appendChild(pScript);
        }

        window.updateUI = (data) => {
            globalPoolStatus = data;
            showStock(currentPoolId);
        };

        window.updatePoints = (data) => { document.getElementById('user-points').innerText = data.points; };

        function showStock(id) {
            const s = globalPoolStatus[id];
            if(s) {
                document.getElementById('stock-a').innerText = s.a;
                document.getElementById('stock-b').innerText = s.b;
                document.getElementById('stock-total').innerText = s.total;
            }
        }

        function switchPool(id, btn, price) {
            currentPoolId = id;
            document.querySelectorAll('.pool-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('currentPoolTitle').innerText = id;
            document.getElementById('currentPrice').innerText = price;
            showStock(id);
        }

        function draw() {
            if (window.navigator.vibrate) window.navigator.vibrate([50, 30, 50]);
            document.getElementById('drawingAnim').style.display = 'flex';
            
            const script = document.createElement('script');
            script.src = `${API_URL}?action=draw&uid=${currentUser.uid}&poolId=${encodeURIComponent(currentPoolId)}&callback=handleResult`;
            document.body.appendChild(script);
        }

        window.handleResult = (data) => {
            setTimeout(() => { // å¼·åˆ¶å»¶é² 1.5 ç§’è®“å‹•ç•«è·‘ä¸€ä¸‹ï¼Œå¢åŠ æœŸå¾…æ„Ÿ
                document.getElementById('drawingAnim').style.display = 'none';
                if (data.status === "success") {
                    document.getElementById('p-grade').innerText = data.grade;
                    document.getElementById('p-name').innerText = data.name;
                    document.getElementById('p-img').src = POOL_IMAGES[currentPoolId][data.grade] || POOL_IMAGES[currentPoolId]["B"];
                    document.getElementById('result').style.display = 'flex';
                } else {
                    alert(data.status === "no_points" ? "é»æ•¸ä¸è¶³ï¼" : "æ­¤æ± å·²å”®ç½„ï¼");
                    location.reload();
                }
            }, 1500);
        };
        window.onload = initLIFF;
    </script>
</body>
</html>
