<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>盲玩樂-抽獎中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; text-align: center; margin: 0; padding-top: 60px; }
        .user-info { position: fixed; top: 0; width: 100%; background: #111; padding: 12px 0; border-bottom: 2px solid red; z-index: 200; font-size: 14px; }
        .pool-selector { display: flex; justify-content: center; gap: 5px; padding: 10px; margin-top: 10px; }
        .pool-btn { flex: 1; padding: 12px 5px; background: #333; border: 1px solid #555; color: #fff; border-radius: 8px; font-weight: bold; cursor: pointer; }
        .pool-btn.active { background: red; border-color: gold; }
        
        /* 預覽視窗：強制三張圖疊在一起 */
        .preview-window { width: 90%; max-width: 350px; margin: 15px auto; border: 2px solid #444; height: 220px; background: #111; position: relative; overflow: hidden; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; display: none; }
        .preview-img.show { display: block; } /* 只有帶 show 的才會顯示 */

        .status-bar { color: gold; font-size: 15px; margin: 10px 0; font-weight: bold; height: 20px; }
        .draw-btn { width: 260px; height: 65px; background: red; color: #fff; margin: 20px auto; display: flex; align-items: center; justify-content: center; border-radius: 40px; font-weight: bold; font-size: 24px; box-shadow: 0 5px 15px rgba(255,0,0,0.4); }
        
        #tearLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 500; align-items: center; justify-content: center; color: white; font-size: 30px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 600; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="user-info">點數餘額：<span id="user-points">載入中</span> P</div>
    
    <div class="pool-selector">
        <button class="pool-btn active" onclick="clickPool(0, this)">單挑套</button>
        <button class="pool-btn" onclick="clickPool(1, this)">Ａ區任選</button>
        <button class="pool-btn" onclick="clickPool(2, this)">Ｂ區任選</button>
    </div>

    <div class="preview-window">
        <img id="img-0" class="preview-img show" src="https://i.postimg.cc/c49RLv8B/20260120-163208-488780-5-800x800.jpg">
        <img id="img-1" class="preview-img" src="https://i.postimg.cc/9F4Y8B8g/S-9740517.jpg">
        <img id="img-2" class="preview-img" src="https://i.postimg.cc/6pM0fDkC/S-9740516.jpg">
    </div>

    <div id="status-msg" class="status-bar">準備就緒</div>
    <div class="draw-btn" onclick="startDraw()">點擊開獎</div>

    <div id="tearLayer">盲玩樂 - 抽獎中...</div>

    <div id="result" class="overlay">
        <h1 id="res-grade" style="font-size: 100px; color: gold; margin: 0;"></h1>
        <img id="res-img" style="width: 300px; height: 300px; border: 3px solid gold; border-radius: 15px;" src="">
        <p id="res-name" style="margin: 20px; font-size: 20px; font-weight: bold;"></p>
        <button onclick="location.reload()" style="padding: 12px 60px; background: white; border-radius: 50px; font-weight: bold;">確認領取</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const NAMES = ["單挑套", "Ａ區任選", "Ｂ區任選"];
        const B_IMG = "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg";
        
        let curIdx = 0;
        let userData = { uid: "", name: "" };
        let allStocks = {};

        // 核心切換：改用物理顯示隱藏 (display: none/block)
        function clickPool(i, btn) {
            curIdx = i;
            // 1. 按鈕樣式
            const btns = document.querySelectorAll('.pool-btn');
            btns.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            // 2. 圖片切換 (強制移除所有 show，只給當前顯示)
            const imgs = document.querySelectorAll('.preview-img');
            imgs.forEach(img => img.classList.remove('show'));
            document.getElementById('img-' + i).classList.add('show');
            
            updateText();
        }

        function updateText() {
            const name = NAMES[curIdx];
            if (allStocks[name]) {
                document.getElementById('status-msg').innerText = `A：${allStocks[name].a} | B：${allStocks[name].b} | 剩：${allStocks[name].total}`;
            }
        }

        async function initLiff() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                userData.uid = profile.userId;
                userData.name = profile.displayName;
                refreshData();
            } catch (e) {
                document.getElementById('status-msg').innerText = "連線失敗";
            }
        }

        function refreshData() {
            const s1 = document.createElement('script');
            s1.src = `${API_URL}?action=getPoolStatus&callback=gotStocks`;
            document.body.appendChild(s1);
            const s2 = document.createElement('script');
            s2.src = `${API_URL}?action=checkUser&uid=${userData.uid}&name=${encodeURIComponent(userData.name)}&callback=gotPoints`;
            document.body.appendChild(s2);
        }

        window.gotStocks = (res) => { allStocks = res; updateText(); };
        window.gotPoints = (res) => { document.getElementById('user-points').innerText = res.points; };

        function startDraw() {
            if(!userData.uid) return;
            document.getElementById('tearLayer').style.display = 'flex';
            const s = document.createElement('script');
            s.src = `${API_URL}?action=draw&uid=${userData.uid}&poolId=${encodeURIComponent(NAMES[curIdx])}&callback=showResult`;
            document.body.appendChild(s);
        }

        window.showResult = (res) => {
            if (res.status === "success") {
                setTimeout(() => {
                    document.getElementById('res-grade').innerText = res.grade;
                    document.getElementById('res-name').innerText = res.name;
                    // 結果圖：直接從已經加載好的預覽圖中抓取網址
                    document.getElementById('res-img').src = (res.grade === "A" ? document.getElementById('img-'+curIdx).src : B_IMG);
                    document.getElementById('result').style.display = 'flex';
                }, 1000);
            } else {
                alert("錯誤：點數不足或系統忙碌");
                location.reload();
            }
        }
        window.onload = initLiff;
    </script>
</body>
</html>
