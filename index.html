<script>
    const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
    
    const PRIZE_IMAGES = {
        "A": "https://i.postimg.cc/c49RLv8B/20260120-163208-488780-5-800x800.jpg",
        "B": "https://i.postimg.cc/X7p8FK3S/20260120-163208-538718-3-800x800.jpg",
        "C": "https://i.postimg.cc/0jNCVDwq/20260120-163208-008820-2-800x800.jpg",
        "D": "https://i.postimg.cc/cCjfTjW8/20260120-163211-555418-6-800x800.jpg"
    };

    async function draw() {
        const btn = document.getElementById('drawBtn');
        const status = document.getElementById('status');
        
        // 1. 立刻進入視覺動畫（減少體感等待）
        btn.classList.add('shake');
        btn.innerText = "正在搖出獎項...";
        btn.style.pointerEvents = "none";
        status.innerText = "正在連線盲玩樂後台...";

        try {
            // 2. 同步發送抽獎請求（不等待它結束，我們先跑動畫）
            const startTime = Date.now();
            
            // 使用更輕量化的請求
            const fetchPromise = fetch(API_URL, { method: 'POST', mode: 'no-cors' });
            
            // 3. 固定等待 2 秒（讓動畫跑完，也讓 Google 有時間寫入）
            setTimeout(async () => {
                try {
                    const response = await fetch(API_URL + "?t=" + Date.now());
                    const data = await response.json();
                    
                    if (data && data.length > 0) {
                        const win = data[0];
                        document.getElementById('p-grade').innerText = win.grade;
                        document.getElementById('p-name').innerText = win.name;
                        document.getElementById('p-img').src = PRIZE_IMAGES[win.grade] || "";
                        
                        // 關閉動畫，顯示結果
                        btn.classList.remove('shake');
                        document.getElementById('result').style.display = 'flex';
                    }
                } catch (err) {
                    console.error("讀取失敗", err);
                    alert("抽獎完成，請重新整理確認結果！");
                }
            }, 2000); // 這裡控制動畫長度

        } catch (e) {
            alert("網路連線較慢，請重試！");
            location.reload();
        }
    }
</script>
