<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>盲玩樂-抽獎中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; text-align: center; margin: 0; padding-top: 60px; }
        .user-info { position: fixed; top: 0; width: 100%; background: #111; padding: 10px 0; border-bottom: 2px solid red; z-index: 100; }
        .pool-selector { display: flex; justify-content: center; gap: 5px; padding: 10px; }
        .pool-btn { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; }
        .pool-btn.active { background: red; border-color: gold; }
        .preview-window { width: 90%; max-width: 350px; margin: 10px auto; border: 1px solid #333; height: 200px; overflow: hidden; background: #111; }
        .preview-img { width: 100%; height: 100%; object-fit: contain; }
        .draw-btn { width: 250px; height: 60px; background: red; color: #fff; margin: 20px auto; display: flex; align-items: center; justify-content: center; border-radius: 30px; font-weight: bold; font-size: 20px; }
        #tearLayer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 500; align-items: center; justify-content: center; }
        .ticket { position: relative; width: 250px; height: 350px; background: red; border: 4px solid #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 30px; transition: 0.6s; }
        .is-tearing { transform: scale(0); opacity: 0; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 600; flex-direction: column; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="user-info">點數：<span id="user-points">--</span></div>
    
    <div class="pool-selector">
        <button class="pool-btn active" onclick="sel(0)">單挑套</button>
        <button class="pool-btn" onclick="sel(1)">Ａ區任選</button>
        <button class="pool-btn" onclick="sel(2)">Ｂ區任選</button>
    </div>

    <div class="preview-window">
        <img id="p-view" class="preview-img" src="https://i.postimg.cc/c49RLv8B/20260120-163208-488780-5-800x800.jpg">
    </div>

    <div id="stock-text">載入中...</div>
    <div class="draw-btn" onclick="draw()">點擊開獎</div>

    <div id="tearLayer"><div id="t-box" class="ticket">盲玩樂</div></div>

    <div id="result" class="overlay">
        <h1 id="r-grade" style="font-size: 80px; color: gold; margin: 0;"></h1>
        <img id="r-img" style="width: 280px; height: 280px; border-radius: 10px;" src="">
        <p id="r-name"></p>
        <button onclick="location.reload()" style="padding: 10px 40px;">確認</button>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const IMGS = [
            "https://i.postimg.cc/c49RLv8B/20260120-163208-488780-5-800x800.jpg",
            "https://i.postimg.cc/9F4Y8B8g/S-9740517.jpg",
            "https://i.postimg.cc/6pM0fDkC/S-9740516.jpg"
        ];
        const B_PRIZE = "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg";
        const NAMES = ["單挑套", "Ａ區任選", "Ｂ區任選"];
        
        let curIdx = 0;
        let u = { uid: "", name: "" };
        let st = {};

        async function init() {
            await liff.init({ liffId: "2009072982-6smlV2gu" });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const p = await liff.getProfile();
            u.uid = p.userId; u.name = p.displayName;
            sel(0); refresh();
        }

        function refresh() {
            const s1 = document.createElement('script');
            s1.src = `${API}?action=getPoolStatus&callback=cb_st`;
            const s2 = document.createElement('script');
            s2.src = `${API}?action=checkUser&uid=${u.uid}&name=${encodeURIComponent(u.name)}&callback=cb_pt`;
            document.body.appendChild(s1); document.body.appendChild(s2);
        }

        window.cb_st = (d) => { st = d; update(); };
        window.cb_pt = (d) => { document.getElementById('user-points').innerText = d.points; };

        function sel(i) {
            curIdx = i;
            document.querySelectorAll('.pool-btn').forEach((b, idx) => b.classList.toggle('active', i === idx));
            document.getElementById('p-view').src = IMGS[i];
            update();
        }

        function update() {
            const n = NAMES[curIdx];
            if (st[n]) document.getElementById('stock-text').innerText = `A：${st[n].a} | B：${st[n].b} | 總：${st[n].total}`;
        }

        function draw() {
            document.getElementById('tearLayer').style.display = 'flex';
            const s = document.createElement('script');
            s.src = `${API}?action=draw&uid=${u.uid}&poolId=${encodeURIComponent(NAMES[curIdx])}&callback=cb_res`;
            document.body.appendChild(s);
        }

        window.cb_res = (d) => {
            if (d.status === "success") {
                document.getElementById('t-box').classList.add('is-tearing');
                setTimeout(() => {
                    document.getElementById('r-grade').innerText = d.grade;
                    document.getElementById('r-name').innerText = d.name;
                    document.getElementById('r-img').src = (d.grade === "A") ? IMGS[curIdx] : B_PRIZE;
                    document.getElementById('result').style.display = 'flex';
                }, 800);
            } else {
                alert("點數不足或系統錯誤");
                location.reload();
            }
        }
        window.onload = init;
    </script>
</body>
</html>
