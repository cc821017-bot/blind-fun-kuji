<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>盲玩樂-40席旗艦抽獎中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --red: #ff3e3e; --gold: #f1c40f; --dark: #050505; --off: #222; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; text-align: center; margin: 0; padding-top: 60px; overflow: hidden; }
        .user-bar { position: fixed; top: 0; width: 100%; background: #111; padding: 12px 0; border-bottom: 2px solid var(--red); z-index: 1000; font-weight: bold; }
        
        /* 獎池切換 */
        .pool-tabs { display: flex; justify-content: center; gap: 5px; padding: 10px; }
        .tab-btn { flex: 1; padding: 10px 5px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 12px; }
        .tab-btn.active { background: var(--red); color: white; border-color: var(--gold); }

        /* 核心：40燈大轉盤佈置 (11x11 Grid) */
        .game-container { 
            width: 95vw; height: 95vw; max-width: 400px; max-height: 400px; 
            margin: 10px auto; position: relative; background: #111; border: 4px solid #333; border-radius: 15px;
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 2px; padding: 4px;
        }
        
        /* 中間顯示區 */
        .center-display { 
            grid-area: 3 / 3 / 10 / 10; background: #000; border-radius: 10px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .center-img { width: 80%; height: 80%; object-fit: contain; }

        /* 燈號基礎樣式 */
        .lamp { 
            background: #333; border-radius: 2px; font-size: 8px; 
            display: flex; align-items: center; justify-content: center; color: #555;
        }
        .lamp.is-a { color: var(--gold); border: 1px solid #444; }
        .lamp.off { background: #111 !important; color: #000 !important; border: none !important; } /* 熄燈狀態 */
        .lamp.active { 
            background: var(--red) !important; color: white !important; 
            box-shadow: 0 0 10px var(--red); z-index: 10;
        }
        .lamp.active-gold { 
            background: var(--gold) !important; color: #000 !important; 
            box-shadow: 0 0 15px var(--gold); z-index: 10;
        }

        /* 底部資訊 */
        .info-panel { margin: 10px 0; color: var(--gold); font-weight: bold; font-size: 14px; }
        .btn-group { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .draw-btn { width: 120px; height: 50px; border-radius: 25px; border: none; font-weight: bold; color: #fff; cursor: pointer; }

        /* 中獎彈窗 */
        .win-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>
    <div class="user-bar">餘額：<span id="display-pts">----</span> P</div>
    
    <div class="pool-tabs">
        <button id="btn0" class="tab-btn active" onclick="switchTo(0)">單挑套</button>
        <button id="btn1" class="tab-btn" onclick="switchTo(1)">Ａ區任選</button>
        <button id="btn2" class="tab-btn" onclick="switchTo(2)">Ｂ區任選</button>
    </div>

    <div class="game-container" id="game-board">
        <div class="center-display">
            <img id="main-preview" class="center-img" src="https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480">
            <div id="anim-status" style="margin-top:10px; color:var(--red); font-size:12px;"></div>
        </div>
        </div>

    <div class="info-panel" id="stock-info">同步中...</div>

    <div class="btn-group">
        <button class="draw-btn" style="background:#444;" id="btn-s" onclick="goDraw(1)">單抽</button>
        <button class="draw-btn" style="background:var(--red);" id="btn-m" onclick="goDraw(5)">五連抽</button>
    </div>

    <div id="winPanel" class="win-overlay">
        <h2 style="color:var(--gold); font-size:30px;">恭喜獲得</h2>
        <div id="res-list" style="width:90%; max-height:60vh; overflow-y:auto;"></div>
        <button onclick="location.reload()" style="margin-top:20px; padding: 12px 60px; border-radius: 30px; border:none; font-weight:bold;">確認</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const POOLS = ["單挑套", "Ａ區任選", "Ｂ區任選"];
        const PREVIEWS = [
            "https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480",
            "https://i.meee.com.tw/d2cFJiy.jpg",
            "https://i.meee.com.tw/B8xVcyj.jpg"
        ];
        
        // 定義環繞 40 個格子的 Grid 座標 (11x11 外圈)
        const LAMP_COORDS = [];
        for(let i=1; i<=11; i++) LAMP_COORDS.push({r: 1, c: i}); // 上
        for(let i=2; i<=11; i++) LAMP_COORDS.push({r: i, c: 11}); // 右
        for(let i=10; i>=1; i--) LAMP_COORDS.push({r: 11, c: i}); // 下
        for(let i=10; i>=2; i--) LAMP_COORDS.push({r: i, c: 1}); // 左

        let currentIdx = 0, myUid = "", stockData = {};

        // 初始化 40 個燈
        function initBoard() {
            const board = document.getElementById('game-board');
            // 清除舊燈
            document.querySelectorAll('.lamp').forEach(l => l.remove());
            
            LAMP_COORDS.forEach((pos, i) => {
                const div = document.createElement('div');
                div.className = 'lamp';
                div.id = 'lamp-' + i;
                div.style.gridRow = pos.r;
                div.style.gridColumn = pos.c;
                div.innerText = i + 1;
                board.appendChild(div);
            });
        }

        function switchTo(idx) {
            currentIdx = idx;
            document.getElementById('main-preview').src = PREVIEWS[idx];
            document.querySelectorAll('.tab-btn').forEach((b, i) => b.className = (i===idx)?'tab-btn active':'tab-btn');
            updateUI();
        }

        function updateUI() {
            const data = stockData[POOLS[currentIdx]];
            if(!data) return;
            document.getElementById('stock-info').innerText = `A：${data.a} | B：${data.b} | 剩餘：${data.total}`;
            
            // 熄燈邏輯：假設從後端拿到的 data.total 是剩餘張數
            // 這裡為了演示，我們簡單模擬，實務上需從後端回傳「哪些號碼已抽」
            const soldCount = 40 - data.total;
            for(let i=0; i<40; i++) {
                const el = document.getElementById('lamp-' + i);
                if(i < soldCount) el.classList.add('off'); // 簡單熄掉前面的燈
                else el.classList.remove('off');
            }
        }

        async function initLIFF() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                myUid = profile.userId;
                
                const s1 = document.createElement('script');
                s1.src = `${API_URL}?action=getPoolStatus&callback=cb_st`;
                document.body.appendChild(s1);
                const s2 = document.createElement('script');
                s2.src = `${API_URL}?action=checkUser&uid=${myUid}&name=${encodeURIComponent(profile.displayName)}&callback=cb_pt`;
                document.body.appendChild(s2);
            } catch (e) {}
        }

        window.cb_st = (res) => { stockData = res; updateUI(); };
        window.cb_pt = (res) => { document.getElementById('display-pts').innerText = res.points; };

        function goDraw(count) {
            if(!myUid) return;
            document.getElementById('btn-s').disabled = true;
            document.getElementById('btn-m').disabled = true;
            
            const s = document.createElement('script');
            s.src = `${API_URL}?action=draw&uid=${myUid}&poolId=${encodeURIComponent(POOLS[currentIdx])}&count=${count}&callback=cb_res`;
            document.body.appendChild(s);
            
            runMarquee(count);
        }

        let isRunning = false;
        function runMarquee(count) {
            isRunning = true;
            let steps = 0;
            const pointers = Array.from({length: count}, (_, i) => i * 2); // 初始分散
            
            const interval = setInterval(() => {
                if(!isRunning) { clearInterval(interval); return; }
                
                document.querySelectorAll('.lamp').forEach(l => l.classList.remove('active', 'active-gold'));
                
                pointers.forEach((p, i) => {
                    pointers[i] = (p + 1) % 40;
                    const el = document.getElementById('lamp-' + pointers[i]);
                    if(!el.classList.contains('off')) el.classList.add('active');
                });
                
                steps++;
            }, 80);

            window.stopAnim = (results) => {
                isRunning = false;
                clearInterval(interval);
                showWin(results);
            };
        }

        window.cb_res = (res) => {
            if(res.status === 'success') {
                setTimeout(() => window.stopAnim(res.results), 2000);
            } else {
                alert(res.message);
                location.reload();
            }
        };

        function showWin(results) {
            const list = document.getElementById('res-list');
            list.innerHTML = "";
            results.forEach(r => {
                const div = document.createElement('div');
                div.style.background = "#222"; div.style.margin = "10px"; div.style.padding = "15px"; div.style.borderRadius = "10px";
                div.style.borderLeft = (r.grade === 'A') ? "5px solid var(--gold)" : "5px solid var(--red)";
                div.innerHTML = `<b style="color:${r.grade==='A'?'var(--gold)':'white'}">${r.grade}賞</b><br>${r.name}`;
                list.appendChild(div);
            });
            document.getElementById('winPanel').style.display = 'flex';
        }

        initBoard();
        initLIFF();
    </script>
</body>
</html>
