<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>盲玩樂-旗艦抽獎中心</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --main-red: #ff3e3e; --neon-gold: #f1c40f; --bg-dark: #050505; --card-bg: #1a1a1a; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg-dark); color: #fff; text-align: center; margin: 0; padding-top: 60px; overflow-x: hidden; }
        
        /* UI 質感升級：頂部與背景 */
        .user-bar { position: fixed; top: 0; width: 100%; background: rgba(20,20,20,0.95); backdrop-filter: blur(10px); padding: 12px 0; border-bottom: 2px solid var(--main-red); z-index: 1000; font-weight: bold; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        
        /* 獎池切換 */
        .pool-tabs { display: flex; justify-content: center; gap: 8px; padding: 15px; }
        .tab-btn { flex: 1; padding: 12px 5px; background: #252525; border: 1px solid #444; color: #888; border-radius: 12px; font-weight: bold; cursor: pointer; transition: 0.3s; font-size: 14px; }
        .tab-btn.active { background: linear-gradient(145deg, #ff5e5e, var(--main-red)); border-color: var(--neon-gold); color: white; box-shadow: 0 0 15px rgba(255,62,62,0.6); transform: translateY(-2px); }

        /* 櫥窗優化：玻璃質感與光影 */
        .display-window { 
            width: 92%; max-width: 380px; margin: 10px auto; border: 2px solid #333; height: 260px; 
            background: #000; position: relative; overflow: hidden; border-radius: 20px;
            box-shadow: inset 0 0 30px rgba(255,255,255,0.05), 0 10px 30px rgba(0,0,0,0.8);
        }
        .display-window::after { /* 玻璃反光 */
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent 45%, rgba(255,255,255,0.05) 50%, transparent 55%);
            animation: shine 5s infinite; pointer-events: none;
        }
        @keyframes shine { 0% { transform: translateX(-30%); } 100% { transform: translateX(30%); } }
        
        .prize-img { width: 100%; height: 100%; object-fit: cover; object-position: center top; position: absolute; top: 0; left: 0; display: none; }
        .prize-img.show { display: block !important; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* 庫存進度條 */
        .stock-container { width: 85%; margin: 10px auto; text-align: left; }
        .stock-info { display: flex; justify-content: space-between; font-size: 14px; color: var(--neon-gold); margin-bottom: 5px; font-weight: bold; }
        .progress-bg { width: 100%; height: 8px; background: #333; border-radius: 10px; overflow: hidden; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff3e3e, #f1c40f); transition: width 1s ease-in-out; }

        /* 按鈕區 */
        .btn-group { display: flex; justify-content: center; gap: 15px; margin: 20px auto; }
        .draw-btn { 
            width: 140px; height: 55px; border-radius: 30px; border: none; font-weight: bold; font-size: 18px; cursor: pointer; transition: 0.2s; color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .single-btn { background: #333; border: 1px solid #555; }
        .multi-btn { background: linear-gradient(180deg, #ff5e5e, var(--main-red)); box-shadow: 0 5px 15px rgba(255,62,62,0.4); }
        .draw-btn:active { transform: scale(0.92); }

        /* 開獎儀式層 (撕獎券) */
        #draw-anim { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); 
            z-index: 4000; align-items: center; justify-content: center; flex-direction: column;
        }
        .ticket { width: 200px; height: 100px; background: var(--main-red); border: 4px dashed #fff; display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; animation: shake 0.2s infinite; }
        @keyframes shake { 0% { transform: rotate(2deg); } 100% { transform: rotate(-2deg); } }

        /* 中獎彈窗優化 */
        .win-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px 0; }
        .win-card { background: #222; padding: 20px; border-radius: 20px; border: 2px solid var(--neon-gold); width: 85%; max-width: 350px; }
        .win-img { width: 100%; border-radius: 15px; margin: 15px 0; object-fit: contain; background: #000; height: 250px; }
        .multi-res-container { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; margin-top: 10px; }
        .multi-item { background: #333; padding: 10px; border-radius: 10px; font-size: 12px; border-left: 4px solid var(--main-red); }
    </style>
</head>
<body>
    <div class="user-bar">餘額：<span id="display-pts">...</span> P</div>
    
    <div class="pool-tabs">
        <button id="btn0" class="tab-btn active" onclick="physicalSwitch(0)">單挑套</button>
        <button id="btn1" class="tab-btn" onclick="physicalSwitch(1)">Ａ區任選</button>
        <button id="btn2" class="tab-btn" onclick="physicalSwitch(2)">Ｂ區任選</button>
    </div>

    <div class="display-window">
        <img id="img0" class="prize-img show" src="https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480">
        <img id="img1" class="prize-img" src="https://i.meee.com.tw/d2cFJiy.jpg">
        <img id="img2" class="prize-img" src="https://i.meee.com.tw/B8xVcyj.jpg">
    </div>

    <div class="stock-container">
        <div class="stock-info">
            <span id="stock-text">獎池載入中...</span>
            <span id="stock-percent">0%</span>
        </div>
        <div class="progress-bg"><div id="stock-bar" class="progress-bar"></div></div>
    </div>

    <div class="btn-group">
        <button class="draw-btn single-btn" onclick="goDraw(1)">單抽</button>
        <button class="draw-btn multi-btn" onclick="goDraw(5)">五連抽</button>
    </div>

    <div id="draw-anim">
        <div class="ticket">撕開獎券中...</div>
        <p style="margin-top:20px; color: var(--neon-gold);">好運降臨！！</p>
    </div>

    <div id="winPanel" class="win-overlay">
        <div class="win-card" id="singleWin">
            <h2 id="win-grade" style="font-size: 60px; color: var(--neon-gold); margin: 0;">A</h2>
            <img id="win-img" class="win-img" src="">
            <p id="win-name" style="font-weight: bold;"></p>
        </div>
        <div class="multi-res-container" id="multiWin" style="display:none;"></div>
        <button onclick="location.reload()" style="margin-top:20px; padding: 15px 60px; border-radius: 50px; background: #fff; font-weight: bold; border: none; cursor: pointer;">確認收下</button>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const POOLS = ["單挑套", "Ａ區任選", "Ｂ區任選"];
        const B_IMG_URL = "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg";
        
        let currentIdx = 0;
        let myUid = "";
        let stockData = {};

        function physicalSwitch(idx) {
            currentIdx = idx;
            document.querySelectorAll('.prize-img').forEach(img => { img.classList.remove('show'); img.style.display = 'none'; });
            for(let i=0; i<3; i++) { if(document.getElementById('btn'+i)) document.getElementById('btn'+i).className = (i===idx)?'tab-btn active':'tab-btn'; }
            const target = document.getElementById('img'+idx);
            if(target) { target.style.display = 'block'; target.classList.add('show'); }
            updateStockUI();
        }

        function updateStockUI() {
            const data = stockData[POOLS[currentIdx]];
            if (data) {
                const total = parseInt(data.total);
                // 假設初始滿包為 80 張（老闆可自行修改基數）
                const percent = Math.min(100, (total / 80) * 100);
                document.getElementById('stock-text').innerText = `A賞：${data.a} | B賞：${data.b} | 剩餘：${total}張`;
                document.getElementById('stock-percent').innerText = Math.floor(percent) + "%";
                document.getElementById('stock-bar').style.width = percent + "%";
            }
        }

        async function init() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                myUid = profile.userId;
                fetchData();
            } catch (e) {}
        }

        function fetchData() {
            const s1 = document.createElement('script');
            s1.src = `${API_URL}?action=getPoolStatus&callback=cb_st`;
            const s2 = document.createElement('script');
            s2.src = `${API_URL}?action=checkUser&uid=${myUid}&callback=cb_pt`;
            document.body.appendChild(s1); document.body.appendChild(s2);
        }

        window.cb_st = (res) => { stockData = res; physicalSwitch(currentIdx); };
        window.cb_pt = (res) => { document.getElementById('display-pts').innerText = res.points; };

        function goDraw(count) {
            if(!myUid) return;
            // 顯示開獎動畫
            document.getElementById('draw-anim').style.display = 'flex';
            
            setTimeout(() => {
                const s = document.createElement('script');
                // 修改 API 調用，增加 count 參數
                s.src = `${API_URL}?action=draw&uid=${myUid}&poolId=${encodeURIComponent(POOLS[currentIdx])}&count=${count}&callback=cb_res`;
                document.body.appendChild(s);
            }, 1200); // 模擬撕票 1.2 秒
        }

        window.cb_res = (res) => {
            document.getElementById('draw-anim').style.display = 'none';
            if (res.status === "success") {
                const results = res.results || [res]; // 相容單抽與多抽回傳
                if (results.length === 1) {
                    // 單抽顯示
                    document.getElementById('singleWin').style.display = 'block';
                    document.getElementById('multiWin').style.display = 'none';
                    document.getElementById('win-grade').innerText = results[0].grade;
                    document.getElementById('win-name').innerText = results[0].name;
                    document.getElementById('win-img').src = (results[0].grade === "A" ? document.getElementById('img'+currentIdx).src : B_IMG_URL);
                } else {
                    // 多抽顯示
                    document.getElementById('singleWin').style.display = 'none';
                    document.getElementById('multiWin').style.display = 'grid';
                    let html = '';
                    results.forEach(r => {
                        html += `<div class="multi-item"><b style="color:${r.grade==='A'?'gold':'white'}">${r.grade}賞</b><br>${r.name}</div>`;
                    });
                    document.getElementById('multiWin').innerHTML = html;
                }
                document.getElementById('winPanel').style.display = 'flex';
            } else { alert(res.message || "點數不足！"); location.reload(); }
        }

        window.onload = init;
        window.switchTo = physicalSwitch;
    </script>
</body>
</html>
