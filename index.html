<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>盲玩樂系統</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --bg: #0f0f1a; --gold: #ffcc00; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
        .loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-top: 20px; }
        .ticket { aspect-ratio: 1/1; background: #2d2d44; border: 1px solid #444; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .ticket.taken { opacity: 0.2; pointer-events: none; background: #000; }
        .ticket.selected { background: var(--gold); color: #000; }
        .header { background: #1a1a2e; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
        .btn-draw { position: fixed; bottom: 30px; left: 10%; width: 80%; background: #ff4d4d; color: #fff; border: none; padding: 15px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; display: none; }
    </style>
</head>
<body>

<div id="loader" class="loading-screen">
    <div id="load-msg">正在初始化 LIFF...</div>
</div>

<div class="header">
    <div>玩家: <span id="u-name">載入中...</span></div>
    <div style="color:var(--gold); font-size: 1.5rem; margin-top:10px;"><span id="u-pts">0</span> PTS</div>
</div>

<div id="main-grid" class="grid"></div>
<button id="drawBtn" class="btn-draw" onclick="handleDraw()">確認開籤 (<span id="sel-count">0</span>)</button>

<script>
    const CONFIG = {
        // 1. 確保這裡的網址後面有 /exec
        GAS_URL: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec",
        LIFF_ID: "2009072982-6smlV2gu"
    };

    let state = { uid: "", mode: "單挑套", tickets: [], cost: 0, points: 0, selected: [] };

    // 初始化程式
    window.onload = async () => {
        try {
            document.getElementById('load-msg').innerText = "步驟 1: 啟動 LIFF...";
            await liff.init({ liffId: CONFIG.LIFF_ID });
            
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }

            document.getElementById('load-msg').innerText = "步驟 2: 獲取身分...";
            const profile = await liff.getProfile();
            state.uid = profile.userId;
            document.getElementById('u-name').innerText = profile.displayName;

            document.getElementById('load-msg').innerText = "步驟 3: 從試算表抓取資料...";
            await syncData();

        } catch (err) {
            document.getElementById('load-msg').innerHTML = `<b style="color:red">出錯了！</b><br>${err.message}`;
            console.error(err);
        }
    };

    async function syncData() {
        try {
            const res = await fetch(`${CONFIG.GAS_URL}?uid=${state.uid}&mode=${encodeURIComponent(state.mode)}&t=${Date.now()}`);
            if (!res.ok) throw new Error("網路連線不穩定");
            
            const data = await res.json();
            if (data.status === "success") {
                state.tickets = data.tickets;
                state.cost = data.cost;
                state.points = data.userPoints;
                
                document.getElementById('u-pts').innerText = state.points.toLocaleString();
                renderGrid();
                document.getElementById('loader').style.display = 'none';
            } else {
                throw new Error(data.message);
            }
        } catch (err) {
            document.getElementById('load-msg').innerHTML = `<b style="color:red">抓取資料失敗</b><br>${err.message}<br><button onclick="location.reload()">重試</button>`;
        }
    }

    function renderGrid() {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = state.tickets.map(t => `
            <div id="t-${t.id}" class="ticket ${t.isTaken ? 'taken' : ''}" onclick="${t.isTaken ? '' : `selectTicket('${t.id}')`}">
                ${t.isTaken ? '✘' : t.id}
            </div>
        `).join('');
    }

    function selectTicket(tid) {
        const idx = state.selected.indexOf(tid);
        const el = document.getElementById(`t-${tid}`);
        if (idx > -1) {
            state.selected.splice(idx, 1);
            el.classList.remove('selected');
        } else {
            state.selected.push(tid);
            el.classList.add('selected');
        }
        const btn = document.getElementById('drawBtn');
        btn.style.display = state.selected.length > 0 ? 'block' : 'none';
        document.getElementById('sel-count').innerText = state.selected.length;
    }

    async function handleDraw() {
        const total = state.selected.length * state.cost;
        if (state.points < total) {
            Swal.fire("點數不足", `需要 ${total} P`, "error");
            return;
        }

        document.getElementById('loader').style.display = 'flex';
        document.getElementById('load-msg').innerText = "通訊中，請勿關閉...";

        try {
            const res = await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ uid: state.uid, mode: state.mode, ticketIds: state.selected })
            });
            const result = await res.json();
            
            if (result.status === "success") {
                await Swal.fire("恭喜中獎", result.results.map(r => r.name).join('<br>'), "success");
                state.selected = [];
                await syncData();
            } else {
                throw new Error(result.message);
            }
        } catch (err) {
            Swal.fire("錯誤", err.message, "error");
        } finally {
            document.getElementById('loader').style.display = 'none';
        }
    }
</script>

</body>
</html>
