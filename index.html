<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚-å°ç‘ªè‰æŠ½ç</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --red: #ff3e3e; --gold: #f1c40f; --dark: #050505; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .user-info { margin-bottom: 20px; font-size: 18px; font-weight: bold; }
        .pts-box { color: var(--gold); border: 1px solid var(--gold); padding: 5px 15px; border-radius: 20px; }
        .board { 
            width: 90vw; height: 90vw; max-width: 380px; max-height: 380px; 
            display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); 
            gap: 2px; background: #000; border: 4px solid #333; border-radius: 15px; padding: 5px; 
        }
        .lamp { background: #222; border-radius: 2px; font-size: 10px; display: flex; align-items: center; justify-content: center; color: #444; }
        .active { background: var(--red) !important; color: #fff !important; box-shadow: 0 0 15px var(--red); z-index: 5; }
        .footer { margin-top: 30px; }
        .btn-draw { 
            width: 150px; height: 50px; border-radius: 25px; border: none; 
            background: var(--red); color: #fff; font-size: 18px; font-weight: bold; cursor: pointer; 
        }
        .btn-draw:disabled { background: #555; cursor: not-allowed; }
        .overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; 
        }
        .res-box { background: #222; padding: 15px; border-radius: 10px; border-left: 5px solid var(--red); margin: 5px; width: 80%; text-align: left; }
    </style>
</head>
<body>
    <div class="user-info">
        <span id="u-name">Loading...</span> | <span class="pts-box">é»æ•¸ï¼š<span id="pts">--</span> P</span>
    </div>

    <div class="board" id="board"></div>

    <div class="footer">
        <button class="btn-draw" id="drawBtn" onclick="draw(1)">å–®æŠ½ä¸€æ¬¡</button>
    </div>

    <div id="win-overlay" class="overlay">
        <h2 style="color:var(--gold)">ğŸ‰ æ­å–œä¸­ç</h2>
        <div id="result-list" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
        <button onclick="location.reload()" style="margin-top:20px; padding:10px 30px; border-radius:20px; border:none; background:#fff;">ç¢ºèªè¿”å›</button>
    </div>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        let uid = "", userName = "", isAnim = false, finalRes = null;
        const coords = [];
        // å»ºç«‹å°ç‘ªè‰è·¯å¾‘ (å››å‘¨)
        for(let i=1;i<=11;i++) coords.push({r:1,c:i});
        for(let i=2;i<=11;i++) coords.push({r:i,c:11});
        for(let i=10;i>=1;i--) coords.push({r:11,c:i});
        for(let i=10;i>=2;i--) coords.push({r:i,c:1});

        function init() {
            const b = document.getElementById('board');
            coords.forEach((p, i) => {
                const d = document.createElement('div');
                d.className = 'lamp';
                d.id = 'l-' + i;
                d.style.gridRow = p.r;
                d.style.gridColumn = p.c;
                d.innerText = (i % 5 === 0) ? 'A' : 'B';
                b.appendChild(d);
            });
        }

        async function liffInit() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const p = await liff.getProfile();
                uid = p.userId;
                userName = p.displayName;
                document.getElementById('u-name').innerText = userName;
                
                // ç«‹å³è«‹æ±‚é»æ•¸
                const s = document.createElement('script');
                s.src = `${API}?action=checkUser&uid=${uid}&callback=cb_pts&t=${Date.now()}`;
                document.body.appendChild(s);
            } catch (e) {
                document.getElementById('u-name').innerText = "é€£ç·šå¤±æ•—";
            }
        }

        window.cb_pts = (r) => {
            if (r && r.points !== undefined) {
                document.getElementById('pts').innerText = r.points;
            }
        };

        window.cb_draw = (r) => {
            if (r.status === 'success') {
                finalRes = r.results;
                document.getElementById('pts').innerText = r.remainingPoints;
            } else {
                alert(r.message);
                location.reload();
            }
        };

        function draw(c) {
            if (isAnim || !uid) return;
            isAnim = true;
            finalRes = null;
            document.getElementById('drawBtn').disabled = true;

            // ç™¼é€æŠ½çè«‹æ±‚
            const s = document.createElement('script');
            s.src = `${API}?action=draw&uid=${uid}&name=${encodeURIComponent(userName)}&poolId=å–®æŒ‘å¥—&count=${c}&callback=cb_draw&t=${Date.now()}`;
            document.body.appendChild(s);

            let currentPos = 0;
            let speed = 60;
            let steps = 0;

            function run() {
                document.querySelectorAll('.lamp').forEach(l => l.classList.remove('active'));
                document.getElementById('l-' + (currentPos % 40)).classList.add('active');
                
                currentPos++;
                steps++;

                // åœæ­¢æ¢ä»¶ï¼šå·²ç¶“è·‘äº†è‡³å°‘ 40 æ ¼ï¼Œä¸”å¾Œç«¯è³‡æ–™ (finalRes) å·²ç¶“å›ä¾†äº†
                if (steps > 40 && finalRes !== null) {
                    isAnim = false;
                    setTimeout(showResult, 500);
                    return;
                }

                setTimeout(run, speed);
            }
            run();
        }

        function showResult() {
            document.getElementById('win-overlay').style.display = 'flex';
            document.getElementById('result-list').innerHTML = finalRes.map(x => 
                `<div class="res-box"><b>${x.grade}è³</b> - ${x.name}</div>`
            ).join('');
        }

        init();
        liffInit();
    </script>
</body>
</html>
