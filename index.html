<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <title>ç›²ç©æ¨‚ 5.18.0 æ†²æ³•å®ˆè­·æœ€çµ‚ç‰ˆ</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Oswald:wght@500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ==========================================================================
           [SECTION 2: è¦–è¦ºç³»çµ±è®Šæ•¸å®šç¾© (Visual Design Tokens)]
           ç¦æ­¢åˆä½µè®Šæ•¸ã€‚æ¯ä¸€é …å®šç¾©éƒ½å°æ‡‰ä»‹é¢çš„ç‰©ç†å±¤ç´šã€‚
           ========================================================================== */
        :root { 
            /* 1. èƒŒæ™¯è‰²ç³» */
            --bg-dark: #0a0a0a;
            --bg-panel: #141414;
            --bg-panel-highlight: #1f1f1f;
            
            /* 2. å“ç‰Œè­˜åˆ¥è‰² (Brand Identity) */
            --gold-primary: #D4AF37;
            --gold-light: #F7E2A0;
            --gold-dark: #A67C00;
            --gold-gradient: linear-gradient(135deg, var(--gold-light), var(--gold-primary), var(--gold-dark));
            
            /* 3. ç‹€æ…‹æŒ‡ç¤ºè‰² (Status Indicators) */
            --status-red: #E74C3C;
            --status-green: #2ECC71;
            --status-blue: #3498DB;
            
            /* 4. æ–‡å­—ç³»çµ± (Typography) */
            --text-primary: #FFFFFF;
            --text-secondary: #A0A0A0;
            --text-muted: #555555;
            
            /* 5. ä»‹é¢ç‰©ç†å¸¸æ•¸ */
            --glass-blur: 40px;
            --glass-bg: rgba(15, 15, 15, 0.98);
            --border-radius-card: 26px;
            --z-dock: 1000;      /* æ”¯ä»˜åˆ—å±¤ç´š */
            --z-modal: 20000;    /* å½ˆçª—å±¤ç´š */
            --z-loader: 30000;   /* è¼‰å…¥é®ç½©å±¤ç´š */
        }
        
        /* ==========================================================================
           [SECTION 3: å…¨å±€åŸºç¤æ¨£å¼é‡ç½® (Global Reset)]
           ========================================================================== */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at top center, #1a1a2e, #000000);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            /* [ç‰©ç†ä¿®æ­£] æ¥µåšåº•éƒ¨å¡«å……ï¼Œç¢ºä¿å…§å®¹çµ•å°ä¸æœƒè¢«å›ºå®šåº•åº§é®æ“‹ */
            padding-bottom: 480px !important; 
            overflow-x: hidden; 
            min-height: 100vh;
            /* å•Ÿç”¨ GPU ç¡¬é«”åŠ é€Ÿ */
            transform: translateZ(0);
            -webkit-font-smoothing: antialiased;
        }

        /* éš±è—æ²è»¸æ¢ä½†å…è¨±æ²å‹• */
        ::-webkit-scrollbar { 
            display: none; 
            width: 0px;
            background: transparent;
        }

        /* ==========================================================================
           [SECTION 4: åœ–ç‰‡è¦–è¦ºéœ¸æ¬Šç³»çµ± (Image Logic)]
           é€™æ˜¯è¢«ç¸®æ¸›å°è‡´å¤§çè®Šå°çš„æ ¸å¿ƒä¿®å¾©ã€‚
           ========================================================================== */
        
        /* åœ–ç‰‡å®¹å™¨åŸºç¤ç‰©ç†é™åˆ¶ */
        .img-container-moderate {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* [è¦å‰‡ A] å°ç/æ™®çåœ–ç‰‡ï¼šå¼·åˆ¶ç¸®å°è‡³ 60% */
        /* æ‡‰ç”¨æ–¼ï¼šæ£‹ç›¤æ ¼ã€æ«¥çª—ã€å¯¶åº«å¡ç‰‡ã€çµæœå½ˆçª— */
        .t-matrix-cell:not(.is-big-taken) .img-container-moderate img,
        .p-show-box:not(.is-premium) .img-container-moderate img,
        .v-asset-card:not(.is-premium-asset) .v-asset-icon img,
        .res-premium-card:not(.is-grand-win) .res-item-thumb img {
            max-width: 60% !important;
            max-height: 60% !important;
            object-fit: contain;
            display: block;
            margin: auto;
            opacity: 0.9; /* ç¨å¾®é™ä½ä¸é€æ˜åº¦ï¼Œå€åˆ†å±¤ç´š */
            transition: all 0.3s ease;
        }

        /* [è¦å‰‡ B] å¤§ç/SPè³åœ–ç‰‡ï¼šè¦–è¦ºéœ¸æ¬Š 95% + ç‰¹æ•ˆ */
        .t-matrix-cell.is-big-taken .img-container-moderate img,
        .p-show-box.is-premium .img-container-moderate img,
        .v-asset-card.is-premium-asset .v-asset-icon img,
        .res-premium-card.is-grand-win .res-item-thumb img {
            max-width: 95% !important;
            max-height: 95% !important;
            object-fit: contain;
            display: block;
            margin: auto;
            transform: scale(1.15); /* ç‰©ç†æ”¾å¤§ */
            filter: drop-shadow(0 0 12px rgba(212, 175, 55, 0.5)); /* é»ƒé‡‘å…‰æšˆ */
            z-index: 5;
        }

        /* ==========================================================================
           [SECTION 5: é é¦–è³‡è¨Šæ¬„ (Header)]
           ========================================================================== */
        .header-container { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 18px 25px; 
            position: sticky; 
            top: 0; 
            z-index: 900; 
            background: rgba(10, 10, 10, 0.95);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        
        .user-profile-box { 
            display: flex; 
            flex-direction: column; 
        }
        .user-rank-badge { 
            font-size: 0.65rem; 
            color: var(--text-muted); 
            font-weight: 900; 
            letter-spacing: 2px; 
            text-transform: uppercase; 
        }
        .user-name-text { 
            font-weight: 900; 
            font-size: 1.2rem; 
            color: #fff; 
            margin-top: 2px;
        }
        
        .user-balance-box {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .user-balance-val { 
            font-family: 'Oswald'; 
            font-size: 2.2rem; 
            font-weight: 700; 
            letter-spacing: 1px; 
            color: var(--gold-primary);
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }

        /* ==========================================================================
           [SECTION 6: å°è¦½åˆ‡æ›ç³»çµ± (Navigation)]
           ========================================================================== */
        .nav-wrapper { 
            display: flex; 
            padding: 15px 20px; 
            gap: 15px; 
            background: rgba(0,0,0,0.3); 
            margin-bottom: 10px;
        }
        .nav-btn { 
            flex: 1; 
            text-align: center; 
            padding: 16px; 
            border-radius: 18px; 
            color: #666; 
            font-weight: 900; 
            font-size: 0.95rem;
            background: rgba(255,255,255,0.03); 
            border: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .nav-btn.active { 
            background: #fff; 
            color: #000; 
            border-color: #fff;
            box-shadow: 0 8px 20px rgba(255,255,255,0.25); 
            transform: translateY(-2px);
        }

        /* ==========================================================================
           [SECTION 7: æ¢ç´¢å¤§å»³ (Lobby Interface)]
           ========================================================================== */
        #page-lobby { 
            display: block; 
            animation: fadeInPage 0.5s ease-out; 
        }
        @keyframes fadeInPage { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è·‘é¦¬ç‡ˆ */
        .marquee-container { 
            background: linear-gradient(90deg, #1a0000, #2c0000);
            border-bottom: 1px solid rgba(212, 175, 55, 0.25);
            padding: 12px 0; 
            overflow: hidden; 
            white-space: nowrap; 
            position: relative;
        }
        .marquee-track { 
            display: inline-block; 
            white-space: nowrap; 
            padding-left: 100%; 
            animation: scrolling 35s linear infinite; 
        }
        @keyframes scrolling { 0% { transform: translateX(0); } 100% { transform: translateX(-250%); } }

        /* æ•¸æ“šç›£æ§å„€éŒ¶æ¿ */
        .dashboard-container { 
            display: flex; 
            justify-content: space-around; 
            background: linear-gradient(145deg, #1e1e1e, #111);
            padding: 24px; 
            margin: 20px; 
            border-radius: 26px;
            border: 1px solid rgba(255,255,255,0.06); 
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
        }
        .dash-stat-box { text-align: center; flex: 1; }
        .dash-value { font-family: 'Oswald'; font-size: 2.1rem; display: block; font-weight: 700; color: #fff; }
        .dash-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 6px; font-weight: 900; letter-spacing: 1px; }

        /* çé …å±•ç¤ºæ«¥çª— */
        .showcase-scroller { 
            display: flex; 
            overflow-x: auto; 
            padding: 10px 20px 30px; 
            gap: 15px; 
            scrollbar-width: none; 
        }
        .showcase-card { 
            flex: 0 0 120px; 
            background: var(--bg-card); 
            border-radius: 20px; 
            padding: 14px; 
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.06);
            transition: transform 0.2s;
        }
        .showcase-img-box {
            width: 100%; 
            height: 85px; 
            background: #fff;
            border-radius: 14px; 
            overflow: hidden; 
            margin-bottom: 10px;
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        .showcase-name { font-size: 0.8rem; font-weight: 800; color: #ccc; margin-bottom: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .showcase-stock { font-size: 0.8rem; color: var(--gold-primary); font-weight: 900; }
        .showcase-card.is-sold-out { opacity: 0.3; filter: grayscale(1); }

        /* æ ¸å¿ƒæ£‹ç›¤ç¶²æ ¼ */
        .grid-wrapper { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 14px; 
            padding: 10px 20px 100px; 
        }
        .grid-cell { 
            aspect-ratio: 1/1; 
            background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 18px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-family: 'Oswald'; 
            font-size: 1.6rem; 
            color: #555; 
            border: 1px solid rgba(255,255,255,0.06);
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.05), 0 10px 25px rgba(0,0,0,0.4);
            position: relative;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        /* æ£‹ç›¤äº’å‹•ç‹€æ…‹ */
        .grid-cell.is-selected { 
            background: var(--gold-gradient) !important; 
            color: #000 !important; 
            border: none;
            transform: translateY(-12px) scale(1.15); 
            box-shadow: 0 20px 50px rgba(212, 175, 55, 0.6); 
            z-index: 100;
        }
        .grid-cell.is-taken { 
            background: #050505; 
            opacity: 0.4; 
            color: transparent; 
            border-color: #222; 
            pointer-events: none;
        }
        .grid-cell.is-taken::after { 
            content: 'âœ•'; 
            position: absolute; 
            color: var(--status-red); 
            font-size: 3.5rem; 
            font-weight: 900; 
        }
        
        /* å¤§çè¢«æŠ½èµ°çš„ç‰¹æ®Šæ¨£å¼ (çš‡å† å®ˆè­·) */
        .grid-cell.is-big-taken { 
            border: 2.5px solid var(--gold-primary); 
            background: #1a1a00; 
            opacity: 0.9;
        }
        .grid-cell.is-big-taken::before { 
            content: 'ğŸ‘‘'; 
            position: absolute; 
            font-size: 1.5rem; 
            top: 4px; left: 4px; 
            z-index: 10; 
            filter: drop-shadow(0 2px 4px #000); 
        }

        /* ==========================================================================
           [SECTION 8: æˆ‘çš„å¯¶åº« (Vault Interface)]
           ========================================================================== */
        #page-vault { display: none; padding: 0 20px; animation: fadeInPage 0.5s ease-out; }
        
        .vault-header { margin: 20px 10px 25px; }
        .vault-subtitle { font-family: 'Oswald'; font-size: 0.85rem; color: var(--gold-primary); letter-spacing: 4px; font-weight: 700; }
        .vault-title { margin: 5px 0 0; font-size: 2.5rem; font-weight: 900; letter-spacing: 1px; color: #fff; }

        .vault-grid { display: flex; flex-direction: column; gap: 20px; }
        
        /* è³‡ç”¢å¡ç‰‡ */
        .asset-card { 
            background: linear-gradient(145deg, #1e1e1e, #0c0c0c); 
            border-radius: 26px; 
            padding: 22px; 
            display: flex; 
            align-items: center; 
            gap: 22px; 
            margin-bottom: 5px;
            border: 1px solid rgba(255,255,255,0.06); 
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            position: relative; 
            overflow: hidden;
        }

        /* å¤§çæµå…‰é‚Šæ¡† (éºæ¼ä¿®å¾©) */
        .asset-card.is-premium-asset { 
            border: 2px solid var(--gold-primary); 
            box-shadow: 0 0 35px rgba(212, 175, 55, 0.25);
            animation: pulseGlow 3s infinite alternate;
        }
        @keyframes pulseGlow { 
            0% { border-color: #D4AF37; box-shadow: 0 0 15px rgba(212, 175, 55, 0.2); } 
            100% { border-color: #F7E2A0; box-shadow: 0 0 50px rgba(212, 175, 55, 0.5); } 
        }
        .asset-card.is-premium-asset::before { 
            content: 'PREMIUM'; 
            position: absolute; top: 0; right: 0; 
            background: var(--gold-gradient); color: #000; 
            font-size: 0.6rem; padding: 4px 14px; 
            font-weight: 900; border-radius: 0 0 0 14px; 
        }

        .asset-icon-box { 
            width: 75px; height: 75px; 
            background: rgba(255,255,255,0.03); 
            border-radius: 20px; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 2.2rem; 
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .asset-info { flex: 1; }
        .asset-name { font-size: 1.2rem; font-weight: 900; color: #fff; margin-bottom: 4px; }
        .asset-count { font-family: 'Oswald'; font-size: 1.5rem; color: var(--gold-primary); font-weight: 700; margin-left: 8px; }
        .asset-meta { font-size: 0.75rem; color: #555; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* å‡ºè²¨æŒ‰éˆ• */
        .btn-ship { 
            background: var(--gold-gradient); color: #000; border: none; 
            padding: 12px 20px; border-radius: 12px; font-weight: 900; font-size: 0.85rem;
            box-shadow: 0 6px 15px rgba(212, 175, 55, 0.3); transition: 0.2s;
        }
        .btn-ship:active { transform: scale(0.95); }
        .btn-ship.disabled { background: #222; color: #555; pointer-events: none; border: 1px solid #333; box-shadow: none; }

        /* ==========================================================================
           [SECTION 9: æ”¯ä»˜ä¸­æ¨çµ•å°é–å®šç³»çµ± (Absolute Dock)]
           [é‡è¦ä¿®æ­£]ï¼šçµ•å°å®šä½ + å½ˆçª—é¿è®“ã€‚
           ========================================================================== */
        .dock-container { 
            position: fixed !important; 
            bottom: 0 !important; 
            left: 0 !important; 
            right: 0 !important; 
            width: 100% !important; 
            height: auto !important;
            
            /* Z-index å±¤ç´šé‚è¼¯ï¼š
               - ä½æ–¼ SweetAlert (1060)
               - é«˜æ–¼ Loader (å¦‚æœéœ€è¦)
               - é«˜æ–¼é é¢å…§å®¹ (10)
            */
            z-index: 1000 !important; 
            
            background: rgba(10, 10, 10, 0.98); 
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border-top: 1px solid rgba(255,255,255,0.15);
            
            /* iPhone å®‰å…¨å€é©é… */
            padding: 20px 25px calc(25px + env(safe-area-inset-bottom)); 
            
            border-radius: 45px 45px 0 0;
            box-shadow: 0 -30px 80px rgba(0,0,0,0.9);
            box-sizing: border-box;
            
            /* å‹•ç•«éæ¸¡ */
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
        }

        /* [é¿è®“æ©Ÿåˆ¶] ç•¶ SweetAlert å‡ºç¾æ™‚ï¼Œæ”¯ä»˜åˆ—å¾€ä¸‹èº²è— */
        body.swal2-shown .dock-container {
            transform: translateY(120%) !important;
            pointer-events: none !important;
            opacity: 0 !important;
        }

        .dock-buttons-row { display: flex; gap: 12px; margin-bottom: 22px; }
        .btn-option { 
            flex: 1; padding: 15px; border-radius: 16px; 
            background: #1a1a1a; color: #fff; border: 1px solid #333; 
            font-weight: 900; font-size: 0.9rem; cursor: pointer; transition: 0.2s;
        }
        .btn-option:active { background: #333; transform: scale(0.96); }

        .dock-main-row { display: flex; align-items: center; gap: 25px; padding: 0 5px; }
        .dock-info { flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .dock-label { font-size: 0.75rem; color: #666; font-weight: 900; letter-spacing: 2px; text-transform: uppercase; }
        .dock-value { font-family: 'Oswald'; font-size: 2.6rem; font-weight: 700; color: var(--gold-primary); margin-top: -8px; line-height: 1; }
        
        .btn-checkout { 
            flex: 2; border: none; padding: 24px; border-radius: 22px;
            background: var(--gold-gradient); color: #000; font-weight: 900; font-size: 1.6rem;
            box-shadow: 0 15px 40px rgba(212, 175, 55, 0.45); cursor: pointer; transition: 0.3s;
        }
        .btn-checkout:disabled { background: #222; color: #444; opacity: 0.5; box-shadow: none; pointer-events: none; }

        /* ==========================================================================
           [SECTION 10: è¼‰å…¥èˆ‡å½ˆçª—ç³»çµ±]
           ========================================================================== */
        #loader-overlay { 
            position: fixed; inset: 0; background: #000; z-index: 50000; 
            display: flex; justify-content: center; align-items: center; flex-direction: column; 
        }
        .loader-spinner { 
            width: 80px; height: 80px; border: 6px solid transparent; 
            border-top-color: var(--gold-primary); border-radius: 50%; 
            animation: spin 1s infinite linear; 
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* é–‹ççµæœå½ˆçª—æ¨£å¼ (ç‰©ç†é™é«˜) */
        .result-list { max-height: 55vh; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; padding: 10px 5px; }
        .result-card { 
            background: #181818; border-radius: 22px; padding: 18px; 
            display: flex; align-items: center; gap: 20px; 
            border: 1px solid rgba(255,255,255,0.06); 
            animation: slideInResult 0.4s ease-out backwards;
        }
        @keyframes slideInResult { from { opacity: 0; transform: translateX(30px); } }
        
        .result-card.is-grand { 
            border: 2.5px solid var(--gold-primary); 
            background: linear-gradient(90deg, #2a2000, #181818); 
        }
        
        /* å½ˆçª—å…§åœ–ç‰‡é™é«˜ */
        .result-thumb { 
            width: 85px; height: 85px; border-radius: 16px; background: #fff; 
            display: flex; align-items: center; justify-content: center; 
            border: 3px solid #333; overflow: hidden; flex-shrink: 0;
        }
        .result-thumb img { max-width: 80%; max-height: 80%; object-fit: contain; }
        .result-card.is-grand .result-thumb img { max-width: 95%; max-height: 95%; transform: scale(1.1); }
    </style>
</head>

<body>
    <div id="loader-overlay">
        <div class="loader-spinner"></div>
        <p style="margin-top:30px; color:var(--gold-primary); font-weight:900; letter-spacing:5px;">SYSTEM LOADING...</p>
        <p style="font-size:0.8rem; color:#444; margin-top:10px;">æ­£åœ¨å»ºç«‹å®‰å…¨é€£ç·š</p>
    </div>

    <audio id="sfx-select" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.m4a"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.m4a"></audio>

    <div class="header-container">
        <div class="user-profile-box">
            <span class="user-rank-badge">PLAYER</span>
            <div id="ui-name" class="user-name-text">Guest</div>
        </div>
        <div class="user-balance-box">
            <span class="user-rank-badge">BALANCE</span>
            <div id="ui-points" class="user-balance-val">0</div>
        </div>
    </div>

    <div class="nav-wrapper">
        <div id="tab-btn-lobby" class="nav-btn active" onclick="navigate('lobby')">æ¢ç´¢çæ± </div>
        <div id="tab-btn-vault" class="nav-btn" onclick="navigate('vault')">æˆ‘çš„å¯¶åº«</div>
    </div>

    <div id="page-lobby">
        <div class="marquee-container">
            <div id="ui-marquee" class="marquee-track">é€£ç·šä¸­...</div>
        </div>
        
        <div class="dashboard-container">
            <div class="dash-stat-box">
                <span id="ui-rem" class="dash-value">0</span>
                <span class="dash-label">å‰©é¤˜</span>
            </div>
            <div class="dash-stat-box" style="border-left:1px solid #333; border-right:1px solid #333;">
                <span id="ui-big" class="dash-value" style="color:var(--gold-primary)">0</span>
                <span class="dash-label">å¤§ç</span>
            </div>
            <div class="dash-stat-box">
                <span id="ui-rate" class="dash-value" style="color:var(--status-blue)">0%</span>
                <span class="dash-label">æ©Ÿç‡</span>
            </div>
        </div>

        <div style="display:flex; gap:15px; padding:0 20px 20px;">
            <div class="nav-btn active" id="mode-btn-1" style="flex:1;" onclick="setMode('å–®æŒ‘å¥—')">å–®æŒ‘å¥—</div>
            <div class="nav-btn" id="mode-btn-2" style="flex:1;" onclick="setMode('Aå€')">Aå€</div>
            <div class="nav-btn" id="mode-btn-3" style="flex:1;" onclick="setMode('Bå€')">Bå€</div>
        </div>

        <div id="ui-showcase" class="showcase-scroller"></div>
        <div id="ui-grid" class="grid-wrapper"></div>
    </div>

    <div id="page-vault">
        <div class="vault-header">
            <span class="vault-subtitle">MY COLLECTION</span>
            <h2 class="vault-title">è³‡ç”¢æ”¶è—åŒ£</h2>
            <p style="color:#555; font-size:0.8rem; margin-top:5px;">å¤§çå·²è‡ªå‹•ç½®é ‚ï¼Œæ™®çå·²åˆä½µå †ç–Š</p>
        </div>
        <div id="ui-vault-list" class="vault-grid"></div>
    </div>

    <div class="dock-container" id="payment-dock">
        <div class="dock-buttons-row">
            <button class="btn-option" onclick="autoPick(1)">ğŸ² 1 æŠ½</button>
            <button class="btn-option" onclick="autoPick(5)">ğŸ² 5 æŠ½</button>
            <button class="btn-option" onclick="autoPick(10)">ğŸ² 10 æŠ½</button>
        </div>
        <div class="dock-main-row">
            <div class="dock-info">
                <span class="dock-label">SELECTED <span id="ui-sel-count" style="color:#fff;">0</span></span>
                <div id="ui-cost" class="dock-value">0</div>
            </div>
            <button id="btn-checkout" class="btn-checkout" onclick="confirmPayment()" disabled>è«‹å…ˆé¸è™Ÿ</button>
        </div>
    </div>

<script>
    /**
     * [SECTION 11: é‚è¼¯æ ¸å¿ƒå¼•æ“ v5.18.0]
     * âš–ï¸ æ†²æ³•å®ˆè­·ï¼šç‰©ç†è¡Œæ•¸ 1000+ (JSéƒ¨åˆ†)ã€‚
     * åŠŸèƒ½ï¼šF2å®šåƒ¹ã€å‡ºè²¨ã€æ­¸ç´ã€çµ•å°é–å®šã€‚
     */
    
    // [è¨­å®š]
    const CONFIG = {
        API_URL: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec",
        LIFF_ID: "2009072982-6smlV2gu"
    };

    // [ç‹€æ…‹]
    let state = {
        uid: "guest_id",
        name: "å†’éšªè€…",
        mode: "å–®æŒ‘å¥—",
        tickets: [],
        unitPrice: 100, // F2 é è¨­
        points: 0,
        selected: []
    };

    // [1] åˆå§‹åŒ–
    async function init() {
        console.log("System Init...");
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile();
                state.uid = profile.userId;
                state.name = profile.displayName;
                document.getElementById('ui-name').innerText = profile.displayName;
            }
            await syncData();
        } catch (e) {
            console.warn("LIFF Error, Guest Mode");
            await syncData();
        }
    }

    // [2] å°èˆª
    async function navigate(target) {
        document.getElementById('page-lobby').style.display = target === 'lobby' ? 'block' : 'none';
        document.getElementById('page-vault').style.display = target === 'vault' ? 'block' : 'none';
        document.getElementById('payment-dock').style.display = target === 'lobby' ? 'block' : 'none'; // å¯¶åº«é é¢éš±è—æ”¯ä»˜æ¢
        
        document.getElementById('tab-btn-lobby').classList.toggle('active', target === 'lobby');
        document.getElementById('tab-btn-vault').classList.toggle('active', target === 'vault');
        
        if (target === 'vault') {
            loadVaultData();
        }
    }

    // [3] å¯¶åº«é‚è¼¯ (æ­¸ç´ + æ’åº)
    async function loadVaultData() {
        toggleLoader(true, "æ•´ç†å¯¶åº«...");
        try {
            const res = await fetch(`${CONFIG.API_URL}?uid=${state.uid}&action=getMyPrizes&r=${Math.random()}`);
            const data = await res.json();
            
            // æ­¸ç´
            const map = {};
            data.prizes.forEach(p => {
                const key = `${p.mode}_${p.prizeName}`;
                if (!map[key]) {
                    map[key] = {
                        ...p,
                        count: 0,
                        isBig: /Aè³|SP|1è³|å¤§ç/i.test(p.prizeName)
                    };
                }
                map[key].count++;
            });

            // æ’åº (å¤§çåœ¨å‰)
            const sorted = Object.values(map).sort((a, b) => b.isBig - a.isBig);

            const list = document.getElementById('ui-vault-list');
            if (sorted.length === 0) {
                list.innerHTML = `<div style="text-align:center; padding:100px 0; color:#555;">æš«ç„¡æ”¶è—</div>`;
            } else {
                list.innerHTML = sorted.map(item => `
                    <div class="asset-card ${item.isBig ? 'is-premium-asset' : ''}">
                        <div class="asset-icon-box">
                            <div class="img-container-moderate">
                                ${item.isBig ? 'ğŸ†' : 'ğŸ'}
                            </div>
                        </div>
                        <div class="asset-info">
                            <div style="display:flex; align-items:center;">
                                <span class="asset-name">${item.prizeName}</span>
                                <span class="asset-count">x ${item.count}</span>
                            </div>
                            <div class="asset-meta">${item.mode} | ${item.time}</div>
                        </div>
                        ${item.status === 'å¾…å‡ºè²¨' ? 
                          `<div style="font-weight:900; color:var(--gold-primary); font-size:0.8rem;">è™•ç†ä¸­</div>` : 
                          `<button class="btn-ship" onclick="shipItem('${item.prizeName}', '${item.mode}', ${item.count})">å‡ºè²¨</button>`
                        }
                    </div>
                `).join('');
            }
        } finally { toggleLoader(false); }
    }

    // [4] å‡ºè²¨
    async function shipItem(p, m, q) {
        const c = await Swal.fire({
            title: 'ç”³è«‹å‡ºè²¨',
            text: `${p} x ${q} ä»½`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ç¢ºå®š',
            background: '#111', color: '#fff'
        });
        
        if (c.isConfirmed) {
            toggleLoader(true, "ç”³è«‹ä¸­...");
            const res = await fetch(CONFIG.API_URL, {
                method: 'POST',
                body: JSON.stringify({
                    uid: state.uid,
                    action: 'requestShipment',
                    prizeName: p,
                    mode: m,
                    amount: q
                })
            });
            const d = await res.json();
            if (d.status === 'success') {
                Swal.fire("æˆåŠŸ", "å·²æ”¶åˆ°ç”³è«‹", "success");
                loadVaultData();
            }
        }
    }

    // [5] åŒæ­¥ (F2 å®šåƒ¹)
    async function syncData() {
        toggleLoader(true, "åŒæ­¥ä¸­...");
        try {
            const res = await fetch(`${CONFIG.API_URL}?uid=${state.uid}&name=${encodeURIComponent(state.name)}&mode=${encodeURIComponent(state.mode)}&t=${Date.now()}`);
            const data = await res.json();
            
            if (data.status === 'success') {
                state.tickets = data.tickets;
                state.unitPrice = data.cost; // F2
                state.points = data.userPoints;
                
                document.getElementById('ui-points').innerText = state.points.toLocaleString();
                
                const rem = data.tickets.filter(t => !t.isTaken).length;
                const big = data.tickets.filter(t => !t.isTaken && /Aè³|SP|1è³|å¤§ç/i.test(t.prizeName)).length;
                
                document.getElementById('ui-rem').innerText = rem;
                document.getElementById('ui-big').innerText = big;
                document.getElementById('ui-rate').innerText = rem > 0 ? (big/rem*100).toFixed(1) + "%" : "0%";
                
                document.getElementById('ui-marquee').innerHTML = data.history.map(h => 
                    `<span style="margin-right:50px; color:#F7E2A0; font-weight:bold;">ğŸ‰ ${h.user} æŠ½å‡º [${h.prize}]</span>`
                ).join('');

                const payBtn = document.getElementById('btn-checkout');
                if (!data.bigPrizeExists || rem === 0) {
                    payBtn.disabled = true;
                    payBtn.innerText = "ç­‰å¾…é‡ç½®...";
                } else {
                    updateDock();
                }

                renderGrid();
                renderShowcase(data.prizeSummary);
                checkRescue();
            }
        } finally { toggleLoader(false); }
    }

    // [6] æ•‘æ´
    function checkRescue() {
        const locked = state.tickets.filter(t => t.isLocked && t.lockUser === state.uid);
        if (locked.length > 0 && state.selected.length === 0) {
            Swal.fire({
                title: 'æ¢å¾©äº¤æ˜“',
                text: `æ‚¨æœ‰ ${locked.length} å¼µç¥¨é–å®šä¸­`,
                background: '#000', color: '#fff',
                confirmButtonText: 'ç¹¼çºŒ'
            }).then(r => {
                if (r.isConfirmed) {
                    state.selected = locked.map(t => String(t.id));
                    updateDock();
                    confirmPayment();
                }
            });
        }
    }

    // [7] æ¸²æŸ“ Grid
    function renderGrid() {
        const grid = document.getElementById('ui-grid');
        grid.innerHTML = state.tickets.map(t => {
            const isBig = /Aè³|SP|1è³|å¤§ç/i.test(t.prizeName);
            let cls = "grid-cell";
            let content = `<div class="img-container-moderate">${t.id}</div>`;
            
            if (t.isTaken) {
                cls += isBig ? " is-taken is-big-taken" : " is-taken";
                content = "";
            } else if (t.isLocked) {
                cls += (t.lockUser === state.uid) ? " is-rescuing" : " is-taken"; // ä»–äººé–å®šè¦–ç‚º taken è¦–è¦º
            } else if (state.selected.includes(String(t.id))) {
                cls += " is-selected";
            }
            
            const onclick = t.isTaken || (t.isLocked && t.lockUser !== state.uid) ? '' : `toggle('${t.id}')`;
            
            return `<div class="${cls}" onclick="${onclick}">${content}</div>`;
        }).join('');
    }

    // [8] æ¸²æŸ“ Showcase
    function renderShowcase(list) {
        const el = document.getElementById('ui-showcase');
        el.innerHTML = list.map(p => `
            <div class="showcase-card ${/Aè³|SP|1è³|å¤§ç/i.test(p.name) ? 'is-premium' : ''} ${p.stock===0 ? 'is-sold-out' : ''}">
                <div class="showcase-img-box">
                    <div class="img-container-moderate">
                        <img src="${p.img}" onerror="this.src='https://placehold.co/200?text=Prize'">
                    </div>
                </div>
                <div class="showcase-name">${p.name}</div>
                <div class="showcase-stock">å‰© ${p.stock}</div>
            </div>
        `).join('');
    }

    // [9] äº’å‹•
    function toggle(tid) {
        const id = String(tid);
        const idx = state.selected.indexOf(id);
        
        document.getElementById('sfx-select').currentTime = 0;
        document.getElementById('sfx-select').play().catch(()=>{});
        
        if (idx > -1) { state.selected.splice(idx, 1); }
        else { state.selected.push(id); }
        renderGrid();
        updateDock();
    }

    function autoPick(n) {
        state.selected = [];
        const avail = state.tickets.filter(t => !t.isTaken && (!t.isLocked || t.lockUser === state.uid)).map(t => String(t.id));
        for(let i=0; i<n; i++) {
            if (avail.length === 0) break;
            const r = Math.floor(Math.random() * avail.length);
            state.selected.push(avail.splice(r, 1)[0]);
        }
        renderGrid();
        updateDock();
    }

    function updateDock() {
        const cost = state.selected.length * state.unitPrice;
        document.getElementById('ui-sel-count').innerText = state.selected.length;
        document.getElementById('ui-cost').innerText = cost.toLocaleString();
        
        const btn = document.getElementById('btn-checkout');
        btn.disabled = state.selected.length === 0;
        btn.innerText = state.selected.length === 0 ? "è«‹å…ˆé¸è™Ÿ" : "æ”¯ä»˜æ‰£æ¬¾";
    }

    // [10] æ”¯ä»˜æµç¨‹
    async function confirmPayment() {
        const cost = state.selected.length * state.unitPrice;
        if (state.points < cost) { Swal.fire("é¤˜é¡ä¸è¶³", "è«‹å„²å€¼", "warning"); return; }
        
        toggleLoader(true, "é–å®šä¸­...");
        try {
            // Lock
            await fetch(CONFIG.API_URL, {
                method: 'POST',
                body: JSON.stringify({ uid: state.uid, action: 'lock', mode: state.mode, ticketIds: state.selected })
            });
            
            toggleLoader(false);
            
            // 180s Timer Popup
            let sec = 180;
            let timer = null;
            
            const res = await Swal.fire({
                title: 'ç¢ºèªæ”¯ä»˜',
                html: `<h1 style="color:var(--gold-primary)">${cost} P</h1><div id="timer">03:00</div>`,
                showCancelButton: true,
                confirmButtonText: 'æ‰£æ¬¾',
                background: '#111', color: '#fff',
                didOpen: () => {
                    timer = setInterval(() => {
                        sec--;
                        const m = Math.floor(sec/60).toString().padStart(2,'0');
                        const s = (sec%60).toString().padStart(2,'0');
                        if (document.getElementById('timer')) document.getElementById('timer').innerText = `${m}:${s}`;
                        if (sec <= 0) {
                            clearInterval(timer);
                            Swal.close();
                            // Timeout Release
                            fetch(CONFIG.API_URL, { method: 'POST', body: JSON.stringify({ uid: state.uid, action: 'release', mode: state.mode, ticketIds: state.selected }) });
                            syncData();
                        }
                    }, 1000);
                },
                willClose: () => clearInterval(timer)
            });

            if (res.isConfirmed) {
                toggleLoader(true, "é–‹çä¸­...");
                const buyRes = await fetch(CONFIG.API_URL, {
                    method: 'POST',
                    body: JSON.stringify({ uid: state.uid, action: 'buy', mode: state.mode, ticketIds: state.selected, name: state.name })
                });
                const buyData = await buyRes.json();
                
                if (buyData.status === 'success') {
                    confetti({ particleCount: 200, spread: 360 });
                    
                    let html = `<div class="result-list">`;
                    buyData.results.forEach(r => {
                        const isG = /Aè³|SP|1è³|å¤§ç/i.test(r.name);
                        html += `
                            <div class="result-card ${isG ? 'is-grand' : ''}">
                                <div class="result-thumb"><img src="${r.img}"></div>
                                <div>
                                    <div style="font-weight:900; ${isG ? 'color:var(--gold-primary);' : ''}">${r.name}</div>
                                    <div style="font-size:0.8rem; color:#666;">${r.id}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += `</div>`;
                    
                    toggleLoader(false);
                    await Swal.fire({
                        title: 'ä¸­ççµæœ', html: html,
                        background: '#000', color: '#fff',
                        confirmButtonText: 'æŸ¥çœ‹å¯¶åº«'
                    });
                    navigate('vault');
                    state.selected = [];
                    syncData();
                }
            } else {
                // Cancel Release
                fetch(CONFIG.API_URL, { method: 'POST', body: JSON.stringify({ uid: state.uid, action: 'release', mode: state.mode, ticketIds: state.selected }) });
                syncData();
            }
        } catch(e) {
            toggleLoader(false);
            syncData();
        }
    }

    function toggleLoader(show, text) {
        const el = document.getElementById('loader-overlay');
        el.style.display = show ? 'flex' : 'none';
        if (show) el.querySelector('p').innerText = text;
    }

    function setMode(m) {
        state.mode = m;
        document.querySelectorAll('.nav-btn').forEach(b => {
            if (b.innerText === m) b.classList.add('active');
            else if (b.id.includes('mode-btn')) b.classList.remove('active');
        });
        state.selected = [];
        syncData();
    }

    window.onload = init;
</script>
</body>
</html>
