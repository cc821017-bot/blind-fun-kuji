/**
 * ç›²ç©æ¨‚ - åº«å­˜åˆ¶å°ˆç”¨ GAS å¾Œç«¯ (2026/02/09 æœ€çµ‚ä¿®å¾©ç‰ˆ)
 */

function doGet(e) {
  var action = e.parameter.action;
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var callback = e.parameter.callback;

  // 1. è®€å–åº«å­˜ (å°ˆæ”» D æ¬„å‰©é¤˜æ•¸é‡)
  if (action == "getPoolStatus") {
    var pools = ["å–®æŒ‘å¥—", "ï¼¡å€ä»»é¸", "ï¼¢å€ä»»é¸"];
    var stocks = {};
    pools.forEach(function(name) {
      var sheet = ss.getSheetByName(name);
      if (!sheet) return;
      var data = sheet.getDataRange().getValues();
      var a = 0, b = 0;
      // å¾ç¬¬äºŒåˆ—é–‹å§‹è®€ï¼Œæª¢æŸ¥ D æ¬„ (ç´¢å¼• 3) çš„å‰©é¤˜æ•¸é‡
      for (var i = 1; i < data.length; i++) {
        var qty = parseInt(data[i][3]) || 0; 
        if (data[i][0] == "A") a += qty; 
        else if (data[i][0] == "B") b += qty;
      }
      var price = sheet.getRange("E1").getValue() || 200;
      stocks[name] = { a: a, b: b, total: a + b, price: price };
    });
    return ContentService.createTextOutput(callback + "(" + JSON.stringify(stocks) + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  // 2. æª¢æŸ¥é»æ•¸
  if (action == "checkUser") {
    var uid = e.parameter.uid;
    var name = e.parameter.name || "ç©å®¶";
    var userSheet = ss.getSheetByName("ç”¨æˆ¶è³‡æ–™");
    var data = userSheet.getDataRange().getValues();
    var userPts = 0;
    var found = false;
    for (var i = 1; i < data.length; i++) {
      if (data[i][0] == uid) { userPts = data[i][2]; found = true; break; }
    }
    if(!found) { userSheet.appendRow([uid, name, 0]); userPts = 0; }
    return ContentService.createTextOutput(callback + "(" + JSON.stringify({points: userPts}) + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }

  // 3. æŠ½çå‹•ä½œ (ç›´æ¥æ‰£é™¤ D æ¬„æ•¸é‡)
  if (action == "draw") {
    var uid = e.parameter.uid;
    var name = e.parameter.name || "ç©å®¶";
    var poolId = e.parameter.poolId;
    var count = parseInt(e.parameter.count);
    
    var sheet = ss.getSheetByName(poolId);
    var logSheet = ss.getSheetByName("æŠ½çç´€éŒ„");
    var userSheet = ss.getSheetByName("ç”¨æˆ¶è³‡æ–™");
    
    var userData = userSheet.getDataRange().getValues();
    var userRow = -1;
    for(var i=1; i<userData.length; i++){ if(userData[i][0] == uid) { userRow = i + 1; break; } }
    
    var price = sheet.getRange("E1").getValue() || 200;
    var currentPoints = (userRow > 0) ? userData[userRow-1][2] : 0;
    if(currentPoints < price * count) return ContentService.createTextOutput(callback + "(" + JSON.stringify({status:"fail", message:"é»æ•¸ä¸è¶³"}) + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);

    var results = [];
    for(var k=0; k<count; k++) {
      var poolData = sheet.getDataRange().getValues();
      var av = [];
      // æ‰¾å‡º D æ¬„ (ç´¢å¼• 3) é‚„æœ‰æ•¸é‡çš„çé …
      for(var i=1; i<poolData.length; i++) { if(parseInt(poolData[i][3]) > 0) av.push(i+1); }
      if(av.length == 0) break;
      
      var row = av[Math.floor(Math.random()*av.length)];
      var grade = sheet.getRange(row, 1).getValue();
      var pName = sheet.getRange(row, 2).getValue();
      
      // æ ¸å¿ƒå‹•ä½œï¼šD æ¬„æ•¸é‡æ¸› 1
      var currentQty = sheet.getRange(row, 4).getValue();
      sheet.getRange(row, 4).setValue(currentQty - 1);
      
      results.push({grade: grade, name: pName});
      logSheet.appendRow([new Date(), name, poolId, grade, pName, uid]);
    }

    var finalPts = currentPoints - (price * count);
    userSheet.getRange(userRow, 3).setValue(finalPts);
    
    sendLineMessage("\nğŸ”” æŠ½çé€šçŸ¥\nç©å®¶ï¼š" + name + "\nçµæœï¼š" + results.map(r=>r.grade+"è³").join(","));
    
    return ContentService.createTextOutput(callback + "(" + JSON.stringify({status:"success", results:results, remainingPoints:finalPts}) + ")").setMimeType(ContentService.MimeType.JAVASCRIPT);
  }
}

function sendLineMessage(msg) {
  var CHANNEL_ACCESS_TOKEN = "pmpckhlznIPidDCChsd9iDFv2E0KbgaydrzVzYvNKZnd4oeushj1LWpNoW6KpVWOF07aCVieBNEr5Li/7hsVO2jC4jLFZqbix4ygkq5B5nrO1ZVYmvJueXcvsR5i8Ej2XGs4gId2bQqJBk8s/1NAmAdB04t89/1O/w1cDnyilFU="; 
  var USER_ID = "U925122dee85cdb4fd5561a4fb38341f1"; 
  UrlFetchApp.fetch("https://api.line.me/v2/bot/message/push", {
    "method": "post",
    "headers": { "Content-Type": "application/json", "Authorization": "Bearer " + CHANNEL_ACCESS_TOKEN },
    "payload": JSON.stringify({ "to": USER_ID, "messages": [{"type": "text", "text": msg}] })
  });
}
