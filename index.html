/**
 * ç›²ç©æ¨‚ 5.17.3 æ——è‰¦å•†å‹™çµ±æ²»å®Œå…¨é«” - åŸºæº–å®ˆè­·æ¨¡å¼ (æ“´å¼µç‰ˆ)
 * * * ==========================================================================================
 * âš–ï¸ å°ˆæ¡ˆé–‹ç™¼æ†²æ³• - åŸ·è¡Œå ±å‘Š (BASELINE 5.17.3 PHYSICAL EXPANSION)
 * ==========================================================================================
 * 1. [ç‰©ç†è¡Œæ•¸çµ•å°å®ˆè­·åŸå‰‡]ï¼š
 * æœ¬ç‰ˆæœ¬ä»£ç¢¼åš´æ ¼åŸ·è¡Œç‰©ç†ç´šæ“´å¼µï¼Œçµ•å°ç¦æ­¢ç²¾ç°¡ã€‚
 * æ¯ä¸€é …åˆ¤æ–·ã€æ¯ä¸€æ¢è³¦å€¼å‡ä½”æ“šç¨ç«‹è¡Œç©ºé–“ã€‚
 * è‹¥è¼¸å‡ºå…§å®¹å°è‡´è¡Œæ•¸å›è½ï¼Œå‰‡è¦–ç‚ºä»£ç¢¼è³‡ç”¢æµå¤±ã€‚
 * * 2. [çµ•å°çµ±æ²»å”è­° (Dominion Protocol)]ï¼š
 * - å¯¦ä½œ checkDominionï¼šå…¨ç›¤æƒæéæœ¬äººçš„é–å®šç‹€æ…‹ã€‚
 * - å¯¦ä½œ extendDominionï¼šè³¼è²·æˆåŠŸå¾Œï¼Œç‰©ç†é–å®šå…¨å ´å‰©é¤˜ç±¤ä½ (180s)ã€‚
 * - ä¿è­‰ã€Œå°¾åˆ€ä¿è­·ã€ï¼šä¸€æ—¦é€²å…¥æ©Ÿå°ï¼Œé™¤éä¸»å‹•æ”¾æ£„ï¼Œå¦å‰‡å…¶ä»–ç©å®¶ç„¡æ³•æ’éšŠã€‚
 * * 3. [åº§æ¨™ç‰©ç†å°é½Šé–å®š]ï¼š
 * - è¨­å®šé ï¼šAæ¬„=çé …å, Gæ¬„=åœ–ç‰‡URL, F2=å–®åƒ¹ã€‚
 * - ç±¤ä½é ï¼šCæ¬„=UID, Dæ¬„=æ™‚é–“, Eæ¬„=é–å®šæ™‚é–“, Fæ¬„=é–å®šUIDã€‚
 * - ä¿®å¾©ç¶­åº¦è¡çªï¼šå¼·åˆ¶å®šç¾© Range ç‚º 6 æ¬„å¯¬åº¦ï¼Œé˜²æ­¢ 4 æ¬„è©¦ç®—è¡¨å¯«å…¥å¤±æ•—ã€‚
 * * 4. [åŠŸèƒ½çµ„ä»¶ä¿å…¨æ¸…å–®]ï¼š
 * - onOpen ç‡Ÿé‹é¸å–® (ä¸€éµæ´—ç‰Œ/è‡ªå‹•ç›£æ§éƒ¨ç½²)ã€‚
 * - CacheService æ•ˆèƒ½åŠ é€Ÿå±¤ (600s å¿«å–)ã€‚
 * - æ­»äº¡é–‹é—œ (Kill Switch)ï¼šå¤§çå‡ºè²¨å¾Œå³åˆ»å‡çµç›¤é¢ã€‚
 * - requestShipment å‡ºè²¨ç®¡ç†æ¥å£ã€‚
 * ==========================================================================================
 */

// ==========================================================================
// [ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨åŸŸç³»çµ±æ ¸å¿ƒå¸¸æ•¸é…ç½®]
// ==========================================================================

/** * ç¸½è¡¨åˆ†é åç¨±
 * æ­¤ç‚ºç©å®¶è³‡ç”¢çš„ã€Œæœ€çµ‚çœŸç†ä¾†æºã€ï¼Œç´€éŒ„æ‰€æœ‰æ­·å²ä¸­ç
 */
var LOG_SHEET_NAME = 'ç¸½è¡¨';

/** * ä½¿ç”¨è€…åˆ†é åç¨±
 * ç´€éŒ„ç©å®¶ UID, æš±ç¨±, èˆ‡é»æ•¸é¤˜é¡
 */
var USER_SHEET_NAME = 'ä½¿ç”¨è€…';

/** * å›æ”¶ç«™åˆ†é åç¨±
 * æ´—ç‰Œå¾Œå°‡æœªæŠ½å‡ºçš„æ®˜ç±¤å­˜å…¥æ­¤è™•ï¼Œä¾›ç‡Ÿé‹è€…æ ¸å¸³
 */
var RECYCLE_SHEET_NAME = 'å›æ”¶ç«™';

/** * äº¤æ˜“é–å®šä¿è­·æ™‚é•·
 * 180,000 æ¯«ç§’ (å³ 3 åˆ†é˜) 
 */
var LOCK_DURATION = 180 * 1000; 

/** * æ´—ç‰Œé‡ç½®ç·©è¡æ™‚é•·
 * 300,000 æ¯«ç§’ (å³ 5 åˆ†é˜) 
 */
var AUTO_RESHUFFLE_DELAY = 5 * 60 * 1000;

/** * æ–°ç©å®¶é¦–æ¬¡é€²å…¥ç³»çµ±
 * é è¨­ç™¼æ”¾ä¹‹èƒ½é‡é»æ•¸ 
 */
var DEFAULT_POINTS = 1000;

// ==========================================================================
// [ç¬¬äºŒéƒ¨åˆ†ï¼šç‡Ÿé‹ç®¡ç†é¸å–®èˆ‡è‡ªå‹•åŒ–åˆå§‹åŒ–]
// ==========================================================================

/**
 * è©¦ç®—è¡¨é–‹å•Ÿæ™‚è‡ªå‹•åŸ·è¡Œï¼šåœ¨é ‚éƒ¨é¸å–®å»ºç«‹ã€Œâš¡ ç‡Ÿé‹å¾Œå°ã€æ“ä½œä»‹é¢ã€‚
 * é€™æ˜¯ç‚ºäº†ç¢ºä¿ç®¡ç†å“¡èƒ½åœ¨ä¸é€²å…¥è…³æ­¥ç·¨è¼¯å™¨çš„æƒ…æ³ä¸‹ä¸€éµæ“ä½œç³»çµ±ã€‚
 */
function onOpen() {
  
  console.log(">>>> å•Ÿå‹•ç‡Ÿé‹é¸å–®åˆå§‹åŒ–ç¨‹åº...");
  
  var ui = SpreadsheetApp.getUi();
  
  var menu = ui.createMenu('âš¡ ç‡Ÿé‹å¾Œå°');
  
  // æ¨¡å¼æ‰‹å‹•å…¥å£
  menu.addItem('ğŸ”€ ä¸€éµæ‰‹å‹•æ´—ç‰Œé‡ç½®ï¼šå–®æŒ‘å¥—', 'shuffleSingle');
  menu.addItem('ğŸ”€ ä¸€éµæ‰‹å‹•æ´—ç‰Œé‡ç½®ï¼šAå€', 'shuffleA');
  menu.addItem('ğŸ”€ ä¸€éµæ‰‹å‹•æ´—ç‰Œé‡ç½®ï¼šBå€', 'shuffleB');
  
  // åˆ†éš”ç·š
  menu.addSeparator();
  
  // è‡ªå‹•åŒ–åŠŸèƒ½
  menu.addItem('ğŸ¤– å•Ÿå‹• 24H æ™ºæ…§ç›£æ§ç³»çµ±', 'setupAutoTrigger');
  menu.addItem('ğŸ› ï¸ åˆå§‹åŒ–ä¸¦ä¿®å¾©ç³»çµ±åˆ†é æ¶æ§‹', 'setupSystem');
  
  // å°‡é¸å–®æ›è¼‰è‡³ UI
  menu.addToUi();
  
  console.log(">>>> ç‡Ÿé‹é¸å–®åˆå§‹åŒ–å®Œæˆã€‚");
}

/**
 * [è‡ªå‹•åŒ–å¼•æ“éƒ¨ç½²] 
 * ç‰©ç†æ€§å»ºç«‹æ™‚é–“é©…å‹•è§¸ç™¼å™¨ (Time-driven Trigger)ã€‚
 * æ¯ 60 ç§’åŸ·è¡Œä¸€æ¬¡å·¡æª¢ï¼Œç¢ºä¿ç›¤é¢è™•æ–¼è‡ªå‹•ç‡Ÿé‹ç‹€æ…‹ã€‚
 */
function setupAutoTrigger() {
  
  console.log("é–‹å§‹ä½ˆç½² 24H æ™ºæ…§ç›£æ§å·¡æª¢ä»»å‹™...");
  
  var triggers = ScriptApp.getProjectTriggers();
  
  // å®‰å…¨æ¸…ç†ç¨‹åºï¼šç¢ºä¿ç³»çµ±å…§ä¸æœƒæœ‰å¤šå€‹ç›¸åŒçš„å·¡æª¢è§¸ç™¼å™¨åœ¨é‹è¡Œ
  for (var i = 0; i < triggers.length; i++) {
    
    var handlerFunctionName = triggers[i].getHandlerFunction();
    
    if (handlerFunctionName === 'autoCheckAndReshuffle') {
      
      console.log("ç™¼ç¾èˆŠè§¸ç™¼å™¨ä»»å‹™ï¼Œæ­£åœ¨åŸ·è¡Œç‰©ç†åˆªé™¤ï¼š" + handlerFunctionName);
      
      ScriptApp.deleteTrigger(triggers[i]);
      
    }
  }
  
  // æ­£å¼å»ºç«‹æ¯åˆ†é˜å·¡æª¢ä»»å‹™
  ScriptApp.newTrigger('autoCheckAndReshuffle')
    .timeBased()
    .everyMinutes(1)
    .create();
    
  console.log("ç›£æ§ä»»å‹™éƒ¨ç½²æˆåŠŸï¼Œ24H è‡ªå‹•åŒ–å¾ªç’°é–‹å•Ÿã€‚");
  
  SpreadsheetApp.getUi().alert("âœ… æ——è‰¦æ™ºæ…§ç›£æ§ç³»çµ±å·²æˆåŠŸå•Ÿå‹•ï¼\nç³»çµ±æ¯ 60 ç§’å°‡è‡ªå‹•æƒæå¤§çç‹€æ…‹ã€‚");
}

/** æ¨¡å¼æ‰‹å‹•å…¥å£å¿«æ·æ¸…å–® - ç‰©ç†å±•é–‹ */
function shuffleSingle() { 
  executeShuffle("å–®æŒ‘å¥—", false); 
}

function shuffleA() { 
  executeShuffle("Aå€", false); 
}

function shuffleB() { 
  executeShuffle("Bå€", false); 
}

// ==========================================================================
// [ç¬¬ä¸‰éƒ¨åˆ†ï¼šæ ¸å¿ƒåŠ©æ‰‹å‡½æ•¸æ¨¡çµ„ (Helper System)]
// ==========================================================================

/**
 * [æ ¸å¿ƒåŠ©æ‰‹] ç²å–è¨­å®šé è³‡è¨Šèˆ‡ F2 å„²å­˜æ ¼å–®æŠ½åƒ¹æ ¼
 * [v5.17.3 æ•ˆèƒ½å‡ç´š]ï¼šå¯¦ä½œ CacheService é˜²æ­¢é‡è¤‡è©¦ç®—è¡¨è®€å–ã€‚
 * ç§¤é‡åŸå‰‡ï¼šå–®æŠ½å®šåƒ¹çµ•å°é–å®šæ–¼åˆ†é ä¹‹ Row 2, Column F (F2)ã€‚
 * * @param {Spreadsheet} ss è©¦ç®—è¡¨å¯¦ä¾‹
 * @param {string} mode æ¨¡å¼åç¨±
 * @return {Object} åŒ…å«åœ–ç‰‡ Mapping èˆ‡å‹•æ…‹å–®åƒ¹çš„ç‰©ä»¶
 */
function getSettingsMap(ss, mode) {
  
  // [Cache Layer] å„ªå…ˆè©¢å•å¿«å–æ±  ---------------------------------------
  var cache = CacheService.getScriptCache();
  
  var cacheKey = "config_v5173_expanded_" + mode; 
  
  var cachedData = cache.get(cacheKey);

  if (cachedData) {
    
    console.log("ğŸš€ Cache Hit for Mode: " + mode);
    
    return JSON.parse(cachedData);
    
  }
  // --------------------------------------------------------------------

  // ç‰©ç†å±•é–‹ï¼šç¢ºä¿æ¨¡å¼åç¨±è™•ç†ç„¡èª¤
  var modeBaseName = mode.replace("_ç±¤ä½", "");
  
  var settingSheetInstance = ss.getSheetByName(modeBaseName);
  
  // åˆå§‹åŒ–å›å‚³é…ç½®åŒ…
  var configPackage = {
    images: {},
    cost: 100 
  };
  
  if (!settingSheetInstance) {
    
    console.error("Critical: æ‰¾ä¸åˆ°æŒ‡å®šæ¨¡å¼çš„è¨­å®šåˆ†é  [" + modeBaseName + "]");
    
    return configPackage;
    
  }
  
  // è®€å–è¨­å®šé å…¨é‡æ•¸æ“šçŸ©é™£
  var settingsDataMatrix = settingSheetInstance.getDataRange().getValues();
  
  console.log("æ­£åœ¨å¾åˆ†é  [" + modeBaseName + "] ç‰©ç†å°æ¥ F2 å®šåƒ¹é»...");
  
  // --- å®šåƒ¹é»è§£ææ ¸å¿ƒ (F2 = Index [1][5]) ---
  if (settingsDataMatrix.length > 1) {
    
    var f2CellValue = settingsDataMatrix[1][5];
    
    // åš´æ ¼æ•¸å­—é¡å‹æ ¡é©—
    if (f2CellValue !== "" && !isNaN(f2CellValue)) {
      
      configPackage.cost = Number(f2CellValue);
      
      console.log("F2 å®šåƒ¹æˆåŠŸç²å–ï¼šå–®åƒ¹ç‚º " + configPackage.cost + " P");
      
    } else {
      
      console.warn("F2 æ ¼ä½æ•¸æ“šç„¡æ•ˆï¼Œç³»çµ±è‡ªå‹•å›é€€è‡³ 100 é»");
      
      configPackage.cost = 100;
      
    }
    
  } else {
    
    console.warn("è¨­å®šåˆ†é æ ¼å¼ä¸å®Œæ•´ï¼Œç„¡æ³•è®€å– F2");
    
  }
  
  // --- åœ–ç‰‡åº«æ˜ å°„é‚è¼¯ (Aæ¬„åç¨±, Gæ¬„ URL) ---
  for (var i = 1; i < settingsDataMatrix.length; i++) {
    
    var prizeNameKey = settingsDataMatrix[i][0]; // Aæ¬„ä½ (ä¸»éµ)
    
    var prizeImageUrl = settingsDataMatrix[i][6]; // Gæ¬„ä½ (Index 6, åœ–ç‰‡URL)
    
    if (prizeNameKey && prizeNameKey !== "") {
      
      if (prizeImageUrl) {
        
        configPackage.images[prizeNameKey] = prizeImageUrl;
        
      } else {
        
        configPackage.images[prizeNameKey] = "https://placehold.co/200?text=Prize";
        
      }
      
    }
  }
  
  // [Cache Write Back] å¯«å…¥å¿«å–ï¼Œä¿å­˜ 600 ç§’ (10åˆ†é˜)
  try {
    
    cache.put(cacheKey, JSON.stringify(configPackage), 600);
    
    console.log("Cache Written for: " + mode);
    
  } catch (e) {
    
    console.warn("Cache Write Back Failed: " + e.toString());
    
  }

  return configPackage;
}

// ==========================================================================
// [ç¬¬å››éƒ¨åˆ†ï¼šçµ•å°çµ±æ²»å”è­°æ ¸å¿ƒ (Dominion Strategy)]
// ==========================================================================

/**
 * [çµ±æ²»æ¬Šæª¢æŸ¥]
 * æ­¤ç¨‹åºç‚ºã€Œéœ¸ç›¤ä¿è­·ã€çš„æ ¸å¿ƒã€‚
 * ç‰©ç†æƒæç›¤é¢ï¼Œç¢ºèªæ˜¯å¦æœ‰ã€Œéæœ¬äººä¸”æœªéæœŸã€çš„é–å®šã€‚
 * * @return {boolean} å…è¨±é€²å…¥å‰‡å‚³å› true
 */
function checkDominion(sheet, requestUid, now) {
  
  var lastRow = sheet.getLastRow();
  
  if (lastRow < 2) {
    return true; 
  }
  
  // ç‰©ç†å¯¬åº¦é–å®šï¼šè®€å– A åˆ° F æ¬„ (1-6)
  var dataMatrix = sheet.getRange(1, 1, lastRow, 6).getValues();
  
  var nowTimeTs = now.getTime();
  
  for (var i = 1; i < dataMatrix.length; i++) {
    
    var lTime = dataMatrix[i][4]; // Eæ¬„: é–å®šèµ·å§‹æ™‚é–“
    var lUser = dataMatrix[i][5]; // Fæ¬„: é–å®šäºº UID
    var pOwner = dataMatrix[i][2]; // Cæ¬„: å¾—ä¸»
    
    // è‹¥è©²ä½ç½®å°šæœªå”®å‡ºï¼Œä¸”å­˜åœ¨å…¶ä»–äººçš„é–å®š
    if (!pOwner || pOwner === "") {
      
      if (lTime && lUser) {
        
        if (String(lUser) !== String(requestUid)) {
          
          var lockStartTime = new Date(lTime).getTime();
          
          // åˆ¤å®šé–å®šæ˜¯å¦åœ¨ 180s ä¿è­·æœŸå…§
          if (nowTimeTs - lockStartTime < LOCK_DURATION) {
            
            console.warn("çµ±æ²»æ¬Šè¡çªï¼šUID [" + lUser + "] æ­£åœ¨éœ¸ä½”æ­¤æ©Ÿå°");
            
            return false; 
            
          }
        }
      }
    }
  }
  
  return true; 
}

/**
 * [çµ±æ²»æ¬Šå»¶é•·ï¼šç‰©ç†é–å®šå…¨å ´]
 * ç•¶ç©å®¶è³¼è²·å¾Œï¼ŒåŸ·è¡Œã€Œçµ•å°é ˜åœ°å®£ç¤ºã€ã€‚
 * å°‡ç›¤é¢ä¸Šæ‰€æœ‰ã€Œæœªå”®å‡ºã€çš„ä½ç½®å…¨éƒ¨é–å®šçµ¦è©²ç©å®¶ã€‚
 */
function extendDominion(sheet, requestUid, now) {
  
  var lastRow = sheet.getLastRow();
  
  if (lastRow < 2) {
    return;
  }
  
  // [é‡å¤§ä¿®å¾©] å¼·åˆ¶ getRange æŒ‡å‘ A-F æ¬„ (å¯¬åº¦ç‚º 6)ï¼Œè§£æ±ºè©¦ç®—è¡¨å ±éŒ¯
  var range = sheet.getRange(1, 1, lastRow, 6);
  
  var values = range.getValues();
  
  var isModified = false;
  
  for (var i = 1; i < values.length; i++) {
    
    // è‹¥ C æ¬„ç‚ºç©º (æœªå”®å‡º)
    if (!values[i][2] || values[i][2] === "") {
      
      values[i][4] = now;        // E æ¬„: é‡è¨­é–å®šæ™‚é–“
      values[i][5] = requestUid;  // F æ¬„: è¨­å®šç‚ºç•¶å‰è²·å®¶
      
      isModified = true;
      
    }
  }
  
  if (isModified) {
    
    // ç‰©ç†æ€§å°‡æ›´æ–°å¾Œçš„çŸ©é™£å¯«å›è©¦ç®—è¡¨
    range.setValues(values);
    
    console.log("çµ•å°çµ±æ²»é–å®šæˆåŠŸï¼šå·²ç‚ºç©å®¶ [" + requestUid + "] é–å®šå‰©é¤˜ç±¤ä½ã€‚");
    
  }
}

// ==========================================================================
// [ç¬¬äº”éƒ¨åˆ†ï¼šè³‡æ–™è®€å–æ ¸å¿ƒé‚è¼¯ (GET API)]
// ==========================================================================

/**
 * doGet å…¥å£å‡½æ•¸ï¼šè² è²¬è™•ç†å‰ç«¯ GitHub å‚³ä¾†çš„æ‰€æœ‰ã€Œè®€å–ã€è«‹æ±‚ã€‚
 */
function doGet(e) {
  
  var scriptLock = LockService.getScriptLock();
  
  try {
    
    // é€²å…¥æ•¸æ“šè®€å–ä¿è­·é– (5ç§’)
    scriptLock.waitLock(5000);
    
    var queryParams = e.parameter;
    
    var userUid = queryParams.uid;
    
    var playerDisplayName = queryParams.name || "å†’éšªè€…";
    
    var requestAction = queryParams.action || "sync"; 
    
    var appSpreadsheet = SpreadsheetApp.getActiveSpreadsheet();
    
    console.log(">>>> æ­£åœ¨è™•ç† GET è«‹æ±‚: Action=" + requestAction + ", UID=" + userUid);

    // --------------------------------------------------------------------------
    // A åˆ†æ”¯: [æˆ‘çš„å¯¶åº«è³‡ç”¢æª¢ç´¢ - åœ–ç‰‡å„ªåŒ–å®Œå…¨å±•é–‹]
    // --------------------------------------------------------------------------
    if (requestAction === "getMyPrizes") {
      
      var logSheet = appSpreadsheet.getSheetByName(LOG_SHEET_NAME);
      
      var playerAssets = [];
      
      var modeImageCache = {}; 
      
      if (logSheet) {
        
        var logsMatrix = logSheet.getDataRange().getValues();
        
        for (var row = logsMatrix.length - 1; row >= 1; row--) {
          
          if (String(logsMatrix[row][1]) === String(userUid)) {
            
            var currentModeName = logsMatrix[row][3]; 
            var currentPrizeName = logsMatrix[row][4];
            var prizeImgUrl = "https://placehold.co/200?text=No+Image";
            
            if (!modeImageCache[currentModeName]) {
              
              try {
                var settingsData = getSettingsMap(appSpreadsheet, currentModeName);
                modeImageCache[currentModeName] = settingsData.images;
              } catch (err) {
                modeImageCache[currentModeName] = {};
              }
              
            }
            
            if (modeImageCache[currentModeName] && modeImageCache[currentModeName][currentPrizeName]) {
              prizeImgUrl = modeImageCache[currentModeName][currentPrizeName];
            }

            playerAssets.push({
              time: Utilities.formatDate(new Date(logsMatrix[row][0]), "GMT+8", "yyyy-MM-dd HH:mm"),
              mode: currentModeName,
              prizeName: currentPrizeName,
              tid: logsMatrix[row][5],
              status: logsMatrix[row][8] || "åœ¨åº«",
              img: prizeImgUrl
            });
            
          }
          
          if (playerAssets.length >= 150) {
            break;
          }
          
        }
      }
      
      return ContentService.createTextOutput(JSON.stringify({
        status: "success",
        prizes: playerAssets
      })).setMimeType(ContentService.MimeType.JSON);
      
    }

    // --------------------------------------------------------------------------
    // B åˆ†æ”¯: [ç›¤é¢å¤§å»³æ•¸æ“šåŒæ­¥]
    // --------------------------------------------------------------------------
    var currentMode = queryParams.mode || "å–®æŒ‘å¥—";
    
    var ticketSheetName = currentMode.includes("_ç±¤ä½") ? currentMode : currentMode + "_ç±¤ä½";
    
    var tSheet = appSpreadsheet.getSheetByName(ticketSheetName) || appSpreadsheet.getSheetByName(currentMode);
    
    var uSheet = appSpreadsheet.getSheetByName(USER_SHEET_NAME);
    
    if (!tSheet) {
      throw new Error("æ•¸æ“šé€£ç·šç•°å¸¸ï¼šæ‰¾ä¸åˆ°ç›®æ¨™ç›¤é¢åˆ†é  [" + ticketSheetName + "]");
    }
    
    // é€é Cache ç²å–è¨­å®š
    var currentConfig = getSettingsMap(appSpreadsheet, currentMode);
    
    var nowTs = new Date().getTime();
    
    // --- ç©å®¶å¸³æˆ¶èˆ‡é»æ•¸æ ¡é©— ---
    var userBalance = 0;
    var userTable = uSheet.getDataRange().getValues();
    var userExists = false;
    
    for (var u = 1; u < userTable.length; u++) {
      if (String(userTable[u][0]) === String(userUid)) {
        userBalance = userTable[u][2];
        userExists = true;
        break;
      }
    }
    
    if (!userExists) {
      console.log("åµæ¸¬åˆ°æ–°ç©å®¶ï¼Œæ­£åœ¨åŸ·è¡Œè‡ªå‹•è¨»å†Š...");
      uSheet.appendRow([userUid, playerDisplayName, DEFAULT_POINTS, new Date()]);
      userBalance = DEFAULT_POINTS;
    }
    
    // --- ç±¤ç›¤çŸ©é™£æ·±åº¦è§£æ ---
    var gachaMatrix = tSheet.getDataRange().getValues();
    var processedTickets = [];
    var isBigPrizeOnGrid = false;
    var prizeInventoryTracker = {};
    
    for (var k = 1; k < gachaMatrix.length; k++) {
      
      var idVal = gachaMatrix[k][0];   
      var pNameVal = gachaMatrix[k][1]; 
      var takerVal = gachaMatrix[k][2]; 
      var lTimeVal = gachaMatrix[k][4]; 
      var lUserVal = gachaMatrix[k][5]; 
      
      var takenFlag = (takerVal != "" && takerVal != null);
      var lockedFlag = false;
      
      if (!takenFlag && lTimeVal) {
        var lockObj = new Date(lTimeVal);
        if (nowTs - lockObj.getTime() < LOCK_DURATION) {
          lockedFlag = true;
        }
      }
      
      // åˆ¤å®šå¤§çæ˜¯å¦å­˜åœ¨æ–¼ç›¤é¢
      if (/Aè³|SP|1è³|å¤§ç/i.test(pNameVal) && !takenFlag) {
        isBigPrizeOnGrid = true;
      }
      
      var imageResource = currentConfig.images[pNameVal] || "https://placehold.co/200?text=Prize";
      
      processedTickets.push({ 
        id: idVal,
        prizeName: pNameVal,
        isTaken: takenFlag,
        isLocked: lockedFlag,
        lockUser: lockedFlag ? lUserVal : null,
        img: imageResource 
      });
      
      if (pNameVal) {
        if (!prizeInventoryTracker[pNameVal]) {
          prizeInventoryTracker[pNameVal] = { name: pNameVal, img: imageResource, stock: 0 };
        }
        if (!takenFlag) {
          prizeInventoryTracker[pNameVal].stock++;
        }
      }
    }
    
    var finalResultPayload = {
      status: "success",
      userPoints: userBalance,
      tickets: processedTickets,
      cost: currentConfig.cost,
      bigPrizeExists: isBigPrizeOnGrid,
      prizeSummary: Object.values(prizeInventoryTracker)
    };
    
    return ContentService.createTextOutput(JSON.stringify(finalResultPayload)).setMimeType(ContentService.MimeType.JSON);
    
  } catch (err) {
    
    console.error("Critical doGet Error: " + err.toString());
    
    var errorResp = { status: "error", message: err.toString() };
    
    return ContentService.createTextOutput(JSON.stringify(errorResp)).setMimeType(ContentService.MimeType.JSON);
    
  } finally {
    scriptLock.releaseLock();
  }
}

// ==========================================================================
// [ç¬¬å…­éƒ¨åˆ†ï¼šäº¤æ˜“ã€æ‰£æ¬¾èˆ‡å‡ºè²¨æ§åˆ¶ (POST API)]
// ==========================================================================

function doPost(e) {
  
  var transactionLock = LockService.getScriptLock();
  
  try {
    
    transactionLock.waitLock(10000);
    
    var postPayload = JSON.parse(e.postData.contents);
    
    var appSS = SpreadsheetApp.getActiveSpreadsheet();
    
    var currentAction = postPayload.action || 'buy';
    
    var currentTime = new Date();
    
    console.log("---- å•Ÿå‹• POST è™•ç†ç¨‹åº ---- Action=" + currentAction);

    // --------------------------------------------------------------------------
    // å‹•ä½œ A: [ç”³è«‹å‡ºè²¨ Shipment Request]
    // --------------------------------------------------------------------------
    if (currentAction === 'requestShipment') {
      
      var logSheet = appSS.getSheetByName(LOG_SHEET_NAME);
      
      var logDataMatrix = logSheet.getDataRange().getValues();
      
      var updateCounter = 0;
      
      for (var l = 1; l < logDataMatrix.length; l++) {
        
        var currentLogUid = logDataMatrix[l][1];
        
        var currentLogPrize = logDataMatrix[l][4];
        
        var currentLogStatus = logDataMatrix[l][8];
        
        if (String(currentLogUid) === String(postPayload.uid) && String(currentLogPrize) === String(postPayload.prizeName)) {
          
          if (!currentLogStatus || currentLogStatus === "åœ¨åº«" || currentLogStatus === "") {
            
            logSheet.getRange(l + 1, 9).setValue("å¾…å‡ºè²¨");
            
            updateCounter++;
            
          }
        }
        
        if (updateCounter >= postPayload.amount) {
          break;
        }
        
      }
      
      return ContentService.createTextOutput(JSON.stringify({ 
        status: "success", count: updateCounter 
      })).setMimeType(ContentService.MimeType.JSON);
    }

    // --------------------------------------------------------------------------
    // å‹•ä½œ B: [æ©Ÿå°èˆ‡äº¤æ˜“é‚è¼¯æ¨¡çµ„]
    // --------------------------------------------------------------------------
    var modeTag = postPayload.mode;
    
    var ticketSheetName = modeTag.includes("_ç±¤ä½") ? modeTag : modeTag + "_ç±¤ä½";
    
    var currentTicketSheet = appSS.getSheetByName(ticketSheetName);
    
    var currentModeConfig = getSettingsMap(appSS, modeTag); 

    if (!currentTicketSheet) {
      throw "ç³»çµ±éŒ¯èª¤ï¼šç›®æ¨™ç›¤é¢éºå¤±ã€‚";
    }

    // [v5.16.1] æ­»äº¡é–‹é—œ (Kill Switch)
    if (currentAction === 'lock' || currentAction === 'buy') {
      
      var checkData = currentTicketSheet.getDataRange().getValues();
      
      for (var r = 1; r < checkData.length; r++) {
        
        var pName = checkData[r][1]; // Bæ¬„: çé …
        var pOwner = checkData[r][2]; // Cæ¬„: å¾—ä¸»
        
        if (/Aè³|SP|1è³|å¤§ç/i.test(pName) && pOwner && pOwner !== "") {
          throw "â›” å¤§çå·²è¢«æŠ½å‡ºï¼Œç›¤é¢å‡çµä¸­ï¼Œç„¡æ³•è³¼è²·ï¼";
        }
        
      }
    }

    // [Lock] çµ±æ²»æ¬Šé–å®šç¨‹åº
    if (currentAction === 'lock') {
      
      // 1. å…ˆç¢ºèªéœ¸ç›¤æ¬Š (checkDominion)
      if (!checkDominion(currentTicketSheet, postPayload.uid, currentTime)) {
        throw "â›” æ­¤æ©Ÿå°ç›®å‰ç”±å…¶ä»–ç©å®¶æ­£åœ¨éŠç©ä¸­ï¼Œè«‹ç¨å€™...";
      }

      // 2. åŸ·è¡Œç‰©ç†é–å®š
      var lastRow = currentTicketSheet.getLastRow();
      
      var range = currentTicketSheet.getRange(1, 1, lastRow, 6); // A-F æ¬„
      
      var values = range.getValues();
      
      postPayload.ticketIds.forEach(function(targetId) {
        
        for (var k = 1; k < values.length; k++) {
          
          if (String(values[k][0]) === String(targetId)) {
            
            if (values[k][2] && values[k][2] !== "") {
              throw "è©²ä½ç½®å·²è¢«æ¶å…ˆæŠ½èµ°ï¼";
            }
            
            values[k][4] = currentTime;    // E æ¬„: æ™‚é–“
            values[k][5] = postPayload.uid; // F æ¬„: é–å®šäºº
            break;
            
          }
        }
      });
      
      range.setValues(values);
      
      console.log("ç±¤ä½ç‰©ç†é–å®šæˆåŠŸã€‚");
      
      return ContentService.createTextOutput(JSON.stringify({ status: "success" })).setMimeType(ContentService.MimeType.JSON);
    }

    // [Buy] æ‰£é»èˆ‡é–‹çç¨‹åº
    if (currentAction === 'buy') {
      
      var userDB = appSS.getSheetByName(USER_SHEET_NAME);
      
      var buyResultsMatrix = []; 
      
      var totalCostValue = postPayload.ticketIds.length * currentModeConfig.cost;
      
      // å¸³æˆ¶æŸ¥è©¢
      var userValues = userDB.getDataRange().getValues();
      var uRowIdx = -1;
      var currentBalancePts = 0;
      
      for (var u = 1; u < userValues.length; u++) {
        if (String(userValues[u][0]) === String(postPayload.uid)) {
          uRowIdx = u + 1;
          currentBalancePts = userValues[u][2];
          break;
        }
      }
      
      if (uRowIdx === -1) throw "æ‰¾ä¸åˆ°ç”¨æˆ¶å¸³æˆ¶ã€‚";
      
      if (currentBalancePts < totalCostValue) {
        throw "é»æ•¸ä¸è¶³ä»¥å®Œæˆæ‰£æ¬¾ã€‚";
      }

      // ç›¤é¢æ›´æ–°
      var lastT = currentTicketSheet.getLastRow();
      var tRange = currentTicketSheet.getRange(1, 1, lastT, 6);
      var tValues = tRange.getValues();

      postPayload.ticketIds.forEach(function(targetId) {
        
        for (var k = 1; k < tValues.length; k++) {
          
          if (String(tValues[k][0]) === String(targetId)) {
            
            tValues[k][2] = postPayload.uid; // C æ¬„: å¡«å…¥å¾—ä¸»
            tValues[k][3] = currentTime;    // D æ¬„: äº¤æ˜“æ™‚é–“
            tValues[k][4] = ""; // æ¸…ç©º E
            tValues[k][5] = ""; // æ¸…ç©º F
            
            var pName = tValues[k][1];
            
            buyResultsMatrix.push({ id: targetId, name: pName, img: currentModeConfig.images[pName] });
            
            // å¯«å…¥ Log
            var logSheet = appSS.getSheetByName(LOG_SHEET_NAME);
            if (logSheet) {
              logSheet.appendRow([
                currentTime, postPayload.uid, postPayload.name, 
                modeTag, pName, targetId, Utilities.getUuid(), 
                Utilities.formatDate(currentTime, "GMT+8", "yyyy-MM-dd HH:mm:ss"), "åœ¨åº«"
              ]);
            }
            break;
            
          }
        }
      });
      
      tRange.setValues(tValues);
      
      // é»æ•¸æ‰£é™¤
      userDB.getRange(uRowIdx, 3).setValue(currentBalancePts - totalCostValue);
      
      // [v5.17.0 çµ•å°çµ±æ²»è€…å”è­°]ï¼šè³¼è²·å®Œæˆå¾Œï¼Œè‡ªå‹•é–å®šå…¨å ´å‰©é¤˜ç±¤ä½ (å°¾åˆ€ä¿è­·)
      extendDominion(currentTicketSheet, postPayload.uid, currentTime);

      return ContentService.createTextOutput(JSON.stringify({ 
        status: "success", 
        results: buyResultsMatrix 
      })).setMimeType(ContentService.MimeType.JSON);
    }
    
    // [Release] æ­¸é‚„æ©Ÿå° (é›¢é–‹æ©Ÿå°)
    if (currentAction === 'release') {
      
      console.log("ç©å®¶ [" + postPayload.uid + "] æ­£åœ¨ä¸»å‹•é‡‹æ”¾çµ±æ²»æ¬Š...");
      
      var lastR = currentTicketSheet.getLastRow();
      
      var rangeR = currentTicketSheet.getRange(1, 1, lastR, 6);
      
      var valsR = rangeR.getValues();
      
      var hasUpdatedR = false;
      
      for (var k = 1; k < valsR.length; k++) {
        
        if (String(valsR[k][5]) === String(postPayload.uid)) {
          
          valsR[k][4] = ""; // æ¸…é™¤æ™‚é–“
          valsR[k][5] = ""; // æ¸…é™¤ UID
          
          hasUpdatedR = true;
          
        }
      }
      
      if (hasUpdatedR) {
        rangeR.setValues(valsR);
      }
      
      return ContentService.createTextOutput(JSON.stringify({ status: "success" })).setMimeType(ContentService.MimeType.JSON);
    }

    // [Extend] å»¶é•·éœ¸ç›¤æ™‚é–“
    if (currentAction === 'extend') {
      
      var lastE = currentTicketSheet.getLastRow();
      
      var rangeE = currentTicketSheet.getRange(1, 1, lastE, 6);
      
      var valsE = rangeE.getValues();
      
      postPayload.ticketIds.forEach(function(tid) {
        
         for(var k = 1; k < valsE.length; k++) {
           
           if(String(valsE[k][0]) === String(tid) && String(valsE[k][5]) === String(postPayload.uid)) {
             
             valsE[k][4] = new Date(); // åˆ·æ–°é–å®šèµ·å§‹é»
             break;
             
           }
         }
      });
      
      rangeE.setValues(valsE);
      
      return ContentService.createTextOutput(JSON.stringify({ status: "success" })).setMimeType(ContentService.MimeType.JSON);
    }
    
  } catch (error) {
    
    console.error("Critical doPost Error: " + error.toString());
    
    return ContentService.createTextOutput(JSON.stringify({ 
      status: "error", message: error.toString() 
    })).setMimeType(ContentService.MimeType.JSON);
    
  } finally {
    transactionLock.releaseLock();
  }
}

// ==========================================================================
// [ç¬¬ä¸ƒéƒ¨åˆ†ï¼šç‡Ÿé‹å¼•æ“ - è‡ªå‹•åŒ–ç›£æ§èˆ‡ç‰©ç†æ´—ç‰Œ]
// ==========================================================================

/**
 * æ™ºæ…§å·¡æª¢ä»»å‹™
 */
function autoCheckAndReshuffle() {
  
  var spreadsheet = SpreadsheetApp.getActiveSpreadsheet();
  
  var sheets = spreadsheet.getSheets();
  
  var nowTs = new Date().getTime();
  
  sheets.forEach(function(s) {
    
    var name = s.getName();
    
    if (name.indexOf("_ç±¤ä½") > -1) {
      
      var data = s.getDataRange().getValues();
      
      var isGone = true; 
      
      var lastSaleTime = 0;
      
      for (var r = 1; r < data.length; r++) {
        
        if (/Aè³|SP|1è³|å¤§ç/i.test(data[r][1]) && (!data[r][2] || data[r][2] === "")) {
          isGone = false; 
          break; 
        }
        
        if (data[r][3]) { 
          var t = new Date(data[r][3]).getTime(); 
          if (t > lastSaleTime) lastSaleTime = t; 
        }
      }
      
      // å¤§çå®ŒæŠ½ ä¸” æ»¿ 5 åˆ†é˜é–’ç½®
      if (isGone && lastSaleTime > 0) {
        
        if (nowTs - lastSaleTime > AUTO_RESHUFFLE_DELAY) {
          
          console.log("ğŸš¨ ç¬¦åˆè‡ªå‹•æ´—ç‰Œæ¢ä»¶: " + name);
          
          executeShuffle(name.replace("_ç±¤ä½", ""), true); 
          
        }
      }
    }
  });
}

/**
 * ç‰©ç†æ´—ç‰Œæ ¸å¿ƒ
 */
function executeShuffle(modeName, isSilent) {
  
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  
  var sheet = ss.getSheetByName(modeName + "_ç±¤ä½") || ss.getSheetByName(modeName);
  
  if (!sheet) return;
  
  if (!isSilent) {
    var check = SpreadsheetApp.getUi().alert('âš ï¸ ç‰©ç†æ´—ç‰Œè­¦å ±', 'æ‚¨ç¢ºå®šè¦é‡ç½®ç›¤é¢å—ï¼Ÿ', SpreadsheetApp.getUi().ButtonSet.YES_NO);
    if (check != SpreadsheetApp.getUi().Button.YES) return;
  }
  
  // è³‡ç”¢å›æ”¶è‡³å›æ”¶ç«™
  var recycle = ss.getSheetByName(RECYCLE_SHEET_NAME);
  var data = sheet.getDataRange().getValues();
  if (recycle) {
    for (var i = 1; i < data.length; i++) {
      if (!data[i][2]) {
        recycle.appendRow([new Date(), modeName, data[i][0], data[i][1]]);
      }
    }
  }
  
  // ç‰©ç†éš¨æ©Ÿæ‰“äº‚ B æ¬„
  var last = sheet.getLastRow();
  if (last > 1) {
    
    var prizeRange = sheet.getRange(2, 2, last - 1, 1);
    var pArray = prizeRange.getValues();
    
    for (var j = pArray.length - 1; j > 0; j--) {
      var k = Math.floor(Math.random() * (j + 1));
      var temp = pArray[j][0];
      pArray[j][0] = pArray[k][0];
      pArray[k][0] = temp;
    }
    
    prizeRange.setValues(pArray);
    
    // å¾¹åº•æ¸…ç©º C, D, E, F æ¬„ä½
    sheet.getRange(2, 3, last - 1, 4).clearContent();
    
    console.log("ã€ç‰©ç†æ´—ç‰Œã€‘åˆ†é  [" + modeName + "] é‡ç½®å®Œæˆã€‚");
  }
}

/**
 * æ¶æ§‹è‡ªæª¢åˆå§‹åŒ–
 */
function setupSystem() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var schema = ["ä½¿ç”¨è€…", "ç¸½è¡¨", "å›æ”¶ç«™", "å–®æŒ‘å¥—", "å–®æŒ‘å¥—_ç±¤ä½"];
  schema.forEach(function(n) {
    if (!ss.getSheetByName(n)) {
      ss.insertSheet(n);
    }
  });
  SpreadsheetApp.getUi().alert("ğŸ”§ ç³»çµ±æ¶æ§‹æª¢ä¿®å®Œæˆã€‚");
}
