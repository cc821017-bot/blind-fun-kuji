<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚ä¸€ç•ªè³ - å¯¦é«”æ¨¡æ“¬ç›¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { 
            --kuji-red: #e63946; 
            --kuji-gold: #ffb627; 
            --card-bg: #1a1a2e;
            --ticket-taken: #050505;
        }
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #000; color: #fff; margin: 0; padding-bottom: 130px; }

        /* é ‚éƒ¨å°èˆª */
        .header-bar { display: flex; justify-content: space-between; padding: 12px 15px; background: #161625; border-bottom: 2px solid var(--kuji-red); position: sticky; top: 0; z-index: 100; }
        .user-pts { color: var(--kuji-gold); font-weight: bold; }

        /* æ¨¡å¼åˆ‡æ› */
        .tab-bar { display: flex; background: #111; border-bottom: 1px solid #333; }
        .tab { flex: 1; text-align: center; padding: 15px; font-weight: bold; color: #666; cursor: pointer; transition: 0.3s; }
        .tab.active { color: var(--kuji-red); background: rgba(230,57,70,0.1); border-bottom: 3px solid var(--kuji-red); }

        /* çç›¤å€åŸŸ */
        .plate-area { padding: 15px; }
        .plate-title { font-size: 0.9rem; color: #888; margin-bottom: 10px; display: flex; justify-content: space-between; }
        
        .kuji-plate {
            display: grid;
            grid-template-columns: repeat(8, 1fr); /* æ‰‹æ©Ÿç«¯æ¯æ’ 8 æ ¼ */
            gap: 6px;
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #222;
        }

        /* ç±¤ä½æ ¼å­ */
        .ticket {
            aspect-ratio: 1/1;
            background: #2d2d44;
            border: 1px solid #444;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: 900;
            color: rgba(255,255,255,0.3);
            position: relative;
            transition: 0.2s;
        }

        /* ç±¤ä½é¡è‰²åˆ†ç´š */
        .t-A { background: linear-gradient(135deg, #ff4757, #ff6b81) !important; color: #fff !important; box-shadow: 0 0 8px rgba(255,71,87,0.4); }
        .t-B { background: linear-gradient(135deg, #ffa502, #eccc68) !important; color: #fff !important; }
        .t-C { background: linear-gradient(135deg, #2ed573, #7bed9f) !important; color: #fff !important; }
        .t-D { background: linear-gradient(135deg, #1e90ff, #70a1ff) !important; color: #fff !important; }
        .t-normal { background: #57606f; color: #fff; }

        /* å·²æŠ½èµ°ç‹€æ…‹ */
        .ticket.taken { background: var(--ticket-taken) !important; border: 1px solid #222 !important; color: transparent !important; }
        .ticket.taken::after { content: 'æ¸ˆ'; color: #333; font-size: 10px; }

        /* æŠ½çå‹•ç•« */
        .ticket.active { transform: scale(1.25); z-index: 50; background: var(--kuji-gold) !important; color: #000 !important; box-shadow: 0 0 20px var(--kuji-gold); }

        /* åº•éƒ¨æ§åˆ¶å€ */
        .footer { position: fixed; bottom: 0; width: 100%; background: #111; padding: 20px 0; border-top: 1px solid #333; box-shadow: 0 -5px 20px rgba(0,0,0,0.8); }
        .btn-wrap { display: flex; gap: 12px; width: 90%; margin: 0 auto; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 50px; font-size: 1.1rem; font-weight: bold; color: #fff; cursor: pointer; transition: 0.2s; }
        .btn-s { background: #444; }
        .btn-m { background: linear-gradient(45deg, var(--kuji-red), #ff6b81); box-shadow: 0 4px 15px rgba(230,57,70,0.4); }
        .btn:disabled { opacity: 0.3; transform: scale(0.95); }
    </style>
</head>
<body>

<div class="header-bar">
    <div>ç©å®¶ï¼š<b id="disp-name">---</b></div>
    <div>é¤˜é¡ï¼š<b id="disp-points" class="user-pts">0</b> P</div>
</div>

<div class="tab-bar">
    <div class="tab active" onclick="changeMode('å–®æŒ‘å¥—')">å–®æŒ‘å¥—</div>
    <div class="tab" onclick="changeMode('Aå€')">Aå€</div>
    <div class="tab" onclick="changeMode('Bå€')">Bå€</div>
</div>

<div class="plate-area">
    <div class="plate-title">
        <span>â— å¯¦é«”ç±¤ä½æ¨¡æ“¬ç›¤</span>
        <span id="stock-info">è¼‰å…¥ä¸­...</span>
    </div>
    <div class="kuji-plate" id="main-plate">
        </div>
</div>

<div class="footer">
    <div style="text-align:center; margin-bottom:10px; font-weight:bold; color:var(--kuji-gold)">
        å–®æŠ½ï¼š<span id="cost-val">---</span> P
    </div>
    <div class="btn-wrap">
        <button id="btn-1" class="btn btn-s" onclick="handleDraw(1)">å–®æŠ½</button>
        <button id="btn-5" class="btn btn-m" onclick="handleDraw(5)">äº”é€£æŠ½</button>
    </div>
</div>

<script>
    const CONFIG = {
        GAS_URL: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec",
        LIFF_ID: "2009072982-6smlV2gu"
    };

    let state = { uid: "", name: "", points: 0, mode: "å–®æŒ‘å¥—", prizes: [], allTickets: [], isRunning: false };

    async function init() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            state.uid = profile.userId;
            state.name = profile.displayName;
            document.getElementById('disp-name').innerText = state.name;
            await syncData();
        } catch (err) { console.error(err); }
    }

    async function syncData() {
        // åˆ‡æ›æ¨¡å¼æ™‚æ¸…ç©ºç›¤é¢
        document.getElementById('main-plate').innerHTML = "";
        const res = await fetch(`${CONFIG.GAS_URL}?uid=${state.uid}&mode=${state.mode}&userName=${encodeURIComponent(state.name)}`);
        const data = await res.json();
        if(data.status === "success") {
            state.points = data.userPoints;
            state.prizes = data.prizes;
            state.cost = data.cost;
            document.getElementById('disp-points').innerText = state.points.toLocaleString();
            document.getElementById('cost-val').innerText = state.cost;
            buildVirtualPlate();
        }
    }

    function buildVirtualPlate() {
        let tempPool = [];
        let totalRemaining = 0;
        let totalCount = 0;

        state.prizes.forEach(p => {
            const level = p.name.charAt(0).toUpperCase();
            // å‰©é¤˜å¯æŠ½
            for(let i=0; i<p.stock; i++) {
                tempPool.push({ level: level, status: 'available', name: p.name });
                totalRemaining++;
            }
            // å·²è¢«æŠ½èµ°
            for(let i=0; i<(p.total - p.stock); i++) {
                tempPool.push({ level: level, status: 'taken', name: p.name });
            }
            totalCount += p.total;
        });

        // æ ¸å¿ƒï¼šéš¨æ©Ÿæ´—ç‰Œ (Fisher-Yates Shuffle)
        for (let i = tempPool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [tempPool[i], tempPool[j]] = [tempPool[j], tempPool[i]];
        }

        state.allTickets = tempPool;
        document.getElementById('stock-info').innerText = `å‰©é¤˜ ${totalRemaining} / ${totalCount}`;
        renderTickets();
    }

    function renderTickets() {
        const plate = document.getElementById('main-plate');
        plate.innerHTML = state.allTickets.map((t, i) => {
            const cssClass = (['A','B','C','D'].includes(t.level)) ? `t-${t.level}` : 't-normal';
            return `<div class="ticket ${t.status==='taken'?'taken':cssClass}" id="t-${i}">${t.status==='taken'?'':t.level}</div>`;
        }).join('');
    }

    function changeMode(m) {
        if(state.isRunning) return;
        state.mode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText.includes(m)));
        syncData();
    }

    async function handleDraw(count) {
        if(state.isRunning) return;
        if(state.points < state.cost * count) {
            Swal.fire("é»æ•¸ä¸è¶³", "è«‹è¯ç¹«åº—å“¡å„²å€¼é»æ•¸", "warning"); return;
        }

        state.isRunning = true;
        setBtns(false);

        // å•Ÿå‹•è·³å‹•å‹•ç•« (æ¨¡æ“¬éš¨æ©Ÿé¸ç±¤)
        let animationId = setInterval(() => {
            document.querySelectorAll('.ticket').forEach(el => el.classList.remove('active'));
            // åªåœ¨é‚„æ²’æŠ½èµ°çš„æ ¼å­ä¸­é¸å–
            const availIdx = state.allTickets.map((t,i) => t.status==='available'?i:-1).filter(i=>i!==-1);
            const rand = availIdx[Math.floor(Math.random() * availIdx.length)];
            const target = document.getElementById(`t-${rand}`);
            if(target) target.classList.add('active');
        }, 80);

        try {
            const res = await fetch(CONFIG.GAS_URL, {
                method: 'POST',
                body: JSON.stringify({ uid: state.uid, mode: state.mode, count: count })
            });
            const result = await res.json();
            
            clearInterval(animationId);
            if(result.status === "success") {
                showWin(result.results, result.remainingPoints);
            } else {
                throw new Error(result.message);
            }
        } catch (e) {
            clearInterval(animationId);
            Swal.fire("éŒ¯èª¤", e.message, "error");
            state.isRunning = false; setBtns(true);
            syncData();
        }
    }

    function showWin(results, newPoints) {
        // æŠ“å–çé …å°æ‡‰åœ–ç‰‡
        const html = results.map(res => {
            const p = state.prizes.find(x => x.name === res);
            return `<div class="animate__animated animate__jackInTheBox" style="margin-bottom:15px;">
                <img src="${p?.img || ''}" style="width:100px; height:100px; background:#fff; border-radius:10px; object-fit:contain;"><br>
                <b style="color:var(--kuji-red); font-size:1.2rem;">${res}</b>
            </div>`;
        }).join('');

        Swal.fire({
            title: 'ğŸ‰ æ­å–œä¸­çï¼',
            html: `<div style="max-height:350px; overflow-y:auto;">${html}</div>`,
            background: '#161625', color: '#fff', confirmButtonColor: '#e63946'
        });

        state.points = newPoints;
        state.isRunning = false;
        setBtns(true);
        syncData();
    }

    function setBtns(e) {
        document.getElementById('btn-1').disabled = !e;
        document.getElementById('btn-5').disabled = !e;
    }

    window.onload = init;
</script>
</body>
</html>
