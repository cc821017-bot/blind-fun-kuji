<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚-æ——è‰¦ä¸­å¿ƒ</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root { --red: #ff3e3e; --gold: #f1c40f; --dark: #050505; --sold: #1a1a1a; }
        body { font-family: sans-serif; background: var(--dark); color: #fff; margin: 0; padding-top: 115px; padding-bottom: 160px; height: 100vh; overflow: hidden; box-sizing: border-box; }
        .header { position: fixed; top: 0; width: 100%; z-index: 1000; background: #111; border-bottom: 2px solid var(--red); }
        .win-announcement { background: var(--red); color: #fff; height: 26px; font-size: 11px; font-weight: bold; overflow: hidden; position: relative; display: flex; align-items: center; }
        .user-pts { padding: 8px 15px; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center; background: #1a1a1a; }
        .marquee { background: #000; height: 26px; font-size: 11px; color: var(--gold); overflow: hidden; position: relative; display: flex; align-items: center; border-top: 1px solid #333; }
        .track { position: absolute; white-space: nowrap; animation: move 18s linear infinite; }
        @keyframes move { 0% { transform: translateX(100vw); } 100% { transform: translateX(-100%); } }
        .tabs { display: flex; justify-content: center; gap: 5px; padding: 10px; }
        .tab { flex: 1; padding: 10px; background: #222; border: 1px solid #444; color: #888; border-radius: 8px; font-size: 13px; cursor: pointer; }
        .tab.active { background: var(--red); color: #fff; border-color: var(--gold); }
        .board { width: 92vw; height: 92vw; max-width: 380px; max-height: 380px; margin: 0 auto; position: relative; display: grid; grid-template-columns: repeat(11, 1fr); grid-template-rows: repeat(11, 1fr); gap: 2px; background: #000; border: 4px solid #333; border-radius: 15px; padding: 5px; }
        .screen { grid-area: 3/3/10/10; background: #111; border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .lamp { background: #222; border-radius: 2px; font-size: 8px; display: flex; align-items: center; justify-content: center; color: #444; border: 1px solid #333; }
        .lamp.sold-out { background: var(--sold) !important; color: #333 !important; opacity: 0.3; }
        .active-b { background: var(--red) !important; color: #fff !important; box-shadow: 0 0 10px var(--red); z-index: 5; }
        .active-a { background: var(--gold) !important; color: #000 !important; box-shadow: 0 0 15px var(--gold); z-index: 5; }
        .skip-btn { margin-top: 10px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: #aaa; padding: 4px 15px; border-radius: 15px; font-size: 11px; z-index: 500; display: none; cursor: pointer; }
        .footer-btns { position: fixed; bottom: 85px; width: 100%; display: flex; justify-content: center; z-index: 1000; flex-direction: column; align-items: center; }
        .price-tag { color: var(--gold); font-size: 16px; font-weight: bold; margin-bottom: 8px; border: 1px solid var(--gold); padding: 2px 12px; border-radius: 12px; background: rgba(0,0,0,0.5); }
        .btn-draw { width: 135px; height: 52px; border-radius: 26px; border: none; font-weight: bold; color: #fff; margin: 0 8px; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(0,0,0,0.6); }
        .btn-draw:disabled { background: #222 !important; color: #555 !important; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; flex-direction: column; align-items: center; justify-content: center; }
        .res-box { width: 85%; background: #222; margin: 6px; padding: 10px; border-radius: 10px; border-left: 5px solid var(--red); display: flex; align-items: center; text-align: left; }
        .res-box.is-a { border-color: var(--gold); background: #2a2410; }
        .share-btn { background: #06C755; color: #fff; padding: 14px 0; border-radius: 30px; border: none; margin: 15px 0 5px; font-weight: bold; font-size: 18px; width: 80%; cursor: pointer; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <div class="win-announcement"><div class="track" id="win-track">ğŸŠ ç›²ç©æ¨‚ï¼šä¸€æŠ½å…¥é­‚ï¼ç¥å„ä½è€é—† A è³å¸¶å›å®¶ï¼ ğŸŠ</div></div>
        <div class="user-pts"><span>æˆ‘çš„é»æ•¸ï¼š<span id="pts">--</span> P</span><span style="font-size:10px; color:#666;" id="u-name">Loading...</span></div>
        <div class="marquee"><div class="track">ğŸ”¥ ç›²ç©æ¨‚å…¬å‘Šï¼šè«‹æˆªåœ–ä¸­çç•«é¢è¯ç¹«é ˜çã€‚åˆ†äº«åŠŸèƒ½å…¨é¢å„ªåŒ–ï¼ ğŸ”¥</div></div>
    </div>
    <div class="tabs">
        <button class="tab active" onclick="sw(0)">å–®æŒ‘å¥—</button>
        <button class="tab" onclick="sw(1)">ï¼¡å€ä»»é¸</button>
        <button class="tab" onclick="sw(2)">ï¼¢å€ä»»é¸</button>
    </div>
    <div class="board" id="board"><div class="screen"><img id="prev" style="width:85%; max-height:75%; object-fit:contain;" src="https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480"><div id="status" style="color:var(--gold); font-size:12px; margin-top:5px; height: 15px;"></div><button class="skip-btn" id="skip" onclick="skip()">è·³éå‹•ç•« â¯</button></div></div>
    <div id="info" style="font-size:12px; color:#888; margin-top:15px; font-weight: bold; text-align: center;">è³‡æ–™é€£ç·šä¸­...</div>
    <div class="footer-btns">
        <div class="price-tag" id="price-tag">é‡‘é¡ï¼šè®€å–ä¸­...</div>
        <div style="display:flex;"><button class="btn-draw" style="background:#333;" id="b1" onclick="draw(1)">å–®æŠ½ä¸€æ¬¡</button><button class="btn-draw" style="background:var(--red);" id="b5" onclick="draw(5)">äº”é€£æŠ½ï¼</button></div>
    </div>
    <div id="win" class="overlay"><h2 style="color:var(--gold); font-size:26px; margin: 0;">ğŸ‰ æ­å–œä¸­ç</h2><div id="list" style="width:100%; display:flex; flex-direction:column; align-items:center; margin-top: 10px;"></div><div class="share-btn" onclick="shareFinal()">åˆ†äº«å–œæ‚…åˆ° LINE â¯</div><button onclick="location.reload()" style="color:#aaa; background:none; border:none; text-decoration:underline; cursor: pointer; margin-top: 10px;">ç¢ºèªæ”¶ä¸‹</button></div>
    
    <audio id="snd-tick" src="https://assets.mixkit.co/active_storage/sfx/2571/2571-preview.mp3"></audio>
    <audio id="snd-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>

    <script>
        const API = "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec";
        const POOLS = ["å–®æŒ‘å¥—", "ï¼¡å€ä»»é¸", "ï¼¢å€ä»»é¸"];
        const IMGS = ["https://cdn.store-assets.com/s/1337546/i/92974511.png?width=480", "https://i.meee.com.tw/d2cFJiy.jpg", "https://i.meee.com.tw/B8xVcyj.jpg"];
        const B_IMG = "https://static2.oneone.com.tw/store/270/p1-1762420831-oEF9ptc0.jpg";
        let uid="", userName="", allData={}, isAnim=false, curIdx=0, finalRes=null, ptrs=[];
        const coords = []; for(let i=1;i<=11;i++) coords.push({r:1,c:i}); for(let i=2;i<=11;i++) coords.push({r:i,c:11}); for(let i=10;i>=1;i--) coords.push({r:11,c:i}); for(let i=10;i>=2;i--) coords.push({r:i,c:1});
        const tickSnd = document.getElementById('snd-tick'); const winSnd = document.getElementById('snd-win');

        function init() { const b = document.getElementById('board'); coords.forEach((p,i)=>{ const d = document.createElement('div'); d.className='lamp'; d.id='l-'+i; d.style.gridRow=p.r; d.style.gridColumn=p.c; d.innerText=(i===0||i===20)?'A':'B'; b.appendChild(d); }); }
        
        async function liffInit() {
            try {
                await liff.init({ liffId: "2009072982-6smlV2gu" });
                if(!liff.isLoggedIn()){ liff.login(); return; }
                const p = await liff.getProfile(); uid = p.userId; userName = p.displayName;
                document.getElementById('u-name').innerText = userName;
                fetchData(userName);
            } catch(e) { console.error(e); }
        }

        function fetchData(n) {
            const s1 = document.createElement('script'); s1.src=`${API}?action=getPoolStatus&callback=cb1`; document.body.appendChild(s1);
            const s2 = document.createElement('script'); s2.src=`${API}?action=checkUser&uid=${uid}&name=${encodeURIComponent(n)}&callback=cb2`; document.body.appendChild(s2);
        }

        window.cb1 = (r) => { allData = r.stocks || r.data || r; upd(); };
        window.cb2 = (r) => { document.getElementById('pts').innerText = r.points !== undefined ? r.points : 0; };

        function sw(i) { if(isAnim) return; curIdx=i; document.getElementById('prev').src = IMGS[i]; document.querySelectorAll('.tab').forEach((b,j)=>b.className=i===j?'tab active':'tab'); upd(); }
        
        function upd() {
            const d = allData[POOLS[curIdx]]; if(!d) return;
            document.getElementById('info').innerText = `å‰©é¤˜ï¼š${d.total} (A:${d.a} B:${d.b})`;
            let price = (curIdx === 0) ? 360 : (curIdx === 1 ? 280 : 220);
            document.getElementById('price-tag').innerText = `å–®æŠ½é‡‘é¡ï¼š${d.price || price} P`;
            const b1=document.getElementById('b1'), b5=document.getElementById('b5');
            b1.disabled = b5.disabled = (d.a <= 0); b1.innerText = d.a <= 0 ? "å·²å”®ç½„" : "å–®æŠ½ä¸€æ¬¡";
            document.querySelectorAll('.lamp').forEach(l=>l.classList.remove('sold-out'));
            for(let i=39; i > 39 - (40 - d.total); i--) { const el = document.getElementById('l-'+i); if(el) el.classList.add('sold-out'); }
        }

        function draw(c) {
            if(isAnim || !userName) return; 
            const d = allData[POOLS[curIdx]]; 
            const myPts = parseInt(document.getElementById('pts').innerText);
            let p = (curIdx === 0) ? 360 : (curIdx === 1 ? 280 : 220);
            const cost = (d.price || p) * c;
            if(myPts < cost) { alert("é»æ•¸ä¸è¶³ï¼"); return; }
            
            isAnim=true;
            document.getElementById('b1').disabled = document.getElementById('b5').disabled = true;
            document.getElementById('skip').style.display='block';
            document.getElementById('status').innerText = "é‹å‹¢å‡èšä¸­...";
            
            const s = document.createElement('script'); 
            s.src=`${API}?action=draw&uid=${uid}&name=${encodeURIComponent(userName)}&poolId=${encodeURIComponent(POOLS[curIdx])}&count=${c}&callback=cb3`; 
            document.body.appendChild(s);
            
            ptrs = Array.from({length:c},(_,i)=>({p:(i*3)%40, s:false, t:null, d:0}));
            const anim = () => {
                if(!isAnim) return; document.querySelectorAll('.lamp').forEach(l=>l.classList.remove('active-a','active-b'));
                let stopAll=true; ptrs.forEach((p,i)=>{
                    if(!p.s){ stopAll=false; if(p.t!==null){ p.d++; if(p.d%(i+1)===0) { p.p=(p.p+1)%40; if(i===0) { tickSnd.currentTime=0; tickSnd.play().catch(()=>{}); } } if(p.p===p.target && p.d > (i*12+5)) p.s=true; } else { p.p=(p.p+1)%40; if(i===0) { tickSnd.currentTime=0; tickSnd.play().catch(()=>{}); } } }
                    const el=document.getElementById('l-'+p.p); if(el) el.classList.add(el.innerText==='A'?'active-a':'active-b');
                });
                if(stopAll) { winSnd.play().catch(()=>{}); setTimeout(show, 1500); } else setTimeout(anim, 60);
            }; anim();
        }

        window.cb3 = (r) => {
            if(r.status==='success'){
                finalRes = r.results.sort((a,b)=>a.grade==='A'?1:-1);
                document.getElementById('pts').innerText = r.remainingPoints;
                if(finalRes.some(x=>x.grade==='A')) { document.getElementById('win-track').innerText = `ğŸ‰ æ­å–œ ${userName} æŠ½ä¸­ ${POOLS[curIdx]} Aè³ï¼çœŸçš„å¼·ï¼ ğŸ‰`; }
                const avA=[], avB=[]; for(let i=0;i<40;i++){ const el=document.getElementById('l-'+i); if(!el.classList.contains('sold-out')){ (el.innerText==='A'?avA:avB).push(i); } }
                finalRes.forEach((x,i)=>{ const l=x.grade==='A'?avA:avB; const ti=Math.floor(Math.random()*l.length); ptrs[i].target=l[ti]; l.splice(ti,1); setTimeout(()=>{ptrs[i].t=true;}, i*250); });
            } else { alert(r.message); location.reload(); }
        }

        function skip() { isAnim=false; winSnd.play().catch(()=>{}); show(); }
        function show() {
            isAnim=false; document.getElementById('skip').style.display='none';
            document.getElementById('win').style.display='flex';
            document.getElementById('list').innerHTML = finalRes.map(x=>`<div class="res-box ${x.grade==='A'?'is-a':''}"><img src="${x.grade==='A'?IMGS[curIdx]:B_IMG}" style="width:50px;height:50px;border-radius:5px;margin-right:12px;object-fit:cover;"><div><b>${x.grade}è³</b><br><small>${x.name}</small></div></div>`).join('');
        }
        
        function shareFinal() {
            const txt = finalRes.map(x=>`ã€${x.grade}è³ã€‘${x.name}`).join('\n');
            const liffUrl = "https://liff.line.me/2009072982-6smlV2gu";
            
            if (liff.isApiAvailable('shareTargetPicker')) {
                liff.shareTargetPicker([
                    {
                        "type": "flex",
                        "altText": "ç›²ç©æ¨‚æŠ½çä¸­çé€šçŸ¥ï¼",
                        "contents": {
                            "type": "bubble",
                            "hero": { "type": "image", "url": IMGS[curIdx], "size": "full", "aspectRatio": "20:13", "aspectMode": "cover" },
                            "body": {
                                "type": "box", "layout": "vertical", "contents": [
                                    { "type": "text", "text": "ç›²ç©æ¨‚ - å¹¸é‹ä¸­çï¼", "weight": "bold", "color": "#ff3e3e", "size": "xl" },
                                    { "type": "text", "text": "ä¸­ççµæœå¦‚ä¸‹ï¼š", "margin": "md" },
                                    { "type": "text", "text": txt, "wrap": true, "size": "xs", "margin": "lg", "color": "#888888" }
                                ]
                            },
                            "footer": {
                                "type": "box", "layout": "vertical", "contents": [
                                    { "type": "button", "action": { "type": "uri", "label": "æˆ‘ä¹Ÿè¦æŠ½ï¼", "uri": liffUrl }, "style": "primary", "color": "#ff3e3e" }
                                ]
                            }
                        }
                    }
                ]).then(res => {
                    if (!res) {
                        // æ¬Šé™æœªé–‹æˆ–ä½¿ç”¨è€…å–æ¶ˆæ™‚ï¼Œèµ°å‚™æ¡ˆ
                        window.location.href = `https://line.me/R/msg/text/?ç›²ç©æ¨‚ä¸­çå•¦ï¼\n${encodeURIComponent(txt)}\næˆ‘ä¹Ÿè¦æŠ½ï¼š${liffUrl}`;
                    }
                }).catch(err => {
                    window.location.href = `https://line.me/R/msg/text/?ç›²ç©æ¨‚ä¸­çå•¦ï¼\n${encodeURIComponent(txt)}\næˆ‘ä¹Ÿè¦æŠ½ï¼š${liffUrl}`;
                });
            } else {
                window.location.href = `https://line.me/R/msg/text/?ç›²ç©æ¨‚ä¸­çå•¦ï¼\n${encodeURIComponent(txt)}\næˆ‘ä¹Ÿè¦æŠ½ï¼š${liffUrl}`;
            }
        }
        init(); liffInit();
    </script>
</body>
</html>
