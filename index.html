<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç›²ç©æ¨‚ - å¯¦é«”ç±¤ä½ç›¤</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --red: #e63946; --gold: #ffb627; --bg: #0a0a12; --ticket-bg: #1f1f2e; }
        body { font-family: 'Noto Sans TC', sans-serif; background: var(--bg); color: #fff; margin: 0; padding-bottom: 20px; }
        
        /* é ‚éƒ¨å°èˆª */
        .header { display: flex; justify-content: space-between; padding: 15px; background: #161625; border-bottom: 2px solid var(--red); position: sticky; top: 0; z-index: 100; }
        .u-pts { color: var(--gold); font-weight: bold; }

        /* åˆ†å€åˆ‡æ› */
        .tabs { display: flex; background: #000; border-bottom: 1px solid #333; overflow-x: auto; }
        .tab { flex: 1; text-align: center; padding: 15px; color: #666; cursor: pointer; font-weight: bold; min-width: 80px; transition: 0.3s; }
        .tab.active { color: var(--red); background: rgba(230,57,70,0.1); border-bottom: 3px solid var(--red); }

        /* ç±¤ç›¤å€åŸŸ */
        .plate-area { padding: 15px; }
        .grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr); 
            gap: 6px;
            background: #111;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #333;
        }

        .ticket {
            aspect-ratio: 1/1;
            background: var(--ticket-bg);
            border: 1px solid #444;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: bold;
            color: #888;
            cursor: pointer;
            transition: 0.2s;
            position: relative;
        }

        /* å·²æŠ½èµ°ç‹€æ…‹ (æ¸ˆ) */
        .ticket.taken {
            background: #050505 !important;
            color: #333 !important;
            border: 1px solid #222 !important;
            cursor: default;
        }
        .ticket.taken::after { content: 'æ¸ˆ'; position: absolute; font-size: 10px; }

        .ticket:not(.taken):hover {
            border-color: var(--gold);
            transform: scale(1.1);
            z-index: 10;
            color: #fff;
        }

        /* è®€å–ä¸­é®ç½© */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none;
            flex-direction: column; justify-content: center; align-items: center; z-index: 1000;
        }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">è™•ç†ä¸­...</div>

<div class="header">
    <div>ç©å®¶ï¼š<b id="u-name">---</b></div>
    <div>é¤˜é¡ï¼š<b id="u-pts" class="u-pts">0</b> P</div>
</div>

<div class="tabs">
    <div class="tab active" onclick="changeMode('å–®æŒ‘å¥—')">å–®æŒ‘å¥—</div>
    <div class="tab" onclick="changeMode('Aå€')">Aå€</div>
    <div class="tab" onclick="changeMode('Bå€')">Bå€</div>
</div>

<div class="plate-area">
    <div id="msg" style="margin-bottom:10px; font-size:0.85rem; color:#888;">æ­£åœ¨åˆå§‹åŒ–ç›¤é¢...</div>
    <div class="grid" id="main-grid"></div>
</div>

<script>
    const CONFIG = {
        GAS_URL: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec",
        LIFF_ID: "2009072982-6smlV2gu"
    };

    let state = { uid: "", mode: "å–®æŒ‘å¥—", tickets: [] };

    async function init() {
        try {
            await liff.init({ liffId: CONFIG.LIFF_ID });
            if (!liff.isLoggedIn()) { liff.login(); return; }
            const profile = await liff.getProfile();
            state.uid = profile.userId;
            document.getElementById('u-name').innerText = profile.displayName;
            await sync();
        } catch (err) {
            document.getElementById('msg').innerText = "è«‹åœ¨ LINE ä¸­é–‹å•Ÿæ‡‰ç”¨ç¨‹å¼";
        }
    }

    async function sync() {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = ""; // æ¸…ç©ºèˆŠç›¤
        document.getElementById('msg').innerText = `æ­£åœ¨è®€å– ${state.mode} ç›¤é¢æ•¸æ“š...`;
        
        try {
            const res = await fetch(`${CONFIG.GAS_URL}?uid=${state.uid}&mode=${state.mode}`);
            const data = await res.json();
            
            if(data.status === "success") {
                state.tickets = data.tickets; 
                document.getElementById('u-pts').innerText = data.userPoints.toLocaleString();
                document.getElementById('msg').innerText = `å·²æˆåŠŸè¼‰å…¥ ${state.mode}ï¼Œå…±è¨ˆ ${state.tickets.length} ç±¤`;
                render();
            } else {
                document.getElementById('msg').innerText = "éŒ¯èª¤: " + data.message;
            }
        } catch (e) {
            document.getElementById('msg').innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–æ´—ç‰Œç‹€æ…‹";
        }
    }

    function render() {
        const container = document.getElementById('main-grid');
        container.innerHTML = state.tickets.map(t => `
            <div class="ticket ${t.isTaken ? 'taken' : ''}" onclick="draw(${t.id})">
                ${t.isTaken ? '' : t.id}
            </div>
        `).join('');
    }

    async function draw(ticketId) {
        const target = state.tickets.find(t => t.id === ticketId);
        if(!target || target.isTaken) return;

        const result = await Swal.fire({
            title: `ç¢ºå®šæŠ½å– ${ticketId} è™Ÿï¼Ÿ`,
            background: '#161625', color: '#fff',
            showCancelButton: true, confirmButtonColor: '#e63946',
            confirmButtonText: 'ç¢ºå®š', cancelButtonText: 'å–æ¶ˆ'
        });

        if(result.isConfirmed) {
            document.getElementById('loader').style.display = 'flex';
            try {
                const res = await fetch(CONFIG.GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify({ uid: state.uid, mode: state.mode, ticketId: ticketId })
                });
                const final = await res.json();
                document.getElementById('loader').style.display = 'none';

                if(final.status === "success") {
                    await Swal.fire({
                        title: 'ğŸŠ æ­æ›‰çé …',
                        html: `<b style="font-size:1.5rem; color:#e63946">${final.prizeName}</b>`,
                        background: '#161625', color: '#fff'
                    });
                    await sync(); 
                } else {
                    Swal.fire("éŒ¯èª¤", final.message, "error");
                }
            } catch (e) {
                document.getElementById('loader').style.display = 'none';
                Swal.fire("éŒ¯èª¤", "é€£ç·šè¶…æ™‚", "error");
            }
        }
    }

    function changeMode(m) {
        state.mode = m;
        document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.innerText.includes(m)));
        sync();
    }

    window.onload = init;
</script>
</body>
</html>
