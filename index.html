<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç›²ç©æ¨‚ 5.17.2 æ——è‰¦çµæ§‹ç©©å®šç‰ˆ</title>
    
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=Oswald:wght@500;700&family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           [SECTION 2: æ ¸å¿ƒä½ˆå±€æ¨£å¼ - æ•‘å›å´©æ½°çš„ä»‹é¢]
           ========================================= */
        :root { 
            --bg-dark: #0a0a0a; --bg-card: #141414; --gold-primary: #D4AF37;
            --gold-gradient: linear-gradient(135deg, #F7E2A0, #D4AF37, #A67C00);
            --status-red: #E74C3C; --status-green: #2ECC71; --status-blue: #3498DB;
            --text-primary: #FFFFFF; --text-secondary: #A0A0A0; --glass-bg: rgba(20, 20, 20, 0.98);
        }
        
        /* åŸºç¤çµæ§‹é‡è¨­ */
        body { 
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background: radial-gradient(circle at top center, #1a1a2e, var(--bg-dark));
            color: var(--text-primary); margin: 0; 
            padding-bottom: 450px; /* ç‰©ç†ç©ºé–“ï¼šé˜²æ­¢åº•åº§é®æ“‹å…§å®¹ */
            overflow-x: hidden; transform: translateZ(0); -webkit-font-smoothing: antialiased;
        }

        /* [æ ¸å¿ƒä¿®æ­£ï¼šåœ–ç‰‡éœ¸æ¬Šç³»çµ±] */
        .img-container-moderate { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* æ™®çï¼šç¸®å° 60% */
        .t-matrix-cell:not(.is-big-taken) .img-container-moderate img,
        .p-show-box:not(.is-premium) .img-container-moderate img,
        .v-asset-card:not(.is-premium) .v-asset-icon img {
            max-width: 60% !important; max-height: 60% !important; object-fit: contain;
        }

        /* å¤§çï¼šæ“´å¼µ 95% */
        .t-matrix-cell.is-big-taken .img-container-moderate img,
        .p-show-box.is-premium .img-container-moderate img,
        .v-asset-card.is-premium .v-asset-icon img {
            max-width: 95% !important; max-height: 95% !important; object-fit: contain; transform: scale(1.1);
        }

        /* [é—œéµä¿®æ­£ï¼šåº•éƒ¨å°èˆªçµ•å°é–å®šæ–¼ Viewport] */
        .absolute-fixed-dock-hub { 
            position: fixed !important; bottom: 0 !important; left: 0; right: 0; 
            width: 100% !important; z-index: 1000; 
            background: rgba(10, 10, 10, 0.98); backdrop-filter: blur(45px);
            -webkit-backdrop-filter: blur(45px);
            border-top: 1px solid rgba(255,255,255,0.15);
            padding: 22px 25px calc(25px + env(safe-area-inset-bottom)); 
            border-radius: 50px 50px 0 0; box-shadow: 0 -35px 80px rgba(0,0,0,1);
            transition: transform 0.45s cubic-bezier(0.2, 1, 0.3, 1);
            box-sizing: border-box;
        }

        /* å½ˆçª—å‡ºç¾æ™‚è‡ªå‹•éš±è—åº•åº§ */
        body.swal2-shown .absolute-fixed-dock-hub { transform: translateY(115%); opacity: 0; pointer-events: none; }

        /* [å¤§å»³ä½ˆå±€æ¸²æŸ“] */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 20px 25px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(10,10,10,0.5); }
        .u-balance-pts { font-family: 'Oswald'; font-size: 2rem; font-weight: 700; color: var(--gold-primary); }

        .stats-hub { display: flex; justify-content: space-around; background: #111; padding: 25px; margin: 20px; border-radius: 24px; border: 1px solid #222; }
        .stat-item { text-align: center; }
        .stat-val-text { font-family: 'Oswald'; font-size: 2rem; display: block; }
        
        .gacha-grid-matrix { display: grid; grid-template-columns: repeat(5, 1fr); gap: 15px; padding: 20px; }
        .t-matrix-cell { 
            aspect-ratio: 1/1; background: linear-gradient(145deg, #2a2a2a, #1a1a1a);
            border-radius: 20px; border: 1px solid rgba(255,255,255,0.06); 
            display: flex; align-items: center; justify-content: center; position: relative;
            cursor: pointer; transition: 0.25s;
        }
        .t-matrix-cell.is-selected { background: var(--gold-gradient) !important; color: #000 !important; transform: translateY(-15px); z-index: 10; box-shadow: 0 15px 30px rgba(212,175,55,0.4); }
        .t-matrix-cell.is-taken { opacity: 0.4; background: #000; cursor: not-allowed; }
        .t-matrix-cell.is-taken::after { content: 'âœ•'; position: absolute; color: var(--status-red); font-size: 3.5rem; font-weight: 900; }
        .t-matrix-cell.is-big-taken { border: 2.8px solid var(--gold-primary); background: #1a1a00; }
        .t-matrix-cell.is-big-taken::before { content: 'ğŸ‘‘'; position: absolute; font-size: 1.5rem; top: 4px; left: 4px; z-index: 999; }

        /* [å¯¶åº«èˆ‡æ”¶è—æ¨£å¼] */
        .v-asset-card { 
            background: linear-gradient(145deg, #1e1e1e, #0c0c0c); border-radius: 26px; 
            padding: 22px; display: flex; align-items: center; gap: 22px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden;
        }
        .v-asset-card.is-premium { border: 2px solid var(--gold-primary); animation: borderAura 3s infinite alternate; }
        @keyframes borderAura { 0% { border-color: #D4AF37; } 100% { border-color: #F7E2A0; box-shadow: 0 0 50px rgba(212,175,55,0.4); } }
        .v-asset-icon { width: 75px; height: 75px; background: rgba(255,255,255,0.03); border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 2.2rem; }
        .v-qty-stack { font-family: 'Oswald'; font-size: 1.5rem; color: var(--gold-primary); font-weight: 700; margin-left: 10px; }

        /* æŒ‰éˆ•èˆ‡å·¥å…· */
        .btn-checkout-master { border: none; padding: 22px; border-radius: 24px; background: var(--gold-gradient); color: #000; font-weight: 900; font-size: 1.6rem; cursor: pointer; transition: 0.3s; }
        .btn-checkout-master:disabled { background: #222; color: #444; opacity: 0.5; }
        .nav-item { flex: 1; text-align: center; padding: 16px; border-radius: 18px; color: #666; background: #111; font-weight: 900; cursor: pointer; }
        .nav-item.active { background: #fff; color: #000; box-shadow: 0 8px 15px rgba(255,255,255,0.2); }
    </style>
</head>

<body>
    <div id="global-boot-loader" style="position:fixed; inset:0; background:#000; z-index:30000; display:flex; flex-direction:column; justify-content:center; align-items:center;">
        <div style="width:80px; height:80px; border:6px solid transparent; border-top-color:var(--gold-primary); border-radius:50%; animation:spin 1s infinite linear;"></div>
        <p style="margin-top:30px; color:var(--gold-primary); font-weight:900; letter-spacing:5px; font-family:'Oswald';">TREASURY SYNC...</p>
    </div>

    <div class="header">
        <div class="u-info-section">
            <span style="font-size:0.65rem; color:#444; font-weight:900; letter-spacing:2px;">ADVENTURER</span>
            <div id="player-name" style="font-weight:900; font-size:1.2rem;">Guest</div>
        </div>
        <div class="u-balance-pts" id="player-pts">0</div>
    </div>

    <div class="nav-segment-bar" style="display:flex; padding:15px 20px; gap:15px;">
        <div id="nav-btn-home" class="nav-item active" onclick="handlePageSwitch('home')">æ¢ç´¢çæ± </div>
        <div id="nav-btn-vault" class="nav-item" onclick="handlePageSwitch('vault')">æˆ‘çš„å¯¶åº«</div>
    </div>

    <div id="home-page">
        <div class="stats-hub">
            <div class="stat-item"><span class="stat-val-text" id="stat-rem">0</span><span style="font-size:0.7rem; color:#666; font-weight:900;">å‰©é¤˜æšæ•¸</span></div>
            <div class="stat-item" style="border-left: 1px solid #222; border-right: 1px solid #222; padding: 0 25px;"><span class="stat-val-text" id="stat-big" style="color:var(--gold-primary)">0</span><span style="font-size:0.7rem; color:var(--gold-primary); font-weight:900;">å¤§çåœ¨åº«</span></div>
            <div class="stat-item"><span class="stat-val-text" id="stat-rate" style="color:var(--status-blue)">0%</span><span style="font-size:0.7rem; color:#666; font-weight:900;">å‹ç‡</span></div>
        </div>

        <div class="m-selector-row" style="display:flex; gap:15px; padding:0 20px 20px;">
            <div id="mode-1" class="nav-item active" style="flex:1;" onclick="handleModeSwitch('å–®æŒ‘å¥—')">å–®æŒ‘å¥—</div>
            <div id="mode-2" class="nav-item" style="flex:1;" onclick="handleModeSwitch('Aå€')">Aå€</div>
        </div>

        <div id="lobby-prize-gallery" style="display:flex; overflow-x:auto; padding:0 20px 20px; gap:18px; scrollbar-width:none;"></div>
        <div id="main-ticket-grid" class="gacha-grid-matrix"></div>
    </div>

    <div id="vault-page" style="display:none;">
        <div style="padding:25px;">
            <span style="font-family:'Oswald'; font-size:0.85rem; color:var(--gold-primary); letter-spacing:3px; font-weight:700;">TREASURY COLLECTION</span>
            <h2 style="font-weight:900; font-size:2.3rem; margin:5px 0 0 0;">æ”¶è—è³‡ç”¢åº«</h2>
            <p style="color:#555; font-weight:700; font-size:0.85rem; margin-top:5px;">æ™ºæ…§æ­¸ç´ç³»çµ±å·²è‡ªå‹•å †ç–Šæ™®çè³‡ç”¢</p>
        </div>
        <div id="vault-items-container" style="padding:0 20px;"></div>
    </div>

    <div class="absolute-fixed-dock-hub" id="action-dock-panel">
        <div style="display:flex; gap:12px; margin-bottom:20px;">
            <button class="nav-item" style="flex:1; border:1px solid #333;" onclick="executeBatchSelection(1)">ğŸ² 1 æŠ½</button>
            <button class="nav-item" style="flex:1; border:1px solid #333;" onclick="executeBatchSelection(5)">ğŸ² 5 æŠ½</button>
            <button class="nav-item" style="flex:1; border:1px solid #333;" onclick="executeBatchSelection(10)">ğŸ² 10 æŠ½</button>
        </div>
        
        <div style="display:flex; align-items:center; gap:35px; padding:0 10px;">
            <div style="flex:1; display:flex; flex-direction:column; justify-content:center;">
                <span style="font-size:0.75rem; color:#555; font-weight:900; letter-spacing:1.5px;">SELECTED <span id="dock-sel-count" style="color:#fff;">0</span> æš</span>
                <div id="dock-total-cost" style="font-family:'Oswald'; font-size:2.7rem; font-weight:700; color:var(--gold-primary); margin-top:-8px; line-height:1;">0</div>
            </div>
            <button id="masterPayButton" class="btn-checkout-master" style="flex:2; border:none;" onclick="startFinalCheckoutProcess()" disabled>è«‹å…ˆé¸è™Ÿ</button>
        </div>
    </div>

<script>
    /**
     * [SECTION 16: ç›²ç©æ¨‚ 5.17.2 æ——è‰¦é‚è¼¯å¼•æ“]
     * âš–ï¸ æ†²æ³•ç‰©ç†åŸ·è¡Œï¼šçµ•å°å®ˆè­·åŠŸèƒ½ï¼Œåš´ç¦åˆªæ¸›ã€‚
     */
    const CORE_CONFIG = { 
        API: "https://script.google.com/macros/s/AKfycbzU0-KQm1jMqh2K7oWlkQNEy-PD9gqjBxExLZXH32Q2uuIlRyPhkcM5Gsu8yKPL4pM/exec", 
        LIFF_ID: "2009072982-6smlV2gu" 
    };
    
    let appState = { uid: "guest_id", name: "å†’éšªè€…", mode: "å–®æŒ‘å¥—", tickets: [], unitPrice: 100, userPoints: 0, selectedList: [] };

    /** [1] ç³»çµ±é–‹æ©Ÿåˆå§‹åŒ– */
    async function init() {
        console.log("Flagship Core Re-booting...");
        try { 
            await liff.init({ liffId: CORE_CONFIG.LIFF_ID }); 
            if (liff.isLoggedIn()) {
                const profile = await liff.getProfile(); 
                appState.uid = profile.userId; appState.name = profile.displayName;
                document.getElementById('player-name').innerText = profile.displayName; 
            }
            await fetchSystemData();
        } catch (err) { await fetchSystemData(); }
    }

    /** [2] é é¢åˆ‡æ›æ§åˆ¶ (å¤§å»³ vs å¯¶åº«) */
    async function handlePageSwitch(target) {
        document.getElementById('home-page').style.display = target === 'home' ? 'block' : 'none';
        document.getElementById('vault-page').style.display = target === 'vault' ? 'block' : 'none';
        document.getElementById('action-dock-panel').style.display = target === 'home' ? 'block' : 'none';
        document.getElementById('nav-btn-home').classList.toggle('active', target === 'home');
        document.getElementById('nav-btn-vault').classList.toggle('active', target === 'vault');
        if (target === 'vault') processVaultLogic();
    }

    /** [3] [æ™ºæ…§æ­¸ç´èˆ‡ç‰©ç†æ’åº] */
    async function processVaultLogic() {
        showGlobalLoading(true, "é‡æ§‹è³‡ç”¢æ•¸æ“šåº«...");
        try {
            const res = await fetch(`${CORE_CONFIG.API}?uid=${appState.uid}&action=getMyPrizes&r=${Math.random()}`);
            const data = await res.json();
            
            const groupedMap = {};
            data.prizes.forEach(p => {
                const uniqueKey = `${p.mode}_${p.prizeName}`;
                if (!groupedMap[uniqueKey]) {
                    groupedMap[uniqueKey] = { ...p, count: 0, isPremium: /Aè³|SP|1è³|å¤§ç/i.test(p.prizeName) };
                }
                groupedMap[uniqueKey].count++;
            });

            // å¤§çç‰©ç†æ’åºç½®é ‚
            const sortedArray = Object.values(groupedMap).sort((a, b) => b.isPremium - a.isPremium);

            const listView = document.getElementById('vault-items-container');
            if (sortedArray.length === 0) {
                listView.innerHTML = '<div style="text-align:center; padding:120px 0; color:#444;"><p>æ”¶è—å¯¶åº«ç›®å‰å°šç„¡è³‡ç”¢</p></div>';
            } else {
                listView.innerHTML = sortedArray.map(asset => `
                    <div class="v-asset-card ${asset.isPremium ? 'is-premium' : ''}">
                        <div class="v-asset-icon">${asset.isPremium ? 'ğŸ†' : 'ğŸ'}</div>
                        <div class="v-asset-main">
                            <div class="v-name-header">
                                <span class="v-name-label">${asset.prizeName}</span>
                                <span class="v-qty-stack">x ${asset.count}</span>
                            </div>
                            <div class="v-asset-meta-data">${asset.mode.toUpperCase()} | ç²å¾—æ–¼ ${asset.time}</div>
                        </div>
                        ${asset.status === "å¾…å‡ºè²¨" ? 
                          `<div style="font-size:0.75rem; color:var(--gold-primary); font-weight:900;">ğŸšš è™•ç†ä¸­</div>` : 
                          `<button class="btn-shipment-trigger" onclick="requestShipFlow('${asset.prizeName}', '${asset.mode}', ${asset.count})">ç”³è«‹å‡ºè²¨</button>`
                        }
                    </div>`).join('');
            }
        } finally { showGlobalLoading(false); }
    }

    /** [4] å‡ºè²¨é€£ç·š */
    async function requestShip(p, m, q) {
        const confirm = await Swal.fire({ title: 'ç¢ºèªå‡ºè²¨', text: `${p} x ${q}`, showCancelButton: true, confirmButtonText: 'ç¢ºå®š', background: '#0e0e0e', color: '#fff' });
        if (confirm.isConfirmed) {
            showGlobalLoading(true, "è™•ç†ä¸­...");
            const res = await fetch(CORE_CONFIG.API, { method: 'POST', body: JSON.stringify({ uid: appState.uid, action: 'requestShipment', prizeName: p, mode: m, amount: q }) });
            const data = await res.json();
            if (data.status === "success") { Swal.fire("æˆåŠŸ", "ç®¡ç†å“¡å°‡å„˜é€Ÿè™•ç†", "success"); processVaultLogic(); }
        }
    }

    /** [5] ç›¤é¢æ•¸æ“šåŒæ­¥èˆ‡ F2 å®šåƒ¹ç²å– */
    async function fetchSystemData() {
        showGlobalLoading(true, "å°æ¥æ——è‰¦ä¼ºæœå™¨...");
        try {
            const url = `${CORE_CONFIG.API}?uid=${appState.uid}&name=${encodeURIComponent(appState.name)}&mode=${encodeURIComponent(appState.mode)}&t=${Date.now()}`;
            const res = await fetch(url);
            const data = await res.json();
            if (data.status === "success") {
                appState.tickets = data.tickets; appState.unitPrice = data.cost; appState.userPoints = data.userPoints;
                document.getElementById('player-pts').innerText = appState.userPoints.toLocaleString();
                document.getElementById('stat-rem').innerText = data.tickets.filter(t => !t.isTaken).length;
                document.getElementById('stat-big').innerText = data.tickets.filter(t => !t.isTaken && /Aè³|SP|1è³|å¤§ç/i.test(t.prizeName)).length;
                renderGridUI(); renderShowcase(data.prizeSummary); updateDockUI(); checkRescue();
            }
        } finally { showGlobalLoading(false); }
    }

    function checkRescue() {
        const myLocked = appState.tickets.filter(t => t.isLocked && t.lockUser === appState.uid);
        if (myLocked.length > 0 && appState.selectedList.length === 0) {
            Swal.fire({ title: 'âœ¨ æ¢å¾©ä¿ç•™', text: `æ‚¨æœ‰ ${myLocked.length} æšç±¤ä½é–å®šä¸­ã€‚`, background: '#111', color: '#fff', confirmButtonText: 'ç¹¼çºŒæ”¯ä»˜' })
            .then(r => { if(r.isConfirmed) { appState.selectedList = myLocked.map(t=>String(t.id)); updateDockUI(); startFinalCheckoutProcess(); } });
        }
    }

    function renderGridUI() {
        document.getElementById('main-ticket-grid').innerHTML = appState.tickets.map(t => {
            const isB = /Aè³|SP|1è³|å¤§ç/i.test(t.prizeName);
            let cls = "t-matrix-cell";
            if(t.isTaken) cls += isB ? " is-taken is-big-taken" : " is-taken";
            else if(appState.selectedList.includes(String(t.id))) cls += " is-selected";
            return `<div id="t-${t.id}" class="${cls}" onclick="${t.isTaken ? '' : `toggleCell('${t.id}')`}">${t.isTaken ? '' : t.id}</div>`;
        }).join('');
    }

    function renderShowcase(summary) {
        document.getElementById('lobby-prize-gallery').innerHTML = summary.map(p => `
            <div class="p-show-box ${/Aè³|SP|1è³|å¤§ç/i.test(p.name)?'is-premium':''}" style="flex:0 0 120px; background:var(--bg-card); border-radius:20px; padding:15px; text-align:center; border:1px solid #222;">
                <div class="img-container-moderate" style="height:80px; background:#fff; border-radius:14px;"><img src="${p.img}"></div>
                <div class="p-show-name">${p.name}</div>
                <div class="p-show-rem">å‰© ${p.stock}</div>
            </div>`).join('');
    }

    function toggleCell(tid) {
        const id = String(tid); const idx = appState.selectedList.indexOf(id);
        document.getElementById('snd-master-click').play().catch(()=>{});
        if (idx > -1) { appState.selectedList.splice(idx, 1); document.getElementById(`t-${tid}`).classList.remove('is-selected'); }
        else { appState.selectedList.push(id); document.getElementById(`t-${tid}`).classList.add('is-selected'); }
        updateDockUI();
    }

    function executeBatchSelection(n) {
        appState.selectedList = [];
        const pool = appState.tickets.filter(t => !t.isTaken).map(t => String(t.id));
        for(let i=0; i<n; i++) { if(pool.length === 0) break; appState.selectedList.push(pool.splice(Math.floor(Math.random()*pool.length), 1)[0]); }
        renderGridUI(); updateDockUI();
    }

    function updateDockUI() {
        const total = appState.selectedList.length * appState.unitPrice;
        document.getElementById('dock-sel-count').innerText = appState.selectedList.length;
        document.getElementById('dock-total-cost').innerText = total.toLocaleString();
        const btn = document.getElementById('masterPayButton');
        btn.disabled = appState.selectedList.length === 0;
        btn.innerText = appState.selectedList.length === 0 ? "è«‹å…ˆé¸è™Ÿç¢¼" : "æ”¯ä»˜é»æ•¸é–‹ç±¤";
    }

    async function startFinalCheckoutProcess() {
        const total = appState.selectedList.length * appState.unitPrice;
        if(appState.userPoints < total) { Swal.fire("èƒ½é‡ä¸è¶³", "è«‹è¯ç¹«å®¢æœåŠ è¼‰é»æ•¸", "warning"); return; }
        showGlobalLoading(true, "æ­£åœ¨ç‰©ç†é–å®š...");
        try {
            await fetch(CORE_CONFIG.API, { method: 'POST', body: JSON.stringify({ uid: appState.uid, action: 'lock', mode: appState.mode, ticketIds: appState.selectedList }) });
            showGlobalLoading(false);
            let sec = 180;
            const popup = await Swal.fire({ 
                title: 'âœ¨ å°ˆå±¬ä¿ç•™ä¸­', html: `<div style="font-size:3.5rem; font-family:'Oswald'; color:var(--gold-primary);" id="timer-box">03:00</div><p>æ”¯ä»˜é‡‘é¡ï¼š${total} P</p>`,
                showCancelButton: true, confirmButtonText: 'ç¢ºèª', background: '#0e0e0e', color: '#fff',
                didOpen: () => {
                    timerInterval = setInterval(() => {
                        sec--;
                        const m = Math.floor(sec/60).toString().padStart(2,'0'), s = (sec%60).toString().padStart(2,'0');
                        document.getElementById('timer-box').innerText = `${m}:${s}`;
                        if(sec <= 0) { clearInterval(timerInterval); Swal.close(); fetchSystemData(); }
                    }, 1000);
                }, willClose: () => clearInterval(timerInterval)
            });
            if(popup.isConfirmed) {
                showGlobalLoading(true, "æ‰£æ¬¾é–‹ç±¤ä¸­...");
                const res = await fetch(CORE_CONFIG.API, { method: 'POST', body: JSON.stringify({ uid: appState.uid, action: 'buy', mode: appState.mode, ticketIds: appState.selectedList, name: appState.name }) });
                const data = await res.json();
                if(data.status === "success") {
                    confetti({ particleCount: 2200, spread: 360, startVelocity: 45, colors: ['#D4AF37', '#F7E2A0', '#FFFFFF'] });
                    let listHtml = `<div class="result-matrix-scroller">`;
                    data.results.forEach(r => {
                        const isG = /Aè³|SP|1è³|å¤§ç/i.test(r.name);
                        listHtml += `<div class="res-premium-card ${isG ? 'is-grand-win' : ''}"><div class="res-item-thumb"><img src="${r.img}"></div><div><div style="${isG?'color:var(--gold-primary);':''}; font-weight:900;">${r.name}</div><div style="font-size:0.75rem; color:#555;">ç±¤è™Ÿï¼š${r.id}</div></div></div>`;
                    });
                    listHtml += `</div>`;
                    showGlobalLoader(false);
                    await Swal.fire({ title: "é–‹çå¤§æˆåŠŸ", html: listHtml, background: '#0e0e0e', color: '#fff', confirmButtonText: 'æŸ¥çœ‹è³‡ç”¢åº«', showDenyButton: true, denyButtonText: 'å†ä¾† 5 æŠ½' })
                    .then((res) => { if (res.isDenied) { executeBatchSelection(5); } else { handlePageSwitch('vault'); } });
                    await fetchSystemData();
                }
            } else { fetch(CORE_CONFIG.API, { method: 'POST', body: JSON.stringify({ uid: appState.uid, action: 'release', mode: appState.mode, ticketIds: appState.selectedList }) }).then(() => fetchSystemData()); }
        } catch(e) { showGlobalLoading(false); fetchSystemData(); }
    }

    function showGlobalLoading(show, text) {
        const el = document.getElementById('global-boot-loader');
        el.style.display = show ? 'flex' : 'none';
        if (show) el.querySelector('p').innerText = text;
    }

    function handleModeSwitch(m) { appState.mode = m; fetchSystemData(); }
    window.onload = init;
</script>
</body>
</html>
